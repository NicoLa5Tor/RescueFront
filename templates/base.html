{% set current_route = request.endpoint %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema Multi-Tenant{% endblock %}</title>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = savedTheme === 'dark' || (!savedTheme && systemDark);

            if (isDark) {
                document.documentElement.classList.add('dark');
            }

            document.addEventListener('DOMContentLoaded', () => {
                if (isDark) {
                    document.body.classList.add('dark');
                }
            });

            window.addEventListener('load', () => {
                if (window.gsap) {
                    document.documentElement.classList.add('gsap-enabled');
                }
            });
        })();
        
        // ============ DETECCIÃ“N DE PRELOADER TEMPRANA (COMENTADO) ============
        /* Comentado porque el preloader fue deshabilitado
        (function() {
            function shouldShowPreloaderEarly() {
                try {
                    // 1. Verificar sesiÃ³n
                    const sessionLoaded = sessionStorage.getItem('rescue_app_loaded');
                    if (sessionLoaded) return false;
                    
                    // 2. Verificar tipo de navegaciÃ³n
                    const navigation = performance.getEntriesByType('navigation')[0];
                    if (navigation) {
                        const navType = navigation.type;
                        if (navType === 'reload' || navType === 'back_forward') {
                            return false;
                        }
                    }
                    
                    // 3. Verificar rutas
                    const currentPath = window.location.pathname;
                    const preloaderRoutes = ['/', '/login', '/dashboard', '/admin/dashboard', '/admin/super_admin_dashboard', '/empresa/dashboard'];
                    const shouldShow = preloaderRoutes.some(route => currentPath === route || currentPath.startsWith(route));
                    
                    return shouldShow;
                } catch (error) {
                    return true; // En caso de error, mostrar por seguridad
                }
            }
            
            // Si debe mostrar preloader, aÃ±adir clase al documento
            if (shouldShowPreloaderEarly()) {
                document.documentElement.classList.add('show-preloader');
                console.log('ðŸŽ¬ PRELOADER: Habilitado desde head script');
            } else {
                console.log('âš¡ PRELOADER: Deshabilitado desde head script');
            }
        })();
        */
        
    </script>
    
    <!-- Precarga de imÃ¡genes para optimizaciÃ³n -->
    <link rel="preload" as="image" href="https://e00-elmundo.uecdn.es/assets/multimedia/imagenes/2022/02/23/16456127740623.jpg">
    <link rel="preload" as="image" href="https://www.bomberosbogota.gov.co/sites/default/files/Documentacion/Prensa/Noticias/2022/inundaciones_3-min.jpeg">
    <link rel="preload" as="image" href="https://www.acnur.org/sites/default/files/styles/landscape_10/public/RF1333934.jpg?h=10d202d3&itok=eXU3VXbr">
    <link rel="preload" as="image" href="https://media.diariopopular.com.ar/p/0475e323ddf0bf0817a05f64f8cabaae/adjuntos/143/imagenes/008/017/0008017348/1140x0/smart/robos-hogaresjpg.jpg">
    <link rel="preload" as="image" href="https://s2.abcstatics.com/Media/201007/26/agujeronegro--478x270.jpg">
    <link rel="preload" as="image" href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/68819/waveform-bump3.jpg">
    <link rel="preload" as="image" href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/68819/spikey.png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Main CSS -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/animations.css') }}" rel="stylesheet">
    
    <!-- Sticky Header CSS - Solo en pÃ¡ginas que no sean login -->
    {% if current_route != 'login' %}
    <link href="{{ url_for('static', filename='css/gsap_css/sticky-header.css') }}" rel="stylesheet">
    {% endif %}
    
    {% block extra_css %}{% endblock %}
    
</head>
<body>


    <!-- GSAP ScrollSmoother Wrapper -->
    <div id="gsap-smoother-wrapper">
        <div id="gsap-smoother-content">
            <!-- Sticky Header Global - Solo visible en pÃ¡ginas que no sean login -->
            {% if current_route != 'login' %}
            <header class="sticky-header" id="globalStickyHeader">
            <a id="loginbutton" href="/empresa">
                <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-3.2 -3.2 38.40 38.40" xml:space="preserve" width="77px" height="77px" fill="#ffffff" stroke="#ffffff">
                    <g id="SVGRepo_bgCarrier" stroke-width="0" transform="translate(0,0), scale(1)"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier">
                    <style type="text/css"> .st0{fill:none;stroke:#000000;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;} </style>
                    <path d="M28,25c0.9-1.2,1.6-2.5,2.1-3.9c0-0.1,0.1-0.2,0.1-0.4c0.1-0.2,0.1-0.5,0.2-0.7c0.1-0.2,0.1-0.4,0.2-0.6 c0-0.2,0.1-0.4,0.1-0.6c0.1-0.3,0.1-0.6,0.1-0.8c0-0.2,0-0.3,0.1-0.5c0-0.5,0.1-0.9,0.1-1.4c0-8.3-6.7-15-15-15S1,7.7,1,16 c0,0.5,0,0.9,0.1,1.4c0,0.2,0,0.3,0.1,0.5c0,0.3,0.1,0.6,0.1,0.8c0,0.2,0.1,0.4,0.1,0.6c0,0.2,0.1,0.4,0.2,0.6 c0.1,0.2,0.1,0.5,0.2,0.7c0,0.1,0.1,0.2,0.1,0.4C2.4,22.5,3.1,23.8,4,25v0l0,0c2.7,3.6,7.1,6,12,6S25.2,28.6,28,25L28,25L28,25z M16,29c-4.6,0-8.6-2.4-10.9-6c1.6-2.6,4.1-4.5,7.1-5.4C10.8,16.5,10,14.8,10,13c0-3.3,2.7-6,6-6s6,2.7,6,6c0,1.8-0.8,3.5-2.1,4.6 c2.9,0.9,5.4,2.9,7.1,5.4C24.6,26.6,20.6,29,16,29z"></path>
                    </g>
                </svg>
            </a>
            </header>
            {% endif %}
            
            {% block navbar %}{% endblock %}
            
            <!-- Main Content Area -->
            <main id="main-content">
                {% block content %}{% endblock %}
            </main>
            
            {% block footer %}
            <footer class="bg-black text-white py-4">
                <div class="container text-center">
                    <p class="mb-0">&copy; 2024 Multi-Tenant System. Todos los derechos reservados.</p>
                </div>
            </footer>
            {% endblock %}
        </div>
    </div>

    <!-- Bootstrap JS -->
    
    <!-- GSAP Core + Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollSmoother.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/TextPlugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/DrawSVGPlugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/MotionPathPlugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/CustomEase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollToPlugin.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   

    <!-- API Configuration -->
    <script>
        window.API_BASE_URL = '{{ api_url if api_url else "http://localhost:5000" }}';
        window.CURRENT_USER = '{% if current_user %}{{ current_user | tojson | safe }}{% else %}null{% endif %}';
        {% if session.get('token') %}
        window.INIT_TOKEN = "{{ session.get('token') }}";
        {% endif %}
    </script>
    
    <!-- GSAP Configuration (Global) -->
    <script src="{{ url_for('static', filename='js/gsap-config.js') }}?v={{ cache_version if cache_version else '1.0' }}"></script>
    
    <!-- GSAP Main Controller -->
    <script type="module" src="{{ url_for('static', filename='js/gsap_main.js') }}?v={{ cache_version if cache_version else '1.0' }}"></script>

    <!-- Utils -->
    <script src="{{ url_for('static', filename='js/api-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
    
    <!-- Modal Debug Utility -->
    <script src="{{ url_for('static', filename='js/modal-debug.js') }}"></script>
    
    <!-- Browser Compatibility System -->
    <script src="{{ url_for('static', filename='js/compatibility/compatibility-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/compatibility/chrome-select-fix.js') }}"></script>
    
    <!-- Global Card Visibility Optimizations -->
    <script>
    // ===== SISTEMA GLOBAL DE VISIBILIDAD DE TARJETAS =====
    // Esta funciÃ³n centralizada maneja la visibilidad de todas las tarjetas iOS
    // en todas las vistas de empresa, eliminando la dependencia de GSAP
    
    window.ensureCardsVisibility = function() {
        // Find all iOS cards that might be invisible
        const hardwareCards = document.querySelectorAll('.ios-hardware-card');
        const statCards = document.querySelectorAll('.ios-stat-card');
        const userCards = document.querySelectorAll('.usuario-item');
        const alertCards = document.querySelectorAll('.alert-item, .ios-alert-card');
        
        let totalOptimized = 0;
        
        // Optimize hardware cards
        hardwareCards.forEach(card => {
            if (card.style.opacity === '0' || !card.classList.contains('gsap-animated')) {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transform = 'translateY(0)';
                card.classList.add('gsap-animated', 'optimized');
                
                // Hide shimmer
                const shimmer = card.querySelector('.ios-card-shimmer');
                if (shimmer) shimmer.style.opacity = '0';
                
                totalOptimized++;
            }
        });
        
        // Optimize stat cards
        statCards.forEach(card => {
            if (card.style.opacity === '0' || !card.classList.contains('gsap-animated')) {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transform = 'translateY(0)';
                card.classList.add('gsap-animated', 'optimized');
                
                // Hide shimmer
                const shimmer = card.querySelector('.ios-stat-shimmer');
                if (shimmer) shimmer.style.opacity = '0';
                
                totalOptimized++;
            }
        });
        
        // Optimize user cards
        userCards.forEach(card => {
            if (card.style.opacity === '0' || !card.classList.contains('gsap-animated')) {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transform = 'translateY(0)';
                card.classList.add('gsap-animated', 'optimized');
                
                // Hide shimmer
                const shimmer = card.querySelector('.ios-card-shimmer');
                if (shimmer) shimmer.style.opacity = '0';
                
                totalOptimized++;
            }
        });
        
        // Optimize alert cards
        alertCards.forEach(card => {
            if (card.style.opacity === '0' || !card.classList.contains('gsap-animated')) {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transform = 'translateY(0)';
                card.classList.add('gsap-animated', 'optimized');
                
                // Hide shimmer
                const shimmer = card.querySelector('.ios-card-shimmer');
                if (shimmer) shimmer.style.opacity = '0';
                
                totalOptimized++;
            }
        });
        
        if (totalOptimized > 0) {
            console.log(`ðŸ”§ GLOBAL: Optimized ${totalOptimized} cards for visibility`);
        }
        
        return totalOptimized;
    };
    
    // FunciÃ³n global para aplicar optimizaciones a una tarjeta individual
    window.applyCardOptimizations = function(card) {
        if (!card) return;
        
        // Asegurar que las tarjetas sean siempre visibles
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
        card.style.visibility = 'visible';
        
        // Agregar clase optimized para CSS
        card.classList.add('gsap-animated', 'optimized');
        
        // Configurar shimmer sin animaciones complejas
        const shimmer = card.querySelector('.ios-card-shimmer, .ios-stat-shimmer');
        if (shimmer) {
            shimmer.style.opacity = '0';
        }
        
        console.log('ðŸ”§ GLOBAL: Optimizaciones aplicadas a tarjeta individual');
    };
    
    // FunciÃ³n para aplicar optimizaciones a tarjetas existentes
    window.applyOptimizationsToExistingCards = function() {
        const existingCards = document.querySelectorAll('.ios-hardware-card, .ios-stat-card, .usuario-item, .alert-item, .ios-alert-card');
        existingCards.forEach(card => {
            window.applyCardOptimizations(card);
        });
        console.log(`ðŸ”§ GLOBAL: Optimizaciones aplicadas a ${existingCards.length} tarjetas existentes`);
        return existingCards.length;
    };
    
    // FunciÃ³n mejorada para animar tarjetas de estadÃ­sticas
    window.animateStatCards = function() {
        const statCards = document.querySelectorAll('.ios-stat-card');
        if (window.gsap && statCards.length > 0) {
            // Configurar estado inicial
            window.gsap.set(statCards, { 
                opacity: 0, 
                y: 30,
                scale: 0.95
            });
            
            // Animar entrada con stagger
            window.gsap.to(statCards, {
                opacity: 1,
                y: 0,
                scale: 1,
                duration: 0.6,
                ease: "back.out(1.2)",
                stagger: 0.1
            });
            
            console.log('ðŸŽ¨ GLOBAL GSAP: Animaciones aplicadas a cards de estadÃ­sticas');
        } else {
            // Fallback SIN GSAP: asegurar visibilidad inmediata
            console.log('âš¡ GLOBAL FALLBACK: Aplicando visibilidad directa a cards (sin GSAP)');
            statCards.forEach(card => {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transform = 'translateY(0)';
                card.classList.add('gsap-animated'); // Agregar clase para CSS
            });
        }
    };
    
    // Auto-run visibility check on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initial check
        setTimeout(() => {
            window.ensureCardsVisibility();
        }, 100);
        
        // Apply optimizations to existing cards
        setTimeout(() => {
            window.applyOptimizationsToExistingCards();
        }, 200);
        
        // Animate stat cards if present
        setTimeout(() => {
            window.animateStatCards();
        }, 300);
        
        // Periodic check to catch dynamically loaded cards
        setInterval(() => {
            window.ensureCardsVisibility();
        }, 1000);
        
        console.log('ðŸ”§ GLOBAL: Sistema completo de visibilidad de tarjetas inicializado');
        
    });
    
    </script>
    <script>
// Mejorado sistema de visibilidad del botÃ³n de login
(function() {
    'use strict';
    
    let clampElement, loginButton, tunnelElement;
    let lastVisibilityState = null;
    let isAnimating = false;
    let checkInterval;
    
    // Inicializar cuando el DOM estÃ© listo
    function init() {
        clampElement = document.getElementById('clamp');
        loginButton = document.getElementById('loginbutton');
        tunnelElement = document.getElementById('tunnel');
        
        if (!clampElement || !loginButton) {
            console.warn('Elementos necesarios no encontrados para el botÃ³n de login');
            return;
        }
        
        console.log('âœ… Sistema de visibilidad del botÃ³n de login inicializado');
        
        // Configurar estado inicial
        setupInitialState();
        
        // Configurar eventos
        setupEventListeners();
        
        // Iniciar verificaciÃ³n
        startVisibilityCheck();
    }
    
    function setupInitialState() {
        // Estado inicial oculto
        loginButton.style.opacity = '0';
        loginButton.style.transform = 'scale(0.95)';
        loginButton.style.pointerEvents = 'none';
    }
    
    function setupEventListeners() {
        // Scroll optimizado con throttle
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                checkButtonVisibility();
                scrollTimeout = null;
            }, 16); // ~60fps
        }, { passive: true });
        
        // Resize
        window.addEventListener('resize', checkButtonVisibility, { passive: true });
        
        // Escuchar eventos de GSAP si estÃ¡n disponibles
        document.addEventListener('gsap:clamp:visible', hideButton);
        document.addEventListener('gsap:clamp:hidden', showButton);
        document.addEventListener('gsap:tunnel:start', hideButton);
        document.addEventListener('gsap:tunnel:end', showButton);
    }
    
    function checkButtonVisibility() {
        if (isAnimating) return;
        
        const scrollY = window.scrollY;
        const tunnelRect = tunnelElement ? tunnelElement.getBoundingClientRect() : null;
        
        // El botÃ³n se muestra despuÃ©s de hacer scroll (mÃ¡s de 100px)
        const hasScrolled = scrollY > 100;
        
        // Verificar si el tÃºnel estÃ¡ visible/activo
        const tunnelActive = tunnelRect ? (
            tunnelRect.top < window.innerHeight && 
            tunnelRect.bottom > 0 &&
            tunnelRect.top <= 200 // Margen mÃ¡s generoso para detectar el tÃºnel
        ) : false;
        
        // Detectar si estamos especÃ­ficamente en la secciÃ³n del tÃºnel
        const inTunnelSection = tunnelElement && (
            tunnelElement.classList.contains('active') ||
            tunnelElement.classList.contains('gsap-animating') ||
            (tunnelRect && tunnelRect.top <= 0 && tunnelRect.bottom >= window.innerHeight * 0.5)
        );
        
        // LÃ³gica simple: mostrar si hay scroll, ocultar solo en tÃºnel
        const shouldShow = hasScrolled && !tunnelActive && !inTunnelSection;
        
        // Solo actualizar si el estado cambiÃ³
        if (lastVisibilityState !== shouldShow) {
            lastVisibilityState = shouldShow;
            
            if (shouldShow) {
                showButton();
            } else {
                hideButton();
            }
        }
    }
    
    function showButton() {
        if (loginButton.style.opacity === '1') return;
        
        isAnimating = true;
        
        // AnimaciÃ³n suave de entrada
        loginButton.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
        loginButton.style.opacity = '1';
        loginButton.style.transform = 'scale(1)';
        loginButton.style.pointerEvents = 'auto';
        
        // Agregar clases para mejor apariencia
        loginButton.classList.add('animate-entrance', 'visible', 'active');
        
        setTimeout(() => {
            isAnimating = false;
            loginButton.classList.remove('animate-entrance');
        }, 400);
        
        console.log('ðŸ”µ BotÃ³n de login mostrado (con scroll)');
    }
    
    function hideButton() {
        if (loginButton.style.opacity === '0') return;
        
        isAnimating = true;
        
        // AnimaciÃ³n suave de salida
        loginButton.style.transition = 'all 0.3s ease-out';
        loginButton.style.opacity = '0';
        loginButton.style.transform = 'scale(0.95)';
        loginButton.style.pointerEvents = 'none';
        
        // Remover clases de estado activo
        loginButton.classList.remove('visible', 'active');
        
        setTimeout(() => {
            isAnimating = false;
        }, 300);
        
        console.log('ðŸ”´ BotÃ³n de login ocultado');
    }
    
    function startVisibilityCheck() {
        // VerificaciÃ³n inicial
        setTimeout(checkButtonVisibility, 100);
        
        // VerificaciÃ³n periÃ³dica menos agresiva
        checkInterval = setInterval(checkButtonVisibility, 200);
    }
    
    // API pÃºblica para control manual
    window.LoginButtonController = {
        show: showButton,
        hide: hideButton,
        check: checkButtonVisibility,
        destroy() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
        }
    };
    
    // Inicializar cuando el DOM estÃ© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Cleanup al descargar la pÃ¡gina
    window.addEventListener('beforeunload', () => {
        if (window.LoginButtonController) {
            window.LoginButtonController.destroy();
        }
    });
    
})();
</script>
    {% block extra_js %}{% endblock %}
</body>
</html>