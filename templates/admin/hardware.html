{% extends "admin/dashboard.html" %}

{% block title %}Hardware - Sistema Multi-Tenant{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="{{ url_for('static', filename='css/modals.css') }}" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
  .form-input-readonly {
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    background-color: #f9fafb;
    color: #374151;
    font-size: 0.875rem;
    min-height: 1.5rem;
  }
  
  .dark .form-input-readonly {
    background-color: #374151;
    border-color: #4b5563;
    color: #e5e7eb;
  }
  
  /* Enhanced Toggle Modal Styles */
  .toggle-modal-backdrop {
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.75) !important;
    backdrop-filter: blur(8px);
    z-index: 9999 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 2rem !important;
  }
  
  .toggle-modal-backdrop.hidden {
    display: none !important;
  }
  
  .toggle-modal-container {
    border: 3px solid var(--border-color, #e5e7eb) !important;
    border-radius: 20px;
    padding: 3rem 2.5rem !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4) !important;
    max-width: 450px;
    width: 90%;
    max-height: 80vh !important;
    text-align: center;
    position: relative;
    z-index: 10000 !important;
    transform: translateY(0) !important;
  }
  
  /* Dark mode specific */
  .dark .toggle-modal-container {
    background: var(--bg-secondary, #1f2937) !important;
    border-color: var(--border-color, #374151) !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8) !important;
  }
  
  .toggle-modal-container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: rotate(45deg) translateX(-100%);
    transition: transform 0.6s ease;
    pointer-events: none;
  }
  
  .toggle-modal-container:hover::before {
    transform: rotate(45deg) translateX(100%);
  }
  
  @keyframes shimmer {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
  }
  
  .toggle-modal-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    position: relative;
    z-index: 1;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3) !important;
  }
  
  .toggle-modal-icon.activate {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
  }
  
  .toggle-modal-icon.deactivate {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
  }
  
  .toggle-modal-title {
    font-size: 1.75rem !important;
    font-weight: bold !important;
    color: var(--text-primary, #111827) !important;
    margin-bottom: 1.25rem !important;
    position: relative;
    z-index: 10001 !important;
  }
  
  .dark .toggle-modal-title {
    color: var(--text-primary, #ffffff) !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
  }
  
  .toggle-modal-message {
    color: var(--text-secondary, #374151) !important;
    font-size: 1.1rem !important;
    margin-bottom: 2.5rem !important;
    position: relative;
    z-index: 10001 !important;
    line-height: 1.6 !important;
    padding: 0 1rem !important;
  }
  
  .dark .toggle-modal-message {
    color: var(--text-secondary, #e2e8f0) !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5) !important;
  }
  
  .toggle-modal-buttons {
    display: flex !important;
    gap: 1rem !important;
    justify-content: center !important;
    position: relative;
    z-index: 10001 !important;
  }
  
  .toggle-btn {
    padding: 1rem 2rem !important;
    border: none !important;
    border-radius: 12px !important;
    font-weight: 600 !important;
    font-size: 1rem !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    min-width: 120px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem !important;
  }
  
  .toggle-btn-confirm {
    background: #10b981 !important;
    color: #ffffff !important;
    border: 2px solid #059669 !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
  }
  
  .toggle-btn-confirm:hover {
    background: #059669 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4) !important;
  }
  
  .toggle-btn-cancel {
    background: #6b7280 !important;
    color: #ffffff !important;
    border: 2px solid #4b5563 !important;
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3) !important;
  }
  
  .toggle-btn-cancel:hover {
    background: #4b5563 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4) !important;
  }
  
  /* Fallback styles for modal visibility */
  #toggleHardwareModal {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
  }
  
  #toggleHardwareModal * {
    box-sizing: border-box !important;
  }
  
  #toggleHardwareModal .toggle-modal-container {
    min-height: 300px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
  }
  
  /* Force visibility for debugging */
  .debug-visible {
  
    color: white !important;
    border: 5px solid yellow !important;
    padding: 20px !important;
    z-index: 99999 !important;
  }
  
  /* Client Update Modal Styles (Separate from Toggle Modal) */
  .client-update-backdrop {
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85) !important;
    backdrop-filter: blur(8px);
    z-index: 9998 !important;
    display: flex !important;
    align-items: flex-start !important;
    justify-content: center !important;
    padding-top: 8vh !important;
  }
  
  .client-update-backdrop.hidden {
    display: none !important;
  }
  
  .client-update-container {
    background: #065f46 !important;
    border: 3px solid #10b981 !important;
    border-radius: 20px;
    padding: 2.5rem 2rem 2.5rem 2rem !important;
    box-shadow: 0 25px 50px -12px rgba(16, 185, 129, 0.5) !important;
    max-width: 420px;
    width: 90%;
    max-height: 70vh !important;
    text-align: center;
    position: relative;
    z-index: 9999 !important;
    margin: 1rem auto !important;
    transform: translateY(-20px) !important;
  }
  
  /* Responsive adjustments for client update modal */
  @media (max-height: 600px) {
    .client-update-backdrop {
      padding-top: 5vh !important;
    }
    .client-update-container {
      transform: translateY(-10px) !important;
    }
  }
  
  @media (min-height: 800px) {
    .client-update-backdrop {
      padding-top: 12vh !important;
    }
    .client-update-container {
      transform: translateY(-30px) !important;
    }
  }
  
  .client-update-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    margin: 0 auto 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    position: relative;
    z-index: 1;
    background: linear-gradient(135deg, #10b981, #059669) !important;
    color: white !important;
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4) !important;
  }
  
  .client-update-title {
    font-size: 1.6rem !important;
    font-weight: bold !important;
    color: #ffffff !important;
    margin-bottom: 1rem !important;
    position: relative;
    z-index: 10001 !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
  }
  
  .client-update-message {
    color: #d1fae5 !important;
    font-size: 1rem !important;
    margin-bottom: 2rem !important;
    position: relative;
    z-index: 10001 !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5) !important;
    line-height: 1.5 !important;
    padding: 0 0.5rem !important;
  }
  
  .client-update-button {
    padding: 1rem 2rem !important;
    border: none !important;
    border-radius: 12px !important;
    font-weight: 600 !important;
    font-size: 1rem !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    min-width: 120px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem !important;
    color: #065f46 !important;
    border: 2px solid #10b981 !important;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3) !important;
    margin: 0 auto !important;
  }
  
  .client-update-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.4) !important;
  }

  /* ===== ENHANCED iOS DESIGN SYSTEM ===== */
  
  /* iOS Header Styles */
  .ios-header-container {
    position: relative;
    overflow: hidden;
  }
  
  .ios-header-backdrop {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.15) 0%, 
      rgba(147, 51, 234, 0.15) 50%,
      rgba(236, 72, 153, 0.15) 100%) !important;
    backdrop-filter: blur(20px) saturate(1.8) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.8) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 20px !important;
    padding: 1.5rem !important;
    position: relative;
    overflow: hidden;
    box-shadow: 
      0 15px 30px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
  }
  
  .dark .ios-header-backdrop {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.08) 0%, 
      rgba(147, 51, 234, 0.08) 50%,
      rgba(236, 72, 153, 0.08) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
      0 20px 40px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
  }
  
  .ios-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 2;
  }
  
  .ios-header-text {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }
  
  .ios-header-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.8) 0%, 
      rgba(147, 51, 234, 0.8) 100%) !important;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
    box-shadow: 
      0 10px 25px rgba(59, 130, 246, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
    position: relative;
    overflow: hidden;
  }
  
  .ios-header-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent 30%, 
      rgba(255, 255, 255, 0.2) 50%, 
      transparent 70%);
    transform: rotate(45deg);
    animation: iconShimmer 3s ease-in-out infinite;
  }
  
  .ios-header-title {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.95) 0%, 
      rgba(255, 255, 255, 0.8) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .dark .ios-header-title {
    background: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.95) 0%, 
      rgba(255, 255, 255, 0.7) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .ios-header-subtitle {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.8);
    margin: 0.5rem 0 0 0;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
  
  .ios-header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  /* iOS Action Buttons */
  .ios-action-btn {
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(12px) saturate(1.3) !important;
    -webkit-backdrop-filter: blur(12px) saturate(1.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.25) !important;
    border-radius: 16px !important;
    padding: 1rem 1.5rem !important;
    font-weight: 600 !important;
    font-size: 0.95rem !important;
    color: rgba(255, 255, 255, 0.9) !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) !important;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-width: 120px;
  }
  
  .ios-action-btn-primary {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.7) 0%, 
      rgba(147, 51, 234, 0.7) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    box-shadow: 
      0 8px 25px rgba(59, 130, 246, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
  }
  
  .ios-action-btn:hover {
    transform: translateY(-2px) scale(1.02) !important;
    box-shadow: 
      0 12px 35px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
  }
  
  .ios-action-btn-primary:hover {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.9) 0%, 
      rgba(147, 51, 234, 0.9) 100%) !important;
    box-shadow: 
      0 15px 40px rgba(59, 130, 246, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
  }
  
  /* iOS Stats Grid */
  .ios-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .ios-stat-card {
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    border-radius: 12px !important;
    padding: 1rem !important;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
    cursor: pointer;
    box-shadow: 
      0 8px 25px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  
  .dark .ios-stat-card {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
      0 10px 30px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
  
  .ios-stat-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 
      0 20px 50px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
  
  .ios-stat-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
    margin-bottom: 0.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
  }
  
  .ios-stat-icon-blue {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
  }
  
  .ios-stat-icon-green {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
  }
  
  .ios-stat-icon-red {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
  }
  
  .ios-stat-icon-purple {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
  }
  
  .ios-stat-content {
    flex: 1;
  }
  
  .ios-stat-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .ios-stat-value {
    font-size: 1.4rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 0.25rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .ios-stat-trend {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
  }
  
  .ios-stat-shimmer {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent 30%, 
      rgba(255, 255, 255, 0.08) 50%, 
      transparent 70%);
    transform: rotate(45deg) translateX(-100%);
    transition: transform 0.8s ease;
    pointer-events: none;
    opacity: 0;
  }
  
  .ios-stat-card:hover .ios-stat-shimmer {
    opacity: 1;
    transform: rotate(45deg) translateX(100%);
  }
  
  @keyframes iconShimmer {
    0%, 100% { transform: translateX(-100%) rotate(45deg); }
    50% { transform: translateX(100%) rotate(45deg); }
  }
  
  @keyframes statShimmer {
    0%, 100% { transform: translateX(-100%) rotate(45deg); opacity: 0; }
    50% { transform: translateX(100%) rotate(45deg); opacity: 1; }
  }
  
  /* iOS Filters Styles */
  .ios-filters-container {
    position: relative;
    overflow: hidden;
  }
  
  .ios-blur-bg {
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    border-radius: 20px !important;
    padding: 1.5rem !important;
    box-shadow: 
      0 10px 30px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  
  .dark .ios-blur-bg {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
      0 10px 30px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
  
  .ios-filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    align-items: end;
  }
  
  .ios-filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .ios-filter-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .ios-filter-input {
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 10px !important;
    padding: 0.75rem 0.875rem !important;
    color: rgba(255, 255, 255, 0.9) !important;
    font-size: 0.85rem !important;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) !important;
    width: 100%;
  }
  
  .ios-filter-input::placeholder {
    color: rgba(255, 255, 255, 0.5) !important;
  }
  
  .ios-filter-input:focus {
    outline: none !important;
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    box-shadow: 
      0 0 0 3px rgba(59, 130, 246, 0.2),
      0 8px 25px rgba(0, 0, 0, 0.1) !important;
    transform: translateY(-1px) !important;
  }
  
  .dark .ios-filter-input {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
  }
  
  .dark .ios-filter-input:focus {
    background: rgba(255, 255, 255, 0.08) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
  }
  
  /* Override conflicting styles */
  .ios-hardware-card.hardware-item {
    /* Reset all conflicting styles */
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    border-radius: 18px !important;
    padding: 1.25rem !important;
    transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) !important;
    transform: none !important;
    margin: 0 !important;
    display: block !important;
    position: relative !important;
    overflow: hidden !important;
  }
  
  /* iOS Hardware Cards */
  .ios-hardware-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.25rem;
  }
  
  /* Ensure dynamic cards display properly */
  .ios-hardware-grid .hardware-item {
    display: block !important;
  }
  
  .ios-hardware-grid .hardware-item.hidden {
    display: none !important;
  }
  
  .ios-hardware-card {
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    border-radius: 18px !important;
    padding: 1.25rem !important;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
    cursor: pointer;
    box-shadow: 
      0 8px 25px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  
  .dark .ios-hardware-card,
  .dark .ios-hardware-card.hardware-item {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
      0 8px 25px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
  }
  
  .ios-hardware-card:hover,
  .ios-hardware-card.hardware-item:hover {
    transform: translateY(-8px) scale(1.02) !important;
    box-shadow: 
      0 25px 60px rgba(0, 0, 0, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
  }
  
  .ios-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .ios-card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.8) 0%, 
      rgba(147, 51, 234, 0.8) 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
    box-shadow: 
      0 6px 15px rgba(59, 130, 246, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
    position: relative;
    overflow: hidden;
  }
  
  .ios-card-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent 30%, 
      rgba(255, 255, 255, 0.2) 50%, 
      transparent 70%);
    transform: rotate(45deg) translateX(-100%);
    transition: transform 0.6s ease;
    pointer-events: none;
    opacity: 0;
  }
  
  .ios-card-icon:hover::before {
    opacity: 1;
    transform: rotate(45deg) translateX(100%);
  }
  
  .ios-status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .ios-status-available {
    background: rgba(16, 185, 129, 0.2);
    color: rgba(16, 185, 129, 1);
    border-color: rgba(16, 185, 129, 0.3);
  }
  
  .ios-status-stock {
    background: rgba(239, 68, 68, 0.2);
    color: rgba(239, 68, 68, 1);
    border-color: rgba(239, 68, 68, 0.3);
  }
  
  .ios-status-discontinued {
    background: rgba(107, 114, 128, 0.2);
    color: rgba(107, 114, 128, 1);
    border-color: rgba(107, 114, 128, 0.3);
  }
  
  .ios-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 0.375rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .ios-card-subtitle {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.75rem;
    font-weight: 500;
  }
  
  .ios-card-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .ios-info-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
  }
  
  .ios-info-label {
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
  }
  
  .ios-info-value {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
  }
  
  .ios-card-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .ios-card-btn {
    flex: 1;
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 10px !important;
    padding: 0.625rem !important;
    font-weight: 600 !important;
    font-size: 0.8rem !important;
    color: rgba(255, 255, 255, 0.9) !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) !important;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
  }
  
  .ios-card-btn:hover {
    transform: translateY(-2px) !important;
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    box-shadow: 
      0 8px 20px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
  }
  
  .ios-card-btn-primary {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.6) 0%, 
      rgba(147, 51, 234, 0.6) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    box-shadow: 
      0 6px 15px rgba(59, 130, 246, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
  }
  
  .ios-card-btn-primary:hover {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.8) 0%, 
      rgba(147, 51, 234, 0.8) 100%) !important;
    box-shadow: 
      0 10px 25px rgba(59, 130, 246, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
  }
  
  .ios-card-btn-warning {
    background: linear-gradient(135deg, 
      rgba(245, 158, 11, 0.6) 0%, 
      rgba(217, 119, 6, 0.6) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    box-shadow: 
      0 6px 15px rgba(245, 158, 11, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
  }
  
  .ios-card-btn-success {
    background: linear-gradient(135deg, 
      rgba(16, 185, 129, 0.6) 0%, 
      rgba(5, 150, 105, 0.6) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    box-shadow: 
      0 6px 15px rgba(16, 185, 129, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
  }
  
  .ios-card-shimmer {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent 30%, 
      rgba(255, 255, 255, 0.06) 50%, 
      transparent 70%);
    transform: rotate(45deg);
    animation: cardShimmer 5s ease-in-out infinite;
    pointer-events: none;
    opacity: 0;
  }
  
  .ios-hardware-card:hover .ios-card-shimmer {
    opacity: 1;
  }
  
  @keyframes cardIconShimmer {
    0%, 100% { transform: translateX(-100%) rotate(45deg); }
    50% { transform: translateX(100%) rotate(45deg); }
  }
  
  @keyframes cardShimmer {
    0%, 100% { transform: translateX(-100%) rotate(45deg); opacity: 0; }
    50% { transform: translateX(100%) rotate(45deg); opacity: 1; }
  }
  
  /* ===== LIGHT THEME STYLES ===== */
  
  /* Light theme header styles */
  :root:not(.dark) .ios-header-backdrop {
    background: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.95) 0%, 
      rgba(248, 250, 252, 0.9) 50%,
      rgba(241, 245, 249, 0.95) 100%) !important;
    backdrop-filter: blur(20px) saturate(1.8) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.8) !important;
    border: 2px solid rgba(59, 130, 246, 0.2) !important;
    box-shadow: 
      0 20px 40px rgba(59, 130, 246, 0.12),
      0 8px 16px rgba(147, 51, 234, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
    position: relative;
    overflow: hidden;
  }
  
  /* Light theme header decorative elements - hover only */
  :root:not(.dark) .ios-header-backdrop::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg at 50% 50%, 
      rgba(59, 130, 246, 0.03) 0deg,
      rgba(147, 51, 234, 0.05) 90deg,
      rgba(236, 72, 153, 0.03) 180deg,
      rgba(59, 130, 246, 0.02) 270deg,
      rgba(59, 130, 246, 0.03) 360deg);
    transform: rotate(0deg);
    transition: transform 3s ease;
    pointer-events: none;
    opacity: 0.5;
  }
  
  :root:not(.dark) .ios-header-backdrop:hover::before {
    transform: rotate(360deg);
    opacity: 1;
  }
  
  :root:not(.dark) .ios-header-backdrop::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
      45deg,
      transparent 0px,
      rgba(59, 130, 246, 0.02) 1px,
      transparent 2px,
      transparent 20px
    );
    pointer-events: none;
  }
  
  @keyframes lightRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Light theme header content */
  :root:not(.dark) .ios-header-content {
    position: relative;
    z-index: 10;
  }
  
  :root:not(.dark) .ios-header-icon {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.9) 0%, 
      rgba(147, 51, 234, 0.9) 50%,
      rgba(236, 72, 153, 0.9) 100%) !important;
    border: 2px solid rgba(255, 255, 255, 0.8) !important;
    box-shadow: 
      0 15px 35px rgba(59, 130, 246, 0.3),
      0 5px 15px rgba(147, 51, 234, 0.2),
      inset 0 2px 4px rgba(255, 255, 255, 0.3) !important;
    position: relative;
    overflow: hidden;
  }
  
  :root:not(.dark) .ios-header-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent 30%, 
      rgba(255, 255, 255, 0.4) 50%, 
      transparent 70%);
    transform: rotate(45deg) translateX(-100%);
    transition: transform 0.6s ease;
    pointer-events: none;
    opacity: 0;
  }
  
  :root:not(.dark) .ios-header-icon:hover::before {
    opacity: 1;
    transform: rotate(45deg) translateX(100%);
  }
  
  @keyframes lightIconShimmer {
    0%, 100% { transform: translateX(-100%) rotate(45deg); }
    50% { transform: translateX(100%) rotate(45deg); }
  }
  
  :root:not(.dark) .ios-header-title {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 1) 0%, 
      rgba(147, 51, 234, 0.9) 50%,
      rgba(236, 72, 153, 1) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    font-weight: 800;
  }
  
  :root:not(.dark) .ios-header-title::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, 
      rgba(59, 130, 246, 0.6) 0%, 
      rgba(147, 51, 234, 0.4) 50%,
      rgba(236, 72, 153, 0.6) 100%);
    border-radius: 2px;
    opacity: 0.6;
    transform: scaleX(0.8);
    transition: all 0.3s ease;
  }
  
  :root:not(.dark) .ios-header-title:hover::after {
    opacity: 1;
    transform: scaleX(1);
  }
  
  @keyframes lightTitleGlow {
    0% { opacity: 0.6; transform: scaleX(0.8); }
    100% { opacity: 1; transform: scaleX(1); }
  }
  
  :root:not(.dark) .ios-header-subtitle {
    color: rgba(59, 130, 246, 0.8);
    text-shadow: none;
    font-weight: 600;
    position: relative;
  }
  
  :root:not(.dark) .ios-header-subtitle::before {
    content: '✨';
    margin-right: 8px;
    transform: rotate(0deg) scale(1);
    transition: transform 0.3s ease;
    display: inline-block;
  }
  
  :root:not(.dark) .ios-header-subtitle:hover::before {
    transform: rotate(180deg) scale(1.1);
  }
  
  @keyframes lightSparkle {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
  }
  
  /* Light theme header corner decorations - hover only */
  :root:not(.dark) .ios-header-container::before {
    content: '';
    position: absolute;
    top: 10px;
    right: 10px;
    width: 60px;
    height: 60px;
    background: radial-gradient(circle, 
      rgba(59, 130, 246, 0.1) 0%, 
      rgba(147, 51, 234, 0.05) 50%, 
      transparent 100%);
    border-radius: 50%;
    transform: translateY(0px) scale(1);
    opacity: 0.7;
    transition: all 0.6s ease;
    pointer-events: none;
  }
  
  :root:not(.dark) .ios-header-container:hover::before {
    transform: translateY(-10px) scale(1.1);
    opacity: 1;
  }
  
  :root:not(.dark) .ios-header-container::after {
    content: '';
    position: absolute;
    bottom: 15px;
    left: 15px;
    width: 40px;
    height: 40px;
    background: radial-gradient(circle, 
      rgba(236, 72, 153, 0.08) 0%, 
      rgba(59, 130, 246, 0.04) 50%, 
      transparent 100%);
    border-radius: 50%;
    transform: translateY(0px) scale(1);
    opacity: 0.7;
    transition: all 0.8s ease;
    pointer-events: none;
  }
  
  :root:not(.dark) .ios-header-container:hover::after {
    transform: translateY(-8px) scale(1.1);
    opacity: 1;
  }
  
  @keyframes lightFloat {
    0%, 100% { transform: translateY(0px) scale(1); opacity: 0.7; }
    50% { transform: translateY(-10px) scale(1.1); opacity: 1; }
  }
  
  /* Light theme header text container extra styling - hover only */
  :root:not(.dark) .ios-header-text {
    position: relative;
  }
  
  :root:not(.dark) .ios-header-text::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    background: linear-gradient(45deg, 
      rgba(59, 130, 246, 0.02) 0%, 
      transparent 50%, 
      rgba(147, 51, 234, 0.02) 100%);
    border-radius: 20px;
    z-index: -1;
    opacity: 0.5;
    transform: scale(0.98);
    transition: all 0.3s ease;
  }
  
  :root:not(.dark) .ios-header-text:hover::before {
    opacity: 1;
    transform: scale(1.02);
  }
  
  @keyframes lightTextGlow {
    0% { opacity: 0.5; transform: scale(0.98); }
    100% { opacity: 1; transform: scale(1.02); }
  }
  
  /* Light theme stats cards */
  :root:not(.dark) .ios-stat-card {
    background: rgba(255, 255, 255, 0.9) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    box-shadow: 
      0 8px 25px rgba(59, 130, 246, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
  }
  
  :root:not(.dark) .ios-stat-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 
      0 20px 50px rgba(59, 130, 246, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
  }
  
  :root:not(.dark) .ios-stat-label {
    color: rgba(59, 130, 246, 0.8);
  }
  
  :root:not(.dark) .ios-stat-value {
    color: rgba(30, 41, 59, 0.95);
    text-shadow: none;
  }
  
  :root:not(.dark) .ios-stat-trend {
    color: rgba(100, 116, 139, 0.8);
  }
  
  /* Light theme filters */
  :root:not(.dark) .ios-blur-bg {
    background: rgba(255, 255, 255, 0.9) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    box-shadow: 
      0 10px 30px rgba(59, 130, 246, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }
  
  :root:not(.dark) .ios-filter-label {
    color: rgba(59, 130, 246, 0.8);
  }
  
  :root:not(.dark) .ios-filter-input {
    background: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(59, 130, 246, 0.3) !important;
    color: rgba(30, 41, 59, 0.9) !important;
  }
  
  :root:not(.dark) .ios-filter-input::placeholder {
    color: rgba(100, 116, 139, 0.6) !important;
  }
  
  :root:not(.dark) .ios-filter-input:focus {
    background: rgba(255, 255, 255, 0.95) !important;
    border: 1px solid rgba(59, 130, 246, 0.6) !important;
    box-shadow: 
      0 0 0 3px rgba(59, 130, 246, 0.2),
      0 8px 25px rgba(59, 130, 246, 0.15) !important;
  }
  
  /* Light theme hardware cards */
  :root:not(.dark) .ios-hardware-card,
  :root:not(.dark) .ios-hardware-card.hardware-item {
    background: rgba(255, 255, 255, 0.9) !important;
    backdrop-filter: blur(20px) saturate(1.5) !important;
    -webkit-backdrop-filter: blur(20px) saturate(1.5) !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1), 
               inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
  }
  
  :root:not(.dark) .ios-hardware-card:hover,
  :root:not(.dark) .ios-hardware-card.hardware-item:hover {
    transform: translateY(-8px) scale(1.02) !important;
    box-shadow: 
      0 25px 60px rgba(59, 130, 246, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
  }
  
  :root:not(.dark) .ios-card-title {
    color: rgba(30, 41, 59, 0.95);
    text-shadow: none;
  }
  
  :root:not(.dark) .ios-card-subtitle {
    color: rgba(100, 116, 139, 0.8);
  }
  
  :root:not(.dark) .ios-info-label {
    color: rgba(100, 116, 139, 0.7);
  }
  
  :root:not(.dark) .ios-info-value {
    color: rgba(30, 41, 59, 0.9);
  }
  
  /* Light theme action buttons */
  :root:not(.dark) .ios-action-btn {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(12px) saturate(1.3) !important;
    -webkit-backdrop-filter: blur(12px) saturate(1.3) !important;
    border: 2px solid rgba(59, 130, 246, 0.3) !important;
    color: rgba(59, 130, 246, 0.9) !important;
    text-shadow: none !important;
    position: relative;
    overflow: hidden;
  }
  
  :root:not(.dark) .ios-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(59, 130, 246, 0.1) 50%, 
      transparent 100%);
    transition: left 0.5s ease;
  }
  
  :root:not(.dark) .ios-action-btn:hover::before {
    left: 100%;
  }
  
  :root:not(.dark) .ios-action-btn:hover {
    background: rgba(255, 255, 255, 1) !important;
    border: 2px solid rgba(59, 130, 246, 0.6) !important;
    color: rgba(59, 130, 246, 1) !important;
    box-shadow: 
      0 15px 40px rgba(59, 130, 246, 0.25),
      0 5px 15px rgba(147, 51, 234, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 1) !important;
    transform: translateY(-3px) scale(1.02) !important;
  }
  
  :root:not(.dark) .ios-action-btn-primary {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 0.9) 0%, 
      rgba(147, 51, 234, 0.8) 50%,
      rgba(236, 72, 153, 0.9) 100%) !important;
    border: 2px solid rgba(255, 255, 255, 0.4) !important;
    color: rgba(255, 255, 255, 0.95) !important;
    box-shadow: 
      0 10px 30px rgba(59, 130, 246, 0.3),
      0 4px 12px rgba(147, 51, 234, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
  }
  
  :root:not(.dark) .ios-action-btn-primary:hover {
    background: linear-gradient(135deg, 
      rgba(59, 130, 246, 1) 0%, 
      rgba(147, 51, 234, 0.9) 50%,
      rgba(236, 72, 153, 1) 100%) !important;
    border: 2px solid rgba(255, 255, 255, 0.6) !important;
    color: rgba(255, 255, 255, 1) !important;
    box-shadow: 
      0 18px 45px rgba(59, 130, 246, 0.4),
      0 8px 20px rgba(147, 51, 234, 0.3),
      inset 0 2px 4px rgba(255, 255, 255, 0.5) !important;
    transform: translateY(-4px) scale(1.05) !important;
  }
  
  /* Light theme card buttons */
  :root:not(.dark) .ios-card-btn {
    background: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    border: 1px solid rgba(59, 130, 246, 0.3) !important;
    color: rgba(59, 130, 246, 0.9) !important;
    text-shadow: none !important;
  }
  
  :root:not(.dark) .ios-card-btn:hover {
    background: rgba(255, 255, 255, 0.95) !important;
    border: 1px solid rgba(59, 130, 246, 0.5) !important;
    box-shadow: 
      0 8px 20px rgba(59, 130, 246, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.9) !important;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .ios-header-content {
      flex-direction: column;
      gap: 1.5rem;
      text-align: center;
    }
    
    .ios-header-text {
      flex-direction: column;
      gap: 1rem;
    }
    
    .ios-header-title {
      font-size: 2rem;
    }
    
    .ios-header-actions {
      flex-direction: column;
      width: 100%;
    }
    
    .ios-action-btn {
      width: 100%;
      justify-content: center;
    }
    
    .ios-stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .ios-filters-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .ios-hardware-grid {
      grid-template-columns: 1fr;
    }
  }
  
  /* ===== PERFORMANCE OPTIMIZATIONS APLICADAS ===== */
  
  /* DESHABILITAR TODAS LAS ANIMACIONES INFINITAS */
  .ios-card-shimmer,
  .ios-stat-shimmer,
  .ios-card-icon::before,
  .toggle-modal-container::before {
    /* NO más animaciones infinitas */
    animation: none !important;
    /* Solo transitions para hover */
    transition: transform 0.6s ease-out, opacity 0.3s ease;
    /* Estado inicial oculto */
    opacity: 0;
    transform: rotate(45deg) translateX(-100%);
    pointer-events: none;
  }
  
  /* GPU acceleration solo cuando sea necesario */
  .ios-hardware-card:hover .ios-card-shimmer,
  .ios-stat-card:hover .ios-stat-shimmer,
  .ios-card-icon:hover::before,
  .toggle-modal-container:hover::before {
    will-change: transform;
    transform: translateZ(0);
  }
  
  /* Remover will-change cuando no hay hover para liberar memoria */
  .ios-hardware-card:not(:hover) .ios-card-shimmer,
  .ios-stat-card:not(:hover) .ios-stat-shimmer {
    will-change: auto;
  }
  
  /* Optimizaciones para dispositivos móviles */
  @media (max-width: 768px) {
    /* Deshabilitar efectos pesados en móvil */
    .ios-card-shimmer,
    .ios-stat-shimmer,
    .ios-card-icon::before {
      display: none !important;
    }
    
    /* Reducir transforms en hover para móvil */
    .ios-hardware-card:hover,
    .ios-stat-card:hover {
      transform: translateY(-2px) scale(1.01) !important;
    }
  }
  
  /* Respetar preferencias de accesibilidad */
  @media (prefers-reduced-motion: reduce) {
    /* Deshabilitar todas las animaciones shimmer */
    .ios-card-shimmer,
    .ios-stat-shimmer,
    .ios-card-icon::before,
    .toggle-modal-container::before {
      display: none !important;
    }
    
    /* Reducir todas las transiciones */
    * {
      transition-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
    }
  }
  
  /* Optimización para conexiones lentas */
  @media (prefers-reduced-data: reduce) {
    .ios-card-shimmer,
    .ios-stat-shimmer {
      display: none !important;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Performance optimizer específico para hardware -->
<script>
  // Función GLOBAL para aplicar optimizaciones a una tarjeta específica
  function applyCardOptimizations(card) {
    const shimmer = card.querySelector('.ios-card-shimmer');
    const cardIcon = card.querySelector('.ios-card-icon');
    
    if (shimmer) {
      // Asegurar que el shimmer esté inicialmente oculto
      shimmer.style.opacity = '0';
      shimmer.style.transform = 'rotate(45deg) translateX(-100%)';
      shimmer.style.transition = 'transform 0.6s ease-out, opacity 0.3s ease';
      shimmer.style.pointerEvents = 'none';
      
      // Solo activar en hover
      card.addEventListener('mouseenter', () => {
        if (!document.body.classList.contains('low-end-device') && 
            !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          shimmer.style.opacity = '1';
          shimmer.style.transform = 'rotate(45deg) translateX(100%)';
        }
      });
      
      card.addEventListener('mouseleave', () => {
        shimmer.style.opacity = '0';
        shimmer.style.transform = 'rotate(45deg) translateX(-100%)';
      });
    }
    
    // Optimizar el ícono también
    if (cardIcon) {
      // El ::before ya está optimizado en CSS, pero aseguramos que respete hover
      cardIcon.style.position = 'relative';
      cardIcon.style.overflow = 'hidden';
    }
    
    console.log('🔧 Optimizaciones aplicadas a tarjeta individual');
  }
  
  // Función para aplicar optimizaciones a tarjetas ya existentes
  function applyOptimizationsToExistingCards() {
    const existingCards = document.querySelectorAll('.ios-hardware-card');
    existingCards.forEach(card => {
      applyCardOptimizations(card);
    });
    console.log(`🔧 Optimizaciones aplicadas a ${existingCards.length} tarjetas existentes`);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🛠️ Hardware page loaded with optimizations');
    
    // Aplicar optimizaciones adicionales para las tarjetas de hardware
    const hardwareCards = document.querySelectorAll('.ios-hardware-card');
    const statCards = document.querySelectorAll('.ios-stat-card');
    
    // Optimización: Pausar shimmer hasta hover para stats cards
    const pauseShimmerUntilHover = (cards) => {
      cards.forEach(card => {
        const shimmer = card.querySelector('.ios-stat-shimmer');
        if (shimmer) {
          // Inicialmente invisible
          shimmer.style.opacity = '0';
          shimmer.style.transform = 'rotate(45deg) translateX(-100%)';
          shimmer.style.transition = 'transform 0.8s ease, opacity 0.3s ease';
          
          card.addEventListener('mouseenter', () => {
            if (!document.body.classList.contains('low-end-device')) {
              shimmer.style.opacity = '1';
              shimmer.style.transform = 'rotate(45deg) translateX(100%)';
            }
          });
          
          card.addEventListener('mouseleave', () => {
            shimmer.style.opacity = '0';
            shimmer.style.transform = 'rotate(45deg) translateX(-100%)';
          });
        }
      });
    };
    
    // Aplicar a stats cards
    pauseShimmerUntilHover(statCards);
    
    // Detectar dispositivos de bajo rendimiento y deshabilitar efectos
    const isLowEndDevice = (
      navigator.hardwareConcurrency <= 2 ||
      navigator.deviceMemory <= 2 ||
      window.innerWidth <= 768
    );
    
    if (isLowEndDevice) {
      console.log('📱 Low-end device detected - disabling heavy animations');
      document.body.classList.add('low-end-device');
      
      // Deshabilitar todos los shimmers en dispositivos de bajo rendimiento
      const allShimmers = document.querySelectorAll('.ios-card-shimmer, .ios-stat-shimmer');
      allShimmers.forEach(shimmer => {
        shimmer.style.display = 'none';
      });
    }
    
    // Aplicar optimizaciones a tarjetas existentes
    applyOptimizationsToExistingCards();
    
    // Observer para tarjetas que se añaden dinámicamente
    const hardwareGrid = document.getElementById('hardwareGrid');
    if (hardwareGrid) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.classList.contains('ios-hardware-card')) {
              console.log('👀 Nueva tarjeta detectada, aplicando optimizaciones...');
              applyCardOptimizations(node);
            }
          });
        });
      });
      
      observer.observe(hardwareGrid, {
        childList: true,
        subtree: true
      });
      
      console.log('👀 Observer configurado para detectar nuevas tarjetas');
    }
    
    console.log('✅ Hardware page optimizations applied successfully');
  });
</script>
{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Enhanced iOS Header -->
  <div class="ios-header-container mb-8">
    <div class="ios-header-backdrop">
      <div class="ios-header-content">
        <div class="ios-header-text">
          <div class="ios-header-icon">
            <i class="fas fa-microchip"></i>
          </div>
          <div>
            <h1 class="ios-header-title">Gestión de Hardware</h1>
            <p class="ios-header-subtitle">Administra tu inventario con tecnología de vanguardia</p>
          </div>
        </div>
        <div class="ios-header-actions">
          <button class="ios-action-btn ios-action-btn-primary" onclick="openCreateModal()">
            <i class="fas fa-plus"></i>
            <span>Nuevo Hardware</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced iOS Stats Cards -->
  <div class="ios-stats-grid">
    <div class="ios-stat-card" data-stat="total">
      <div class="ios-stat-icon ios-stat-icon-blue">
        <i class="fas fa-microchip"></i>
      </div>
      <div class="ios-stat-content">
        <div class="ios-stat-label">Total Items</div>
        <div class="ios-stat-value" id="totalItemsCount">{{ hardware_data.hardware_stats.total_items }}</div>
        <div class="ios-stat-trend">+2.5% vs mes anterior</div>
      </div>
      <div class="ios-stat-shimmer"></div>
    </div>
    
    <div class="ios-stat-card" data-stat="available">
      <div class="ios-stat-icon ios-stat-icon-green">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="ios-stat-content">
        <div class="ios-stat-label">Disponibles</div>
        <div class="ios-stat-value" id="availableItemsCount">{{ hardware_data.hardware_stats.available_items }}</div>
        <div class="ios-stat-trend">Inventario óptimo</div>
      </div>
      <div class="ios-stat-shimmer"></div>
    </div>
    
    <div class="ios-stat-card" data-stat="stock">
      <div class="ios-stat-icon ios-stat-icon-red">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="ios-stat-content">
        <div class="ios-stat-label">Sin Stock</div>
        <div class="ios-stat-value" id="outOfStockCount">{{ hardware_data.hardware_stats.out_of_stock }}</div>
        <div class="ios-stat-trend">Reabastecimiento needed</div>
      </div>
      <div class="ios-stat-shimmer"></div>
    </div>
    
    <div class="ios-stat-card" data-stat="value">
      <div class="ios-stat-icon ios-stat-icon-purple">
        <i class="fas fa-dollar-sign"></i>
      </div>
      <div class="ios-stat-content">
        <div class="ios-stat-label">Valor Total</div>
        <div class="ios-stat-value" id="totalValueCount">{{ hardware_data.hardware_stats.total_value | currency }}</div>
        <div class="ios-stat-trend">Activos valorados</div>
      </div>
      <div class="ios-stat-shimmer"></div>
    </div>
  </div>

  <!-- iOS Style Filters -->
  <div class="ios-filters-container ios-blur-bg mb-8">
    <div class="ios-filters-grid">
      <div class="ios-filter-item">
        <label class="ios-filter-label">Buscar</label>
        <input type="text" id="searchInput" placeholder="Buscar hardware..." 
               class="ios-filter-input">
      </div>
      <div class="ios-filter-item">
        <label class="ios-filter-label">Tipo</label>
        <select id="typeFilter" class="ios-filter-input">
          <option value="">Todos los tipos</option>
          <!-- Options will be loaded dynamically from backend -->
        </select>
      </div>
      <div class="ios-filter-item">
        <label class="ios-filter-label">Estado</label>
        <select id="statusFilter" class="ios-filter-input">
          <option value="">Todos los estados</option>
          <option value="available">Disponible</option>
          <option value="out_of_stock">Sin Stock</option>
          <option value="discontinued">Descontinuado</option>
          <option value="inactive">Inactivo</option>
        </select>
      </div>
      <div class="ios-filter-item">
        <label class="ios-filter-label">Mostrar</label>
        <select id="includeInactiveFilter" class="ios-filter-input">
          <option value="active">Solo Activos</option>
          <option value="all">Todos (Activos + Inactivos)</option>
        </select>
      </div>
      <div class="ios-filter-item flex items-end">
        <button class="ios-action-btn w-full" onclick="clearFilters()">
          <i class="fas fa-filter-circle-xmark"></i>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- iOS Hardware Grid View -->
  <div id="hardwareGrid" class="ios-hardware-grid">
    <!-- Hardware cards will be loaded dynamically by JavaScript -->
  </div>

</div>

<!-- Create/Edit Hardware Modal -->
<div id="hardwareModal" class="ios-modal-backdrop hidden ">
  <div class="ios-blur-modal-container w-full max-w-4xl">
    <!-- Modal Header -->
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-microchip text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white" id="modalTitle">Nuevo Hardware</h3>
            <p class="text-sm text-white/70">Complete los campos para registrar el hardware</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" onclick="closeModal()" aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="ios-blur-body">
      <form id="hardwareForm">
        <div class="form-grid">
          <!-- Nombre del Hardware -->
          <div class="form-group">
            <label for="hardwareName" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-tag text-purple-400 mr-2"></i>Nombre *
            </label>
            <input type="text" id="hardwareName" class="ios-blur-input" required
                   placeholder="Ej: Dell PowerEdge R740">
          </div>
          
          <!-- Tipo de Hardware -->
          <div class="form-group">
            <label for="hardwareType" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-layer-group text-blue-400 mr-2"></i>Tipo *
            </label>
            <select id="hardwareType" class="ios-blur-input" required>
              <option value="">Seleccionar tipo</option>
              <!-- Options will be loaded dynamically from backend -->
            </select>
          </div>
          
          <!-- Empresa -->
          <div class="form-group">
            <label for="hardwareEmpresa" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-building text-cyan-400 mr-2"></i>Empresa *
            </label>
            <select id="hardwareEmpresa" class="ios-blur-input" required onchange="loadSedesByEmpresa()">
              <option value="">Seleccionar empresa</option>
              <!-- Options will be loaded dynamically from backend -->
            </select>
          </div>
          
          <!-- Sede -->
          <div class="form-group">
            <label for="hardwareSede" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-map-marker-alt text-rose-400 mr-2"></i>Sede *
            </label>
            <select id="hardwareSede" class="ios-blur-input" required disabled>
              <option value="">Seleccionar sede</option>
              <!-- Options will be loaded dynamically based on selected empresa -->
            </select>
          </div>
          
          <!-- Marca -->
          <div class="form-group">
            <label for="hardwareBrand" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-industry text-green-400 mr-2"></i>Marca *
            </label>
            <input type="text" id="hardwareBrand" class="ios-blur-input" required
                   placeholder="Ej: Dell, HP, Cisco">
          </div>
          
          <!-- Modelo -->
          <div class="form-group">
            <label for="hardwareModel" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-cube text-orange-400 mr-2"></i>Modelo *
            </label>
            <input type="text" id="hardwareModel" class="ios-blur-input" required
                   placeholder="Ej: R740, OptiPlex 7090">
          </div>
          
          <!-- Precio -->
          <div class="form-group">
            <label for="hardwarePrice" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-dollar-sign text-yellow-400 mr-2"></i>Precio (USD) *
            </label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/60 font-semibold">$</span>
              <input type="number" id="hardwarePrice" class="ios-blur-input !pl-8" required 
                     min="0" step="0.01" placeholder="0.00">
            </div>
          </div>
          
          <!-- Stock -->
          <div class="form-group">
            <label for="hardwareStock" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-boxes text-indigo-400 mr-2"></i>Stock *
            </label>
            <input type="number" id="hardwareStock" class="ios-blur-input" required 
                   min="0" placeholder="Cantidad disponible">
          </div>
          
          <!-- Estado -->
          <div class="form-group">
            <label for="hardwareStatus" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-signal text-red-400 mr-2"></i>Estado
            </label>
            <select id="hardwareStatus" class="ios-blur-input" required>
              <option value="available">🟢 Disponible</option>
              <option value="out_of_stock">🔴 Sin Stock</option>
              <option value="discontinued">⚫ Descontinuado</option>
            </select>
          </div>
          
          <!-- Garantía -->
          <div class="form-group">
            <label for="hardwareWarranty" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-shield-alt text-teal-400 mr-2"></i>Garantía
            </label>
            <select id="hardwareWarranty" class="ios-blur-input" required>
              <option value="12">📅 12 meses</option>
              <option value="24">📅 24 meses</option>
              <option value="36">📅 36 meses</option>
            </select>
          </div>
          
          <!-- Descripción -->
          <div class="form-group form-group-full">
            <label for="hardwareDescription" class="block text-sm font-semibold text-white/90 mb-2">
              <i class="fas fa-align-left text-gray-400 mr-2"></i>Descripción
            </label>
            <textarea id="hardwareDescription" class="ios-blur-input !min-h-[6rem] resize-y" rows="3"
                      placeholder="Descripción detallada del hardware, características técnicas, especificaciones..."></textarea>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Modal Footer -->
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" onclick="closeModal()">
        <i class="fas fa-times mr-2"></i>
        Cancelar
      </button>
      <button type="submit" form="hardwareForm" class="ios-blur-btn ios-blur-btn-primary" id="submitButton">
        <i class="fas fa-save mr-2"></i>
        <span id="submitButtonText">Crear Hardware</span>
      </button>
    </div>
  </div>
</div>

<!-- View Hardware Details Modal -->
<div id="viewHardwareModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-4xl">
    <!-- Modal Header -->
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-eye text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white">Detalles del Hardware</h3>
            <p class="text-sm text-white/70">Información completa del hardware seleccionado</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" onclick="closeViewModal()" aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="ios-blur-body">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-tag mr-2 text-yellow-200"></i>Nombre
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareName">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-500 via-cyan-500 to-teal-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-layer-group mr-2 text-yellow-200"></i>Tipo
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareType">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-green-500 via-emerald-500 to-teal-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-building mr-2 text-yellow-200"></i>Empresa
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareEmpresa">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-orange-500 via-red-500 to-pink-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-map-marker-alt mr-2 text-yellow-200"></i>Sede
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareSede">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-industry mr-2 text-yellow-200"></i>Marca
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareBrand">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-pink-500 via-rose-500 to-red-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-cube mr-2 text-yellow-200"></i>Modelo
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareModel">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-yellow-500 via-orange-500 to-red-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-dollar-sign mr-2 text-yellow-200"></i>Precio (USD)
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwarePrice">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-cyan-500 via-blue-500 to-indigo-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-boxes mr-2 text-yellow-200"></i>Stock
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareStock">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-gray-700 via-gray-800 to-gray-900 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-signal mr-2 text-yellow-200"></i>Estado
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareStatus">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-emerald-500 via-green-500 to-lime-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-shield-alt mr-2 text-yellow-200"></i>Garantía
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareWarranty">-</div>
        </div>
        
        <div class="bg-gradient-to-br from-red-500 via-pink-500 to-rose-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-toggle-on mr-2 text-yellow-200"></i>Estado Activo
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareActive">-</div>
        </div>
        
        <div class="col-span-1 md:col-span-2 bg-gradient-to-br from-slate-700 via-slate-800 to-slate-900 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-calendar-alt mr-2 text-yellow-200"></i>Fecha de Creación
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md" id="viewHardwareCreated">-</div>
        </div>
        
        <div class="col-span-1 md:col-span-2 bg-gradient-to-br from-violet-600 via-purple-700 to-indigo-800 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-align-left mr-2 text-yellow-200"></i>Descripción
          </label>
          <div class="text-lg font-medium text-white drop-shadow-md leading-relaxed" id="viewHardwareDescription">
            <em class="text-gray-200">Sin descripción disponible</em>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" onclick="closeViewModal()">
        <i class="fas fa-times mr-2"></i>
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Toggle Hardware Status Modal -->
<div id="toggleHardwareModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container max-w-md" id="toggleModalContainer">
    <div class="ios-blur-header text-center">
      <div class="toggle-modal-icon mx-auto mb-4" id="toggleModalIcon">
        <i class="fas fa-power-off text-4xl" id="toggleModalIconFa"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2" id="toggleModalTitle">Activar Hardware</h3>
    </div>
    <div class="ios-blur-body text-center">
      <p class="text-white/80 text-lg mb-6" id="toggleModalMessage">
        ¿Estás seguro de que quieres activar este hardware?
      </p>
      <div class="flex gap-4 justify-center">
        <button class="ios-blur-btn ios-blur-btn-secondary" onclick="closeToggleModal()">
          <i class="fas fa-times mr-2"></i>
          Cancelar
        </button>
        <button class="ios-blur-btn ios-blur-btn-primary" id="toggleConfirmBtn" onclick="confirmToggleHardware()">
          <i class="fas fa-check mr-2" id="toggleConfirmIcon"></i>
          <span id="toggleConfirmText">Activar</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Client Update Success Modal -->
<div id="clientUpdateModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container max-w-md" id="updateModalContainer">
    <div class="ios-blur-header text-center">
      <div class="client-update-icon mx-auto mb-4" id="updateModalIcon">
        <i class="fas fa-sync-alt text-4xl text-emerald-400" id="updateModalIconFa"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2" id="updateModalTitle">Cliente Actualizado</h3>
    </div>
    <div class="ios-blur-body text-center">
      <p class="text-white/80 text-lg mb-6" id="updateModalMessage">
        El cliente se ha actualizado exitosamente.
      </p>
      <button class="ios-blur-btn ios-blur-btn-primary mx-auto" onclick="closeUpdateModal()">
        <i class="fas fa-check mr-2"></i>
        Aceptar
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/api-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard/basic-managers.js') }}"></script>
<script>
let editingHardware = null;

// Initialize modals when page loads
function initializeModals() {
  console.log('🚀 Initializing modals...');
  
  if (window.modalManager) {
    // Setup all modals in the page
    const modalIds = ['hardwareModal', 'viewHardwareModal'];
    modalIds.forEach(modalId => {
      window.modalManager.setupModal(modalId);
      console.log(`✅ Modal ${modalId} configured`);
    });
  } else {
    console.warn('⚠️ ModalManager not available');
  }
  
  // Ensure theme is properly applied
  if (window.ThemeManager) {
    console.log('✅ ThemeManager available, theme should be persistent');
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initializeModals);


// Modal functionality with enhanced animations
function openCreateModal() {
  editingHardware = null;
  document.getElementById('modalTitle').textContent = 'Nuevo Hardware';
  document.getElementById('submitButtonText').textContent = 'Crear Hardware';
  document.getElementById('hardwareForm').reset();
  
  // Scroll to top first, then show modal
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Delay modal opening to allow scroll to complete
  setTimeout(() => {
    // Prevent body scrolling
    const scrollPosition = window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('ios-modal-open');
    
    // Open modal using modal manager
    if (window.modalManager) {
      window.modalManager.openModal('hardwareModal');
      // Set up modal if not already configured
      window.modalManager.setupModal('hardwareModal');
    } else {
      // Fallback for compatibility
      const modal = document.getElementById('hardwareModal');
      modal.classList.remove('hidden');
    }
  }, 300);
}

async function editHardware(id) {
  try {
    editingHardware = id;
    document.getElementById('modalTitle').textContent = 'Editar Hardware';
    document.getElementById('submitButtonText').textContent = 'Actualizar Hardware';
    
    // Intentar cargar los datos reales del hardware
    try {
      console.log('🔄 Cargando datos para editar hardware:', id);
      const response = await apiClient.get_hardware_details(id);
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          console.log('📋 Datos del hardware cargados para edición:', data.data);
          loadHardwareDataIntoForm(data.data);
        } else {
          console.warn('⚠️ Error en respuesta del API:', data.errors);
          loadDummyDataIntoForm(); // Fallback a datos dummy
        }
      } else {
        console.warn('⚠️ Error HTTP al cargar datos:', response.status);
        loadDummyDataIntoForm(); // Fallback a datos dummy
      }
    } catch (error) {
      console.error('💥 Error al cargar datos del hardware:', error);
      loadDummyDataIntoForm(); // Fallback a datos dummy
    }
    
    // Scroll to top first, then show modal
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Delay modal opening to allow scroll to complete
    setTimeout(() => {
      // Prevent body scrolling
      const scrollPosition = window.pageYOffset;
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPosition}px`;
      document.body.style.width = '100%';
      document.body.classList.add('ios-modal-open');
      
      // Open modal using modal manager
      if (window.modalManager) {
        window.modalManager.openModal('hardwareModal');
        // Set up modal if not already configured
        window.modalManager.setupModal('hardwareModal');
      } else {
        // Fallback for compatibility
        const modal = document.getElementById('hardwareModal');
        modal.classList.remove('hidden');
      }
    }, 300);
    
  } catch (error) {
    console.error('💥 Error al abrir modal de edición:', error);
    alert('Error al abrir el modal de edición. Por favor, inténtalo de nuevo.');
  }
}

// Función para cargar datos reales en el formulario
function loadHardwareDataIntoForm(hardware) {
  try {
    // Función helper para obtener valor seguro
    const getSafeValue = (obj, path, defaultValue = '') => {
      try {
        const keys = path.split('.');
        let current = obj;
        for (const key of keys) {
          if (current === null || current === undefined) {
            return defaultValue;
          }
          current = current[key];
        }
        return current !== null && current !== undefined ? current : defaultValue;
      } catch (e) {
        return defaultValue;
      }
    };
    
    // Función helper para establecer valor en input de forma segura
    const setInputValue = (inputId, value) => {
      try {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = value || '';
        } else {
          console.warn(`Input con ID '${inputId}' no encontrado`);
        }
      } catch (e) {
        console.error(`Error al establecer valor en input '${inputId}':`, e);
      }
    };
    
    // Extraer datos anidados
    let datos = {};
    if (hardware.datos) {
      if (typeof hardware.datos === 'object') {
        datos = hardware.datos.datos || hardware.datos;
      } else if (typeof hardware.datos === 'string') {
        try {
          const parsed = JSON.parse(hardware.datos);
          datos = parsed.datos || parsed;
        } catch (e) {
          console.warn('Error parsing datos string:', e);
          datos = {};
        }
      }
    }
    
    console.log('📊 Datos extraídos para formulario:', datos);
    
    // Llenar el formulario con los datos reales
    setInputValue('hardwareName', getSafeValue(hardware, 'nombre'));
    setInputValue('hardwareType', getSafeValue(hardware, 'tipo'));
    
    // Set empresa and sede
    const empresaId = getSafeValue(hardware, 'empresa_id');
    if (empresaId) {
      setInputValue('hardwareEmpresa', empresaId);
      // Trigger sede loading after empresa is set
      setTimeout(() => {
        loadSedesByEmpresa();
        // Set sede after sedes are loaded
        setTimeout(() => {
          setInputValue('hardwareSede', getSafeValue(hardware, 'sede'));
        }, 100);
      }, 100);
    }
    
    setInputValue('hardwareBrand', 
      getSafeValue(datos, 'brand') || 
      getSafeValue(datos, 'marca') || 
      getSafeValue(hardware, 'marca')
    );
    
    setInputValue('hardwareModel', 
      getSafeValue(datos, 'model') || 
      getSafeValue(datos, 'modelo') || 
      getSafeValue(hardware, 'modelo')
    );
    
    setInputValue('hardwarePrice', 
      getSafeValue(datos, 'price') || 
      getSafeValue(datos, 'precio') || 
      getSafeValue(hardware, 'precio')
    );
    
    setInputValue('hardwareStock', 
      getSafeValue(datos, 'stock') || 
      getSafeValue(hardware, 'stock')
    );
    
    // Estado
    const status = getSafeValue(datos, 'status') || 
                  getSafeValue(datos, 'estado') || 
                  getSafeValue(hardware, 'status') || 
                  getSafeValue(hardware, 'estado') || 
                  'available';
    setInputValue('hardwareStatus', status);
    
    // Garantía
    const warranty = getSafeValue(datos, 'warranty') || 
                    getSafeValue(datos, 'garantia') || 
                    getSafeValue(hardware, 'warranty') || 
                    getSafeValue(hardware, 'garantia') || 
                    '12';
    setInputValue('hardwareWarranty', warranty);
    
    // Descripción
    const description = getSafeValue(datos, 'description') || 
                       getSafeValue(datos, 'descripcion') || 
                       getSafeValue(hardware, 'descripcion');
    setInputValue('hardwareDescription', description);
    
    console.log('✅ Datos cargados en el formulario correctamente');
    
  } catch (error) {
    console.error('💥 Error al cargar datos en el formulario:', error);
    loadDummyDataIntoForm(); // Fallback a datos dummy
  }
}

// Función para cargar datos dummy en caso de error
function loadDummyDataIntoForm() {
  console.log('⚠️ Cargando datos dummy en el formulario');
  
  const setInputValue = (inputId, value) => {
    const input = document.getElementById(inputId);
    if (input) input.value = value;
  };
  
  setInputValue('hardwareName', 'Hardware sin nombre');
  setInputValue('hardwareType', 'General');
  setInputValue('hardwareBrand', 'Sin marca');
  setInputValue('hardwareModel', 'Sin modelo');
  setInputValue('hardwarePrice', '0');
  setInputValue('hardwareStock', '0');
  setInputValue('hardwareStatus', 'available');
  setInputValue('hardwareWarranty', '12');
  setInputValue('hardwareDescription', '');
}

function closeModal() {
  // Restore scroll position before closing
  const scrollY = document.body.style.top;
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  document.body.classList.remove('ios-modal-open');
  
  if (scrollY) {
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
  }
  
  // Usar el sistema de modales global
  if (window.modalManager) {
    window.modalManager.closeModal('hardwareModal');
  } else {
    // Fallback para compatibilidad
    const modal = document.getElementById('hardwareModal');
    modal.classList.add('hidden');
  }
  
  editingHardware = null;
  resetForm();
}

// Función para resetear el formulario
function resetForm() {
  const form = document.getElementById('hardwareForm');
  if (form) {
    form.reset();
  }
}

async function viewHardware(id) {
  try {
    console.log('🔍 Cargando detalles del hardware:', id);
    
    // Validar que el ID no sea nulo o indefinido
    if (!id) {
      console.error('❌ ID de hardware no válido:', id);
      alert('Error: ID de hardware no válido');
      return;
    }
    
    // Verificar que el API client esté disponible
    if (!apiClient || typeof apiClient.get_hardware_details !== 'function') {
      console.error('❌ API client no disponible');
      alert('Error: Conexión con el servidor no disponible');
      return;
    }
    
    const response = await apiClient.get_hardware_details(id);
    
    if (!response.ok) {
      console.error('❌ Error HTTP:', response.status, response.statusText);
      
      if (response.status === 404) {
        alert('Hardware no encontrado. Puede que haya sido eliminado.');
      } else if (response.status === 401) {
        alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
        window.location.href = '/login';
      } else if (response.status === 403) {
        alert('No tienes permisos para ver este hardware.');
      } else {
        alert(`Error del servidor: ${response.status} - ${response.statusText}`);
      }
      return;
    }
    
    const data = await response.json();
    console.log('📦 Respuesta completa del API:', data);
    
    if (data.success) {
      console.log('📋 Detalles del hardware cargados:', data.data);
      
      // Verificar que los datos no estén vacíos
      if (!data.data) {
        console.warn('⚠️ Datos del hardware vacíos');
        alert('No se encontraron datos para este hardware.');
        return;
      }
      
      showHardwareDetails(data.data);
    } else {
      console.error('❌ Error en respuesta del API:', data.errors);
      const errorMessage = data.errors && Array.isArray(data.errors) 
        ? data.errors.join(', ') 
        : data.error || 'Error desconocido';
      alert('Error al cargar los detalles del hardware: ' + errorMessage);
    }
  } catch (error) {
    console.error('💥 Error al cargar detalles del hardware:', error);
    
    // Manejo de diferentes tipos de errores
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      alert('Error de conexión. Verifica tu conexión a internet.');
    } else if (error.name === 'SyntaxError') {
      alert('Error en la respuesta del servidor. Inténtalo de nuevo.');
    } else {
      alert('Error inesperado al cargar los detalles. Inténtalo de nuevo.');
    }
  }
}

// Variable para almacenar el hardware actual que se está visualizando
let currentViewingHardware = null;

// Función de utilidad para debuggear estructuras de datos
function debugHardwareStructure(hardware, context = 'Unknown') {
  console.group(`🔍 Debug Hardware Structure - ${context}`);
  console.log('📊 Objeto completo:', hardware);
  console.log('📋 Tipo de objeto:', typeof hardware);
  console.log('🔑 Claves principales:', Object.keys(hardware || {}));
  
  if (hardware) {
    // Verificar estructura de datos
    console.log('📝 Nombre:', hardware.nombre || hardware.name || 'No encontrado');
    console.log('📂 Tipo:', hardware.tipo || hardware.type || 'No encontrado');
    console.log('🏢 Empresa:', hardware.empresa_nombre || hardware.company || 'No encontrado');
    console.log('📍 Sede:', hardware.sede || hardware.location || 'No encontrado');
    console.log('✅ Activa:', hardware.activa || hardware.active || 'No encontrado');
    
    // Verificar estructura de datos anidados
    if (hardware.datos) {
      console.log('📦 Datos anidados tipo:', typeof hardware.datos);
      if (typeof hardware.datos === 'string') {
        try {
          const parsed = JSON.parse(hardware.datos);
          console.log('📝 Datos parseados:', parsed);
          console.log('🔑 Claves de datos parseados:', Object.keys(parsed || {}));
        } catch (e) {
          console.warn('⚠️ Error al parsear datos string:', e);
        }
      } else if (typeof hardware.datos === 'object') {
        console.log('📦 Datos como objeto:', hardware.datos);
        console.log('🔑 Claves de datos:', Object.keys(hardware.datos || {}));
        
        if (hardware.datos.datos) {
          console.log('📦 Datos.datos:', hardware.datos.datos);
          console.log('🔑 Claves de datos.datos:', Object.keys(hardware.datos.datos || {}));
        }
      }
    } else {
      console.log('❌ No hay campo "datos"');
    }
  }
  
  console.groupEnd();
}

// Función para mostrar los detalles del hardware en el modal
function showHardwareDetails(hardware) {
  try {
    console.log('📋 Datos completos del hardware recibidos:', hardware);
    
    // Debug de la estructura de datos
    debugHardwareStructure(hardware, 'showHardwareDetails');
    
    currentViewingHardware = hardware;
    
    // Función helper para obtener valor seguro
    const getSafeValue = (obj, path, defaultValue = 'N/A') => {
      try {
        const keys = path.split('.');
        let current = obj;
        for (const key of keys) {
          if (current === null || current === undefined) {
            return defaultValue;
          }
          current = current[key];
        }
        return current !== null && current !== undefined ? current : defaultValue;
      } catch (e) {
        console.warn(`Error accessing path ${path}:`, e);
        return defaultValue;
      }
    };
    
    // Función helper para obtener elemento del DOM de forma segura
    const setElementText = (elementId, value) => {
      try {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = value;
        } else {
          console.warn(`Element with ID '${elementId}' not found`);
        }
      } catch (e) {
        console.error(`Error setting text for element '${elementId}':`, e);
      }
    };
    
    // Extraer datos anidados con múltiples posibilidades
    let datos = {};
    if (hardware.datos) {
      if (typeof hardware.datos === 'object') {
        // Si datos es un objeto, puede tener .datos anidado o ser los datos directamente
        datos = hardware.datos.datos || hardware.datos;
      } else if (typeof hardware.datos === 'string') {
        // Si datos es un string JSON, parsearlo
        try {
          const parsed = JSON.parse(hardware.datos);
          datos = parsed.datos || parsed;
        } catch (e) {
          console.warn('Error parsing datos string:', e);
          datos = {};
        }
      }
    }
    
    console.log('📊 Datos extraídos para mostrar:', datos);
    
    // Llenar los campos del modal con validaciones defensivas
    setElementText('viewHardwareName', getSafeValue(hardware, 'nombre'));
    setElementText('viewHardwareType', getSafeValue(hardware, 'tipo'));
    setElementText('viewHardwareEmpresa', getSafeValue(hardware, 'empresa_nombre'));
    setElementText('viewHardwareSede', getSafeValue(hardware, 'sede'));
    
    // Campos de datos con múltiples posibilidades
    setElementText('viewHardwareBrand', 
      getSafeValue(datos, 'brand') || 
      getSafeValue(datos, 'marca') || 
      getSafeValue(hardware, 'marca') || 
      'N/A'
    );
    
    setElementText('viewHardwareModel', 
      getSafeValue(datos, 'model') || 
      getSafeValue(datos, 'modelo') || 
      getSafeValue(hardware, 'modelo') || 
      'N/A'
    );
    
    // Precio con formateo
    const price = getSafeValue(datos, 'price') || 
                 getSafeValue(datos, 'precio') || 
                 getSafeValue(hardware, 'precio');
    setElementText('viewHardwarePrice', 
      price && price !== 'N/A' ? `$${price}` : 'N/A'
    );
    
    // Stock con formateo
    const stock = getSafeValue(datos, 'stock') || 
                 getSafeValue(hardware, 'stock');
    setElementText('viewHardwareStock', 
      stock !== 'N/A' && stock !== null && stock !== undefined ? `${stock} unidades` : 'N/A'
    );
    
    // Estado con múltiples posibilidades
    let statusText = 'N/A';
    const status = getSafeValue(datos, 'status') || 
                  getSafeValue(datos, 'estado') || 
                  getSafeValue(hardware, 'status') || 
                  getSafeValue(hardware, 'estado') || 
                  'available';
    
    if (status === 'available' || status === 'disponible') {
      statusText = 'Disponible';
    } else if (status === 'out_of_stock' || status === 'sin_stock') {
      statusText = 'Sin Stock';
    } else if (status === 'discontinued' || status === 'descontinuado') {
      statusText = 'Descontinuado';
    } else if (status !== 'N/A') {
      statusText = status; // Mostrar el estado tal como viene si no es N/A
    }
    setElementText('viewHardwareStatus', statusText);
    
    // Garantía con múltiples posibilidades
    const warranty = getSafeValue(datos, 'warranty') || 
                    getSafeValue(datos, 'garantia') || 
                    getSafeValue(hardware, 'warranty') || 
                    getSafeValue(hardware, 'garantia');
    setElementText('viewHardwareWarranty', 
      warranty && warranty !== 'N/A' ? `${warranty} meses` : 'N/A'
    );
    
    // Activo (con validación de tipo)
    const activa = getSafeValue(hardware, 'activa');
    let activaText = 'N/A';
    if (activa === true || activa === 'true' || activa === 1 || activa === '1') {
      activaText = 'Sí';
    } else if (activa === false || activa === 'false' || activa === 0 || activa === '0') {
      activaText = 'No';
    }
    setElementText('viewHardwareActive', activaText);
    
    // Fecha de creación con múltiples formatos
    let fechaCreacion = 'N/A';
    const fechaRaw = getSafeValue(hardware, 'fecha_creacion') || 
                    getSafeValue(hardware, 'created_at') || 
                    getSafeValue(hardware, 'createdAt');
    
    if (fechaRaw && fechaRaw !== 'N/A') {
      try {
        const fecha = new Date(fechaRaw);
        if (!isNaN(fecha.getTime())) {
          fechaCreacion = fecha.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          fechaCreacion = fechaRaw; // Usar valor original si no se puede parsear
        }
      } catch (e) {
        console.warn('Error parsing date:', e);
        fechaCreacion = fechaRaw; // Usar valor original en caso de error
      }
    }
    setElementText('viewHardwareCreated', fechaCreacion);
    
    // Descripción con múltiples posibilidades
    const description = getSafeValue(datos, 'description') || 
                       getSafeValue(datos, 'descripcion') || 
                       getSafeValue(hardware, 'descripcion') || 
                       'Sin descripción';
    setElementText('viewHardwareDescription', description);
    
    // Scroll to top first, then show modal
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Delay modal opening to allow scroll to complete
    setTimeout(() => {
      // Prevent body scrolling
      const scrollPosition = window.pageYOffset;
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPosition}px`;
      document.body.style.width = '100%';
      document.body.classList.add('ios-modal-open');
      
      // Open modal using modal manager
      if (window.modalManager) {
        window.modalManager.openModal('viewHardwareModal');
        // Set up modal if not already configured
        window.modalManager.setupModal('viewHardwareModal');
      } else {
        // Fallback for compatibility
        const modal = document.getElementById('viewHardwareModal');
        modal.classList.remove('hidden');
      }
    }, 300);
    
    console.log('✅ Modal de detalles mostrado correctamente');
    
  } catch (error) {
    console.error('💥 Error al mostrar detalles del hardware:', error);
    
    // Mostrar un modal de error o alerta
    alert('Error al cargar los detalles del hardware. Por favor, inténtalo de nuevo.');
    
    // Cerrar el modal si estaba abierto
    const modal = document.getElementById('viewHardwareModal');
    if (modal && !modal.classList.contains('hidden')) {
      closeViewModal();
    }
  }
}

// Función para cerrar el modal de vista
function closeViewModal() {
  // Restore scroll position before closing
  const scrollY = document.body.style.top;
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  document.body.classList.remove('ios-modal-open');
  
  if (scrollY) {
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
  }
  
  // Usar el sistema de modales global
  if (window.modalManager) {
    window.modalManager.closeModal('viewHardwareModal');
  } else {
    // Fallback para compatibilidad
    const modal = document.getElementById('viewHardwareModal');
    modal.classList.add('hidden');
  }
  
  currentViewingHardware = null;
}

function toggleHardwareStatus(id, activa) {
  // Enhanced popup with GSAP animation
  showConfirmToggleModal(id, activa);
}

// Variables for toggle modal
let toggleModalData = {
  hardwareId: null,
  newStatus: null
};

function showConfirmToggleModal(hardwareId, newStatus) {
  console.log('🎯 Showing toggle modal for:', hardwareId, 'newStatus:', newStatus);
  
  toggleModalData.hardwareId = hardwareId;
  toggleModalData.newStatus = newStatus;

  const modal = document.getElementById('toggleHardwareModal');
  const container = document.getElementById('toggleModalContainer');
  const icon = document.getElementById('toggleModalIcon');
  const iconFa = document.getElementById('toggleModalIconFa');
  const title = document.getElementById('toggleModalTitle');
  const message = document.getElementById('toggleModalMessage');
  const confirmText = document.getElementById('toggleConfirmText');
  const confirmIcon = document.getElementById('toggleConfirmIcon');
  
  // Debug: log all elements
  console.log('📋 Modal elements:', {
    modal: modal ? 'Found' : 'NOT FOUND',
    container: container ? 'Found' : 'NOT FOUND',
    icon: icon ? 'Found' : 'NOT FOUND',
    title: title ? 'Found' : 'NOT FOUND',
    message: message ? 'Found' : 'NOT FOUND',
    confirmText: confirmText ? 'Found' : 'NOT FOUND'
  });

  if (!modal || !container || !title || !message) {
    console.error('❌ Modal elements missing!');
    return;
  }

  // Configure content based on action
  if (newStatus) {
    if (icon) icon.className = 'toggle-modal-icon activate';
    if (iconFa) iconFa.className = 'fas fa-play';
    title.textContent = 'Activar Hardware';
    message.textContent = '¿Estás seguro de que quieres activar este hardware?';
    if (confirmText) confirmText.textContent = 'Activar';
    if (confirmIcon) confirmIcon.className = 'fas fa-play';
  } else {
    if (icon) icon.className = 'toggle-modal-icon deactivate';
    if (iconFa) iconFa.className = 'fas fa-power-off';
    title.textContent = 'Desactivar Hardware';
    message.textContent = '¿Estás seguro de que quieres desactivar este hardware?';
    if (confirmText) confirmText.textContent = 'Desactivar';
    if (confirmIcon) confirmIcon.className = 'fas fa-power-off';
  }

  // Show modal immediately first
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  console.log('✅ Modal should now be visible');
  console.log('📊 Modal classes:', modal.className);
  console.log('📊 Modal display:', modal.style.display);

  // Simple animation without complex GSAP for debugging
  if (typeof gsap !== 'undefined') {
    gsap.set(container, { scale: 0.8, opacity: 0 });
    gsap.to(container, {
      scale: 1,
      opacity: 1,
      duration: 0.3,
      ease: "power2.out"
    });
  } else {
    console.warn('⚠️ GSAP not loaded, using CSS animation');
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }
}

// Close toggle modal with animation
function closeToggleModal() {
  console.log('🔄 Closing toggle modal');
  
  const modal = document.getElementById('toggleHardwareModal');
  const container = document.getElementById('toggleModalContainer');
  const buttons = document.querySelector('.toggle-modal-buttons');
  const confirmBtn = document.getElementById('toggleConfirmBtn');
  
  if (!modal) {
    console.error('❌ Modal not found when trying to close');
    return;
  }
  
  // Simple close without complex animation for debugging
  if (typeof gsap !== 'undefined' && container) {
    gsap.to(container, {
      scale: 0.8,
      opacity: 0,
      duration: 0.2,
      ease: "power2.in",
      onComplete: () => {
        resetAndHideModal();
      }
    });
  } else {
    resetAndHideModal();
  }
  
  function resetAndHideModal() {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    // Reset modal state completely
    if (buttons) {
      buttons.style.display = 'flex';
      buttons.style.opacity = '1';
      buttons.style.transform = 'none';
    }
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-check" id="toggleConfirmIcon"></i> <span id="toggleConfirmText">Confirmar</span>';
    }
    
    // Reset icon and text
    const icon = document.getElementById('toggleModalIcon');
    const iconFa = document.getElementById('toggleModalIconFa');
    const title = document.getElementById('toggleModalTitle');
    const message = document.getElementById('toggleModalMessage');
    
    if (icon) {
      icon.style.transform = 'none';
      icon.style.scale = '1';
    }
    if (title) title.textContent = 'Confirmar Acción';
    if (message) message.textContent = '¿Estás seguro de que quieres continuar?';
    
    // Reset data
    toggleModalData.hardwareId = null;
    toggleModalData.newStatus = null;
    
    console.log('✅ Toggle modal closed and fully reset');
  }
}

// Confirm toggle hardware status
function confirmToggleHardware() {
  if (toggleModalData.hardwareId && toggleModalData.newStatus !== null) {
    // Show loading state
    const confirmBtn = document.getElementById('toggleConfirmBtn');
    const originalContent = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    confirmBtn.disabled = true;
    
    // Call the API function
    toggleHardwareStatusAPI(toggleModalData.hardwareId, toggleModalData.newStatus)
      .then(() => {
        // Show success feedback before closing
        showToggleSuccess(toggleModalData.newStatus);
      })
      .catch((error) => {
        // Restore button on error
        confirmBtn.innerHTML = originalContent;
        confirmBtn.disabled = false;
        console.error('Error in toggle operation:', error);
      });
  }
}

// Show toggle success feedback
function showToggleSuccess(activated) {
  console.log('✅ Showing toggle success for:', activated ? 'activate' : 'deactivate');
  
  const container = document.getElementById('toggleModalContainer');
  const icon = document.getElementById('toggleModalIcon');
  const iconFa = document.getElementById('toggleModalIconFa');
  const title = document.getElementById('toggleModalTitle');
  const message = document.getElementById('toggleModalMessage');
  const buttons = document.querySelector('.toggle-modal-buttons');
  
  if (!icon || !title || !message || !buttons) {
    console.error('❌ Toggle success elements missing!');
    closeToggleModal();
    return;
  }
  
  // Update content to show success
  if (activated) {
    icon.className = 'toggle-modal-icon activate';
    if (iconFa) iconFa.className = 'fas fa-check-circle';
    title.textContent = '¡Hardware Activado!';
    message.textContent = 'El hardware se ha activado exitosamente.';
  } else {
    icon.className = 'toggle-modal-icon deactivate';
    if (iconFa) iconFa.className = 'fas fa-times-circle';
    title.textContent = '¡Hardware Desactivado!';
    message.textContent = 'El hardware se ha desactivado exitosamente.';
  }
  
  // Hide buttons temporarily
  if (typeof gsap !== 'undefined') {
    gsap.to(buttons, {
      opacity: 0,
      duration: 0.3,
      onComplete: () => {
        buttons.style.display = 'none';
      }
    });
    
    // Animate success state
    gsap.to(icon, {
      scale: 1.2,
      duration: 0.3,
      ease: "back.out(1.7)"
    });
  } else {
    buttons.style.display = 'none';
  }
  
  // Auto-close after 2 seconds
  setTimeout(() => {
    closeToggleModal();
  }, 2000);
}

// Client Update Modal Functions
function showClientUpdateModal(message = 'El cliente se ha actualizado exitosamente.') {
  console.log('🔄 Showing client update modal:', message);
  
  const modal = document.getElementById('clientUpdateModal');
  const container = document.getElementById('updateModalContainer');
  const icon = document.getElementById('updateModalIcon');
  const iconFa = document.getElementById('updateModalIconFa');
  const title = document.getElementById('updateModalTitle');
  const messageEl = document.getElementById('updateModalMessage');
  
  if (!modal || !container || !title || !messageEl) {
    console.error('❌ Client update modal elements missing!');
    return;
  }
  
  // Set success styling with separate classes
  if (icon) icon.className = 'client-update-icon';
  if (iconFa) iconFa.className = 'fas fa-check-circle';
  
  // Set dynamic title based on message
  if (message.includes('creado')) {
    title.textContent = '¡Hardware Creado!';
  } else if (message.includes('actualizado')) {
    title.textContent = '¡Hardware Actualizado!';
  } else {
    title.textContent = '¡Operación Exitosa!';
  }
  
  messageEl.textContent = message;
  
  // Show modal
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  console.log('✅ Client update modal should now be visible');
  
  // Simple animation
  if (typeof gsap !== 'undefined') {
    gsap.set(container, { scale: 0.8, opacity: 0 });
    gsap.to(container, {
      scale: 1,
      opacity: 1,
      duration: 0.4,
      ease: "back.out(1.7)"
    });
    
    if (icon) {
      gsap.to(icon, {
        scale: 1.1,
        duration: 0.6,
        repeat: 1,
        yoyo: true,
        ease: "power2.inOut"
      });
    }
  } else {
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }
  
  // NO auto-close - wait for user interaction
  console.log('⏰ Modal will stay open until user clicks Aceptar or clicks outside');
}

// Close update modal
function closeUpdateModal() {
  console.log('🔄 Closing client update modal');
  
  const modal = document.getElementById('clientUpdateModal');
  const container = document.getElementById('updateModalContainer');
  
  if (!modal) {
    console.error('❌ Client update modal not found when trying to close');
    return;
  }
  
  // Simple close animation
  if (typeof gsap !== 'undefined' && container) {
    gsap.to(container, {
      scale: 0.8,
      opacity: 0,
      duration: 0.3,
      ease: "power2.in",
      onComplete: () => {
        resetAndHideUpdateModal();
      }
    });
  } else {
    resetAndHideUpdateModal();
  }
  
  function resetAndHideUpdateModal() {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    console.log('✅ Client update modal closed');
  }
}

// Test function for modal (debugging)
function testToggleModal() {
  console.log('🧪 Testing toggle modal...');
  showConfirmToggleModal('test-id', true);
}

// Test function for client update modal
function testUpdateModal() {
  console.log('🧪 Testing client update modal...');
  showClientUpdateModal('Hardware actualizado exitosamente para prueba');
}

// Make test functions available globally
window.testToggleModal = testToggleModal;
window.testUpdateModal = testUpdateModal;

// Initialize API client
let apiClient;
let currentToken = null;

// Check modal elements on page load
function checkModalElements() {
  console.log('🔍 Checking modal elements...');
  
  const toggleElements = {
    toggleModal: document.getElementById('toggleHardwareModal'),
    toggleContainer: document.getElementById('toggleModalContainer'),
    toggleTitle: document.getElementById('toggleModalTitle'),
    toggleMessage: document.getElementById('toggleModalMessage'),
    toggleButtons: document.querySelector('.toggle-modal-buttons'),
    toggleConfirmBtn: document.getElementById('toggleConfirmBtn')
  };
  
  const updateElements = {
    updateModal: document.getElementById('clientUpdateModal'),
    updateContainer: document.getElementById('updateModalContainer'),
    updateTitle: document.getElementById('updateModalTitle'),
    updateMessage: document.getElementById('updateModalMessage'),
    updateButton: document.querySelector('.client-update-button')
  };
  
  console.log('🔵 Toggle Modal Elements:');
  Object.entries(toggleElements).forEach(([name, element]) => {
    if (element) {
      console.log(`  ✅ ${name}: Found`);
    } else {
      console.error(`  ❌ ${name}: NOT FOUND`);
    }
  });
  
  console.log('🟢 Update Modal Elements:');
  Object.entries(updateElements).forEach(([name, element]) => {
    if (element) {
      console.log(`  ✅ ${name}: Found`);
    } else {
      console.error(`  ❌ ${name}: NOT FOUND`);
    }
  });
  
  return { ...toggleElements, ...updateElements };
}

// Get token from session and initialize
fetch('/proxy/health')
  .then(response => {
    if (response.ok) {
      apiClient = new EndpointTestClient('/proxy');
      console.log('API Client initialized');
      
      // Check modal elements
      setTimeout(checkModalElements, 1000);
      
      // Initialize filter listeners first
      initializeFilterListeners();
      
      // Load hardware data on page load
      setTimeout(() => {
        loadHardware();
        loadHardwareTypes();
        loadEmpresas();
      }, 1000);
    }
  })
  .catch(err => console.error('Error initializing API client:', err));

// Functions for CRUD operations
let isLoadingHardware = false;

async function loadHardware() {
  if (isLoadingHardware) {
    console.warn('⚠️ loadHardware ya en progreso, saltando llamada duplicada...');
    return;
  }
  
  isLoadingHardware = true;
  try {
    console.log('🔄 Cargando hardware...');
    
    // Determinar qué endpoint usar basado en el filtro de inactivos
    const includeInactiveFilter = document.getElementById('includeInactiveFilter');
    const includeInactive = includeInactiveFilter ? includeInactiveFilter.value === 'all' : false;
    
    let response;
    if (includeInactive) {
      console.log('🌐 Haciendo petición a:', '/proxy/api/hardware/all-including-inactive');
      response = await apiClient.get_hardware_list_including_inactive();
    } else {
      console.log('🌐 Haciendo petición a:', '/proxy/api/hardware');
      response = await apiClient.get_hardware_list();
    }
    
    console.log('📡 Respuesta recibida - Status:', response.status, 'OK:', response.ok);
    
    if (!response.ok) {
      if (response.status === 401) {
        console.error('❌ Error 401: No autorizado. Redirigiendo al login...');
        window.location.href = '/login';
        return;
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    console.log('📦 Datos COMPLETOS recibidos del servidor:');
    console.log(JSON.stringify(data, null, 2));
    console.log('🔍 Tipo de dato recibido:', typeof data);
    console.log('🔍 Es array data?:', Array.isArray(data));
    console.log('🔍 Es array data.data?:', Array.isArray(data.data));
    console.log('🔍 Incluye inactivos?:', includeInactive);
    
    if (data.success) {
      console.log(`✅ Hardware cargado exitosamente: ${data.data.length} elementos`);
      console.log('📋 Primer elemento de la lista (si existe):');
      if (data.data && data.data.length > 0) {
        console.log(JSON.stringify(data.data[0], null, 2));
        
        // Verificar si realmente es hardware o empresas
        const firstItem = data.data[0];
        if (firstItem.hasOwnProperty('nombre') && firstItem.hasOwnProperty('tipo')) {
          console.log('✅ Confirmado: Los datos son HARDWARE');
        } else if (firstItem.hasOwnProperty('nombre') && firstItem.hasOwnProperty('ubicacion')) {
          console.error('❌ ERROR: Los datos son EMPRESAS, no hardware!');
        } else {
          console.warn('⚠️ ADVERTENCIA: Estructura de datos desconocida');
        }
      }
      
      // Renderizar hardware
      renderHardware(data.data);
      updateStats(data);
    } else {
      console.error('❌ Error en la respuesta del servidor:', data.errors);
      // Mostrar mensaje de error al usuario
      renderHardware([]);
    }
  } catch (error) {
    console.error('💥 Error al cargar hardware:', error);
    // Mostrar mensaje de error al usuario
    renderHardware([]);
  } finally {
    isLoadingHardware = false;
  }
}

async function createHardwareAPI(hardwareData) {
  try {
    const response = await apiClient.create_hardware(hardwareData);
    const data = await response.json();
    
    if (data.success) {
      // Show client update modal instead of alert for creation
      showClientUpdateModal('Hardware creado exitosamente');
      loadHardware();
      closeModal();
    } else {
      showEnhancedNotification('Error: ' + (data.errors ? data.errors.join(', ') : 'Error desconocido'), 'error');
    }
  } catch (error) {
    console.error('Error al crear hardware:', error);
    showEnhancedNotification('Error de conexión', 'error');
  }
}

async function updateHardwareAPI(id, hardwareData) {
  try {
    const response = await apiClient.update_hardware(id, hardwareData);
    const data = await response.json();
    
    if (data.success) {
      // Show client update modal instead of alert
      showClientUpdateModal('Hardware actualizado exitosamente');
      loadHardware();
      closeModal();
    } else {
      showEnhancedNotification('Error: ' + (data.errors ? data.errors.join(', ') : 'Error desconocido'), 'error');
    }
  } catch (error) {
    console.error('Error al actualizar hardware:', error);
    showEnhancedNotification('Error de conexión', 'error');
  }
}


async function toggleHardwareStatusAPI(id, activa) {
  const action = activa ? 'activar' : 'desactivar';
  
  try {
    const response = await apiClient.toggle_hardware_status(id, activa);
    const data = await response.json();
    
    if (data.success) {
      console.log(`✅ Hardware ${action}do exitosamente:`, data.message);
      // Mostrar notificación mejorada
      showEnhancedNotification(data.message || `Hardware ${action}do exitosamente`, 'success');
      // Recargar hardware para reflejar el cambio
      loadHardware();
      return Promise.resolve(data);
    } else {
      console.error('❌ Error al cambiar estado:', data.errors);
      const errorMsg = 'Error: ' + (data.errors ? data.errors.join(', ') : 'Error desconocido');
      showEnhancedNotification(errorMsg, 'error');
      return Promise.reject(new Error(errorMsg));
    }
  } catch (error) {
    console.error('💥 Error al cambiar estado del hardware:', error);
    showEnhancedNotification('Error de conexión', 'error');
    return Promise.reject(error);
  }
}

// Función helper para mostrar notificaciones menos intrusivas (legacy)
function showNotification(message, type = 'info') {
  showEnhancedNotification(message, type);
}

// Enhanced notification system with GSAP
function showEnhancedNotification(message, type = 'info') {
  // Remove existing notifications
  const existingNotifications = document.querySelectorAll('.enhanced-notification');
  existingNotifications.forEach(notification => notification.remove());
  
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `enhanced-notification fixed top-4 right-4 z-50 max-w-sm w-full`;
  
  let iconClass, bgClass, borderClass;
  if (type === 'error') {
    iconClass = 'fas fa-exclamation-circle';
    bgClass = 'bg-red-500';
    borderClass = 'border-red-600';
  } else {
    iconClass = 'fas fa-check-circle';
    bgClass = 'bg-green-500';
    borderClass = 'border-green-600';
  }
  
  notification.innerHTML = `
    <div class="${bgClass} ${borderClass} border-l-4 text-white p-4 rounded-lg shadow-xl backdrop-blur-sm">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <i class="${iconClass} text-xl"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium">${message}</p>
        </div>
        <div class="ml-auto pl-3">
          <button onclick="closeNotification(this)" class="text-white hover:text-gray-200 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Add to document
  document.body.appendChild(notification);
  
  // GSAP animations
  gsap.set(notification, { x: 400, opacity: 0 });
  
  const tl = gsap.timeline();
  tl.to(notification, {
    x: 0,
    opacity: 1,
    duration: 0.5,
    ease: "back.out(1.7)"
  })
  .to(notification, {
    scale: 1.05,
    duration: 0.1,
    yoyo: true,
    repeat: 1,
    ease: "power2.inOut"
  }, "-=0.2");
  
  // Auto-remove after 4 seconds
  setTimeout(() => {
    closeNotification(notification.querySelector('button'));
  }, 4000);
}

// Close notification with animation
function closeNotification(button) {
  const notification = button.closest('.enhanced-notification');
  if (notification) {
    gsap.to(notification, {
      x: 400,
      opacity: 0,
      duration: 0.3,
      ease: "back.in(1.7)",
      onComplete: () => notification.remove()
    });
  }
}

// Render hardware data
function renderHardware(hardwareList) {
  console.log('🎨 === INICIANDO RENDERIZADO DE HARDWARE ===');
  console.log('📋 hardwareList recibida:', hardwareList);
  console.log('🔢 Tipo de hardwareList:', typeof hardwareList);
  console.log('🔢 Es array:', Array.isArray(hardwareList));
  console.log('🔢 Longitud:', hardwareList ? hardwareList.length : 'N/A');
  
  const gridContainer = document.getElementById('hardwareGrid');
  
  if (!gridContainer) {
    console.error('❌ No se encontró el contenedor del grid');
    return;
  }
  
  // Asegurar que el grid container tenga la clase iOS correcta
  gridContainer.className = 'ios-hardware-grid';
  
  // Clear existing content more thoroughly
  console.log('🧹 Limpiando contenido existente...');
  gridContainer.innerHTML = '';
  
  // Remove any existing filter messages
  const existingFilterMessage = document.getElementById('filterEmptyMessage');
  if (existingFilterMessage) {
    console.log('🧹 Removiendo mensaje de filtro existente');
    existingFilterMessage.remove();
  }
  const existingFilterMessageTable = document.getElementById('filterEmptyMessageTable');
  if (existingFilterMessageTable) {
    console.log('🧹 Removiendo mensaje de tabla existente');
    existingFilterMessageTable.remove();
  }
  
  if (!hardwareList || hardwareList.length === 0) {
    // Show empty state
    const emptyMessage = document.createElement('div');
    emptyMessage.className = 'col-span-full text-center py-8';
    emptyMessage.innerHTML = `
      <div class="text-center">
        <i class="fas fa-box-open text-4xl mb-4 text-gray-400"></i>
        <h2 class="text-2xl font-bold text-white mb-2">No hay hardware disponible para este filtro</h2>
        <p class="text-sm text-gray-400">Prueba ajustando los filtros o haz clic en "Nuevo Hardware" para agregar uno.</p>
      </div>
    `;
    gridContainer.appendChild(emptyMessage);
    
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="6" class="text-center py-8"><h2 class="text-2xl font-bold text-white">No hay hardware disponible para este filtro</h2></td>';
    tableBody.appendChild(emptyRow);
    return;
  }
  
  console.log(`🔨 Creando ${hardwareList.length} elementos de hardware...`);
  
  hardwareList.forEach((hardware, index) => {
    try {
      console.log(`📦 Procesando hardware ${index + 1}:`, hardware);
      
      // Verificar si ya existe un elemento con este ID para evitar duplicados
      const existingGridItem = document.querySelector(`[data-hardware-id="${hardware._id}"]`);
      if (existingGridItem) {
        console.warn(`⚠️ Hardware ${hardware._id} ya existe en el DOM, saltando...`);
        return;
      }
      
      // Create grid card
      const gridCard = createHardwareCard(hardware);
      if (gridCard) {
        // Añadir ID único para evitar duplicados
        gridCard.setAttribute('data-hardware-id', hardware._id);
        
        // Asegurar que siempre tenga las clases iOS correctas
        gridCard.className = 'ios-hardware-card hardware-item';
        
        gridContainer.appendChild(gridCard);
        console.log(`✅ Card ${index + 1} agregada al grid`);
      } else {
        console.error(`❌ No se pudo crear card para hardware ${index + 1}`);
      }
    } catch (error) {
      console.error(`💥 Error renderizando hardware ${index + 1}:`, error, hardware);
    }
  });
  
  console.log(`🎉 === RENDERIZADO COMPLETADO ===`);
  console.log(`  - Grid tiene: ${gridContainer.children.length} elementos`);
  
  // Verificar que los elementos tengan las clases correctas
  const gridItems = document.querySelectorAll('.hardware-item');
  console.log(`🔍 Elementos renderizados:`);
  console.log(`  - Grid items (.hardware-item): ${gridItems.length}`);
  
  if (gridItems.length > 0) {
    console.log('🔍 Primer elemento del grid:');
    const firstGridItem = gridItems[0];
    console.log('  - Clases:', firstGridItem.className);
    console.log('  - data-name:', firstGridItem.dataset.name);
    console.log('  - data-type:', firstGridItem.dataset.type);
    console.log('  - data-status:', firstGridItem.dataset.status);
    console.log('  - data-activa:', firstGridItem.dataset.activa);
  }
  
  // Apply current filters after rendering
  console.log('🕰️ Programando aplicación de filtros en 100ms...');
  setTimeout(() => {
    console.log('🕰️ Aplicando filtros ahora...');
    applyCurrentFilters();
  }, 100);
}

// Create hardware card for grid view
function createHardwareCard(hardware) {
  try {
    console.log('🏗️ Creando card para hardware:', hardware);
    
    const div = document.createElement('div');
    div.className = 'ios-hardware-card hardware-item';
    
    // Extract nested data properly
    const datos = hardware.datos?.datos || hardware.datos || {};
    const status = datos.status || 'available';
    const stock = datos.stock || 0;
    
    console.log('📊 Datos extraídos:', { datos, status, stock });
    
    // Set data attributes for filtering
    div.setAttribute('data-type', hardware.tipo || '');
    div.setAttribute('data-status', status);
    div.setAttribute('data-name', (hardware.nombre || '').toLowerCase());
    div.setAttribute('data-brand', (datos.brand || '').toLowerCase());
    div.setAttribute('data-model', (datos.model || '').toLowerCase());
    div.setAttribute('data-sede', (hardware.sede || '').toLowerCase());
    div.setAttribute('data-stock', stock);
    div.setAttribute('data-activa', hardware.activa !== false ? 'true' : 'false');
    
    console.log('🔍 Atributos de filtro establecidos:', {
      'data-type': hardware.tipo || '',
      'data-status': status,
      'data-name': (hardware.nombre || '').toLowerCase(),
      'data-activa': hardware.activa !== false ? 'true' : 'false'
    });
    
    // Determine status display and iOS classes
    let statusClass = 'ios-status-available';
    let statusText = 'Disponible';
    
    if (stock === 0 || status === 'out_of_stock') {
      statusClass = 'ios-status-stock';
      statusText = 'Sin Stock';
    } else if (status === 'discontinued') {
      statusClass = 'ios-status-discontinued';
      statusText = 'Descontinuado';
    } else if (!hardware.activa) {
      statusClass = 'ios-status-discontinued';
      statusText = 'Inactivo';
    }
    
    div.innerHTML = `
      <div class="ios-card-header">
        <div class="ios-card-icon">
          <i class="fas fa-microchip"></i>
        </div>
        <span class="ios-status-badge ${statusClass}">
          ${statusText}
        </span>
      </div>
      
      <h3 class="ios-card-title">${hardware.nombre || 'Sin nombre'}</h3>
      <p class="ios-card-subtitle">${datos.brand || 'N/A'} • ${datos.model || 'N/A'}</p>
      
      <div class="ios-card-info">
        <div class="ios-info-item">
          <span class="ios-info-label">Precio</span>
          <span class="ios-info-value">$${datos.price || 0}</span>
        </div>
        <div class="ios-info-item">
          <span class="ios-info-label">Stock</span>
          <span class="ios-info-value">${stock}</span>
        </div>
        <div class="ios-info-item">
          <span class="ios-info-label">Tipo</span>
          <span class="ios-info-value">${hardware.tipo || 'N/A'}</span>
        </div>
        <div class="ios-info-item">
          <span class="ios-info-label">Estado</span>
          <span class="ios-info-value">${hardware.activa ? 'Activo' : 'Inactivo'}</span>
        </div>
      </div>
      
      <div class="ios-card-actions">
        <button class="ios-card-btn" onclick="viewHardware('${hardware._id}')" title="Ver detalles">
          <i class="fas fa-eye"></i>
        </button>
        <button class="ios-card-btn ios-card-btn-primary" onclick="editHardware('${hardware._id}')" title="Editar">
          <i class="fas fa-edit"></i>
        </button>
        <button class="ios-card-btn ${hardware.activa ? 'ios-card-btn-warning' : 'ios-card-btn-success'}" 
                onclick="toggleHardwareStatus('${hardware._id}', ${!hardware.activa})" 
                title="${hardware.activa ? 'Desactivar' : 'Activar'}">
          <i class="fas ${hardware.activa ? 'fa-power-off' : 'fa-play'}"></i>
        </button>
      </div>
      
      <!-- iOS Card Shimmer Effect -->
      <div class="ios-card-shimmer"></div>
    `;
    
    // Aplicar optimizaciones de performance a la tarjeta creada
    applyCardOptimizations(div);
    
    console.log('✅ Card creada exitosamente con optimizaciones');
    return div;
    
  } catch (error) {
    console.error('💥 Error creando card:', error);
    return null;
  }
}


// Update stats with real data
function updateStats(data) {
  // Update total items
  if (data.count !== undefined) {
    const totalElement = document.getElementById('totalItemsCount');
    if (totalElement) totalElement.textContent = data.count;
  }
  
  // Calculate and update other stats from the hardware list
  if (data.data && Array.isArray(data.data)) {
    const hardwareList = data.data;
    let availableCount = 0;
    let outOfStockCount = 0;
    let totalValue = 0;
    
    hardwareList.forEach(hardware => {
      const datos = hardware.datos?.datos || hardware.datos || {};
      const stock = datos.stock || 0;
      const price = datos.price || 0;
      const status = datos.status || 'available';
      
      // Count availability
      if (hardware.activa && stock > 0 && status !== 'discontinued') {
        availableCount++;
      } else if (stock === 0 || status === 'out_of_stock') {
        outOfStockCount++;
      }
      
      // Calculate total value
      totalValue += price * stock;
    });
    
    // Update DOM elements
    const availableElement = document.getElementById('availableItemsCount');
    const outOfStockElement = document.getElementById('outOfStockCount');
    const totalValueElement = document.getElementById('totalValueCount');
    
    if (availableElement) availableElement.textContent = availableCount;
    if (outOfStockElement) outOfStockElement.textContent = outOfStockCount;
    if (totalValueElement) totalValueElement.textContent = `$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
  }
}

// Load hardware types from backend
async function loadHardwareTypes() {
  try {
    const response = await apiClient.get_hardware_types();
    const data = await response.json();
    
    if (data.success) {
      console.log('Hardware types loaded:', data);
      populateTypeDropdowns(data.data);
    } else {
      console.error('Error loading hardware types:', data.errors);
    }
  } catch (error) {
    console.error('Error al cargar tipos de hardware:', error);
  }
}

// Load empresas from backend
async function loadEmpresas() {
  try {
    console.log('🏢 Cargando empresas desde /proxy/api/empresas...');
    const response = await apiClient.get_empresas();
    const data = await response.json();
    
    if (data.success) {
      console.log('🏢 Empresas cargadas:', data.count, 'empresas');
      console.log('🏢 Primera empresa (si existe):');
      if (data.data && data.data.length > 0) {
        console.log(JSON.stringify(data.data[0], null, 2));
      }
      // Store empresas for form usage
      window.empresas = data.data;
      // Populate empresa dropdown
      populateEmpresaDropdown(data.data);
    } else {
      console.error('❌ Error loading empresas:', data.errors);
    }
  } catch (error) {
    console.error('💥 Error al cargar empresas:', error);
  }
}

// Populate empresa dropdown with backend data
function populateEmpresaDropdown(empresas) {
  const empresaSelect = document.getElementById('hardwareEmpresa');
  
  if (!empresaSelect) {
    console.warn('⚠️ Elemento hardwareEmpresa no encontrado');
    return;
  }
  
  // Clear existing options (except the first "Select" option)
  empresaSelect.innerHTML = '<option value="">Seleccionar empresa</option>';
  
  empresas.forEach(empresa => {
    const option = document.createElement('option');
    option.value = empresa._id; // Use the empresa ID
    option.textContent = empresa.nombre;
    option.dataset.nombre = empresa.nombre; // Store nombre for form submission
    empresaSelect.appendChild(option);
  });
  
  console.log(`✅ ${empresas.length} empresas agregadas al dropdown`);
}

// Load sedes for selected empresa
function loadSedesByEmpresa() {
  const empresaSelect = document.getElementById('hardwareEmpresa');
  const sedeSelect = document.getElementById('hardwareSede');
  
  if (!empresaSelect || !sedeSelect) {
    console.warn('⚠️ Elementos de empresa o sede no encontrados');
    return;
  }
  
  const selectedEmpresaId = empresaSelect.value;
  
  // Reset sede dropdown
  sedeSelect.innerHTML = '<option value="">Seleccionar sede</option>';
  sedeSelect.disabled = true;
  
  if (!selectedEmpresaId) {
    console.log('🏢 No hay empresa seleccionada');
    return;
  }
  
  // Find selected empresa
  const selectedEmpresa = window.empresas?.find(emp => emp._id === selectedEmpresaId);
  
  if (!selectedEmpresa) {
    console.error('❌ Empresa seleccionada no encontrada:', selectedEmpresaId);
    return;
  }
  
  console.log('🏢 Empresa seleccionada:', selectedEmpresa);
  
  // Check if empresa has sedes
  if (selectedEmpresa.sedes && Array.isArray(selectedEmpresa.sedes)) {
    selectedEmpresa.sedes.forEach(sede => {
      const option = document.createElement('option');
      option.value = sede;
      option.textContent = sede;
      sedeSelect.appendChild(option);
    });
    
    sedeSelect.disabled = false;
    console.log(`✅ ${selectedEmpresa.sedes.length} sedes cargadas para ${selectedEmpresa.nombre}`);
  } else {
    // If no sedes array, create a default "Principal" option
    const defaultOption = document.createElement('option');
    defaultOption.value = 'Principal';
    defaultOption.textContent = 'Principal';
    sedeSelect.appendChild(defaultOption);
    
    sedeSelect.disabled = false;
    console.log('✅ Sede por defecto "Principal" agregada');
  }
}

// Populate type dropdowns with backend data
function populateTypeDropdowns(types) {
  const typeSelect = document.getElementById('hardwareType');
  const filterSelect = document.getElementById('typeFilter');
  
  // Clear existing options (except the first "Select" option)
  typeSelect.innerHTML = '<option value="">Seleccionar tipo</option>';
  filterSelect.innerHTML = '<option value="">Todos los tipos</option>';
  
  types.forEach(type => {
    const option1 = document.createElement('option');
    option1.value = type.nombre;
    option1.textContent = type.nombre;
    typeSelect.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = type.nombre;
    option2.textContent = type.nombre;
    filterSelect.appendChild(option2);
  });
}

// Form submission handling
document.getElementById('hardwareForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Get empresa and sede values
  const empresaSelect = document.getElementById('hardwareEmpresa');
  const sedeSelect = document.getElementById('hardwareSede');
  
  // Validate empresa and sede are selected
  if (!empresaSelect.value) {
    alert('Por favor selecciona una empresa');
    empresaSelect.focus();
    return;
  }
  
  if (!sedeSelect.value) {
    alert('Por favor selecciona una sede');
    sedeSelect.focus();
    return;
  }
  
  // Get empresa name from the selected option
  const selectedEmpresaOption = empresaSelect.options[empresaSelect.selectedIndex];
  const empresaNombre = selectedEmpresaOption.dataset.nombre || selectedEmpresaOption.textContent;
  
  const formData = {
    nombre: document.getElementById('hardwareName').value,
    tipo: document.getElementById('hardwareType').value,
    empresa_id: empresaSelect.value, // Send empresa ID
    empresa_nombre: empresaNombre, // Send empresa name
    sede: sedeSelect.value, // Send selected sede
    datos: {
      datos: { // Note the nested structure to match your backend
        brand: document.getElementById('hardwareBrand').value,
        model: document.getElementById('hardwareModel').value,
        price: parseFloat(document.getElementById('hardwarePrice').value),
        stock: parseInt(document.getElementById('hardwareStock').value),
        status: document.getElementById('hardwareStatus').value,
        warranty: parseInt(document.getElementById('hardwareWarranty').value),
        description: document.getElementById('hardwareDescription').value
      }
    }
  };
  
  console.log('📤 Enviando datos de hardware:', formData);
  
  if (editingHardware) {
    updateHardwareAPI(editingHardware, formData);
  } else {
    createHardwareAPI(formData);
  }
});

// Filter functionality
function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('typeFilter').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('includeInactiveFilter').value = 'active';
  
  // Remove any filter empty messages
  const filterEmptyMessage = document.getElementById('filterEmptyMessage');
  if (filterEmptyMessage) {
    filterEmptyMessage.remove();
  }
  
  // Reload hardware data with new filter
  loadHardware();
}

function filterHardware() {
  console.log('🚀 === INICIANDO FILTRO DE HARDWARE ===');
  
  const searchInput = document.getElementById('searchInput');
  const typeFilterEl = document.getElementById('typeFilter');
  const statusFilterEl = document.getElementById('statusFilter');
  
  if (!searchInput || !typeFilterEl || !statusFilterEl) {
    console.error('❌ Elementos de filtro no encontrados:');
    console.error('  - searchInput:', searchInput ? 'SI' : 'NO');
    console.error('  - typeFilter:', typeFilterEl ? 'SI' : 'NO');
    console.error('  - statusFilter:', statusFilterEl ? 'SI' : 'NO');
    return;
  }
  
  const search = searchInput.value.toLowerCase();
  const type = typeFilterEl.value;
  const status = statusFilterEl.value;
  
  console.log('🔍 Valores de filtros:');
  console.log('  - search:', search);
  console.log('  - type:', type);
  console.log('  - status:', status);
  
  // Filtrar elementos del grid
  const gridItems = document.querySelectorAll('.hardware-item');
  const allItems = [...gridItems];
  let visibleCount = 0;
  
  console.log(`🔍 Elementos encontrados:`);
  console.log(`  - Grid items (.hardware-item): ${gridItems.length}`);
  console.log(`  - Total elementos: ${allItems.length}`);
  
  if (allItems.length === 0) {
    console.error('❌ NO HAY ELEMENTOS DE HARDWARE EN EL DOM!');
    console.log('🔍 Verificando contenedor de hardware...');
    const gridContainer = document.getElementById('hardwareGrid');
    console.log('  - gridContainer children:', gridContainer ? gridContainer.children.length : 'NO ENCONTRADO');
    return;
  }
  
  allItems.forEach((item, index) => {
    const name = item.dataset.name || '';
    const itemType = item.dataset.type || '';
    const itemStatus = item.dataset.status || '';
    const stock = parseInt(item.dataset.stock || '0');
    const activa = item.dataset.activa === 'true';
    
    // Enhanced search - matches name, type, brand, model, or sede
    const brand = item.dataset.brand || '';
    const model = item.dataset.model || '';
    const sede = item.dataset.sede || '';
    
    const matchesSearch = !search || 
      name.includes(search) || 
      itemType.toLowerCase().includes(search) ||
      brand.includes(search) ||
      model.includes(search) ||
      sede.includes(search);
    
    // Type filter
    const matchesType = !type || itemType === type;
    
    // Status filter logic
    let matchesStatus = true;
    if (status) {
      switch (status) {
        case 'available':
          matchesStatus = activa && stock > 0 && itemStatus !== 'discontinued';
          break;
        case 'out_of_stock':
          matchesStatus = stock === 0 || itemStatus === 'out_of_stock';
          break;
        case 'discontinued':
          matchesStatus = itemStatus === 'discontinued';
          break;
        case 'inactive':
          matchesStatus = !activa;
          break;
      }
    }
    
    // Show/hide item
    if (matchesSearch && matchesType && matchesStatus) {
      item.style.display = '';
      item.classList.remove('hidden');
      visibleCount++;
      console.log(`✅ Elemento ${index + 1} visible: ${name}`);
    } else {
      item.style.display = 'none';
      item.classList.add('hidden');
      console.log(`❌ Elemento ${index + 1} oculto: ${name}`);
    }
  });
  
  console.log(`📊 Filtrado completado: ${visibleCount} de ${allItems.length} elementos visibles`);
  
  // Show/hide empty message for filters
  showFilterEmptyMessage(visibleCount);
  
  // Update filter status message
  updateFilterStatus(visibleCount, gridItems.length); // Solo contar grid items para el status
}

// Show empty message when filters return no results
function showFilterEmptyMessage(visibleCount) {
  const hasFilters = document.getElementById('searchInput').value || 
                    document.getElementById('typeFilter').value || 
                    document.getElementById('statusFilter').value;
  
  // Remove existing empty message
  const existingEmptyMessage = document.getElementById('filterEmptyMessage');
  if (existingEmptyMessage) {
    existingEmptyMessage.remove();
  }
  
  // Show empty message if filters are applied and no results
  if (hasFilters && visibleCount === 0) {
    const gridContainer = document.getElementById('hardwareGrid');
    
    // Create empty message for grid
    const emptyMessage = document.createElement('div');
    emptyMessage.id = 'filterEmptyMessage';
    emptyMessage.className = 'col-span-full text-center py-8';
    emptyMessage.innerHTML = `
      <div class="text-center">
        <i class="fas fa-search text-4xl mb-4 text-gray-400"></i>
        <h2 class="text-2xl font-bold text-white mb-2">No se encontró hardware con este filtro</h2>
        <p class="text-sm text-gray-400">Prueba ajustando los criterios de búsqueda.</p>
        <button onclick="clearFilters()" class="mt-4 btn-secondary">
          <i class="fas fa-filter-circle-xmark"></i>
          Limpiar Filtros
        </button>
      </div>
    `;
    gridContainer.appendChild(emptyMessage);
  }
}

// Update filter status message
function updateFilterStatus(visibleCount, totalCount) {
  const hasFilters = document.getElementById('searchInput').value || 
                    document.getElementById('typeFilter').value || 
                    document.getElementById('statusFilter').value;
  
  // You can add a status message here if needed
  if (hasFilters && visibleCount !== totalCount) {
    console.log(`Filtering: ${visibleCount} of ${totalCount} items shown`);
  }
}

// Helper function to apply current filters (without triggering events)
function applyCurrentFilters() {
  console.log('🔄 Aplicando filtros actuales...');
  filterHardware();
}

// Función de recarga manual para debugging
function reloadHardwareManual() {
  console.log('🔄 RECARGA MANUAL DE HARDWARE INICIADA');
  isLoadingHardware = false; // Reset flag
  loadHardware();
}

// Exponer función para uso en consola
window.reloadHardwareManual = reloadHardwareManual;

// Initialize filter event listeners only once
let filtersInitialized = false;

function initializeFilterListeners() {
  if (filtersInitialized) {
    console.log('⚠️ Event listeners ya inicializados, saltando...');
    return;
  }
  
  console.log('🎯 Inicializando event listeners de filtros...');
  
  const searchInput = document.getElementById('searchInput');
  const typeFilter = document.getElementById('typeFilter');
  const statusFilter = document.getElementById('statusFilter');
  const includeInactiveFilter = document.getElementById('includeInactiveFilter');
  
  console.log('🔍 Elementos encontrados:');
  console.log('  - searchInput:', searchInput ? 'SI' : 'NO');
  console.log('  - typeFilter:', typeFilter ? 'SI' : 'NO');
  console.log('  - statusFilter:', statusFilter ? 'SI' : 'NO');
  console.log('  - includeInactiveFilter:', includeInactiveFilter ? 'SI' : 'NO');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      console.log('🔍 TRIGGER: searchInput changed to:', searchInput.value);
      filterHardware();
    });
  } else {
    console.error('❌ No se encontró searchInput');
  }
  
  if (typeFilter) {
    typeFilter.addEventListener('change', function() {
      console.log('🔍 TRIGGER: typeFilter changed to:', typeFilter.value);
      filterHardware();
    });
  } else {
    console.error('❌ No se encontró typeFilter');
  }
  
  if (statusFilter) {
    statusFilter.addEventListener('change', function() {
      console.log('🔍 TRIGGER: statusFilter changed to:', statusFilter.value);
      filterHardware();
    });
  } else {
    console.error('❌ No se encontró statusFilter');
  }
  
  if (includeInactiveFilter) {
    includeInactiveFilter.addEventListener('change', function() {
      console.log('🔍 TRIGGER: includeInactiveFilter changed to:', includeInactiveFilter.value);
      // When this filter changes, we need to reload the data, not just filter the UI
      loadHardware();
    });
  } else {
    console.error('❌ No se encontró includeInactiveFilter');
  }
  
  filtersInitialized = true;
  console.log('✅ Event listeners de filtros inicializados');
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', initializeFilterListeners);

// Close modal when clicking outside
document.getElementById('hardwareModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

// Close view modal when clicking outside
document.getElementById('viewHardwareModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeViewModal();
  }
});

// Close toggle modal when clicking outside
document.getElementById('toggleHardwareModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeToggleModal();
  }
});

// Close client update modal when clicking outside
document.getElementById('clientUpdateModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeUpdateModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Check which modal is open and close it
    const hardwareModal = document.getElementById('hardwareModal');
    const viewModal = document.getElementById('viewHardwareModal');
    const toggleModal = document.getElementById('toggleHardwareModal');
    const updateModal = document.getElementById('clientUpdateModal');
    
    if (!hardwareModal.classList.contains('hidden')) {
      closeModal();
    } else if (!viewModal.classList.contains('hidden')) {
      closeViewModal();
    } else if (!toggleModal.classList.contains('hidden')) {
      closeToggleModal();
    } else if (!updateModal.classList.contains('hidden')) {
      closeUpdateModal();
    }
  }
});
</script>
{% endblock %}
