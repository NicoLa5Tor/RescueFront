{% extends "base.html" %}
{% block title %}Dashboard - Sistema Multi-Tenant{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  .glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .gradient-bg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .stats-card {
    transition: all 0.3s ease;
  }
  
  .stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  
  .sidebar-link {
    transition: all 0.3s ease;
  }
  
  .sidebar-link:hover {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }
  
  .sidebar-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .chart-container {
    position: relative;
    height: 300px;
  }

  @media (max-width: 768px) {
    .chart-container {
      height: 200px;
    }
  }
</style>
{% endblock %}

{% block navbar %}
<!-- Top Navigation -->
<nav class="bg-white shadow-sm border-b border-gray-200 fixed w-full top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <div class="flex items-center">
        <div class="flex items-center space-x-3">
          <i class="fas fa-shield-alt text-2xl text-blue-600"></i>
          <span class="text-xl font-bold text-gray-900">Rescue Dashboard</span>
        </div>
      </div>
      
      <!-- User Menu -->
      <div class="flex items-center space-x-4">
        <!-- Notifications -->
        <button class="relative p-2 text-gray-600 hover:text-blue-600 transition-colors">
          <i class="fas fa-bell"></i>
          <span class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-400"></span>
        </button>
        
        <!-- Refresh Button -->
        <button class="refresh-btn p-2 text-gray-600 hover:text-blue-600 transition-colors" title="Actualizar datos">
          <i class="fas fa-sync-alt"></i>
        </button>
        
        <!-- User Dropdown -->
        <div class="relative">
          <button class="user-info-btn flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
              <span class="text-white text-sm font-medium user-initials">U</span>
            </div>
            <div class="hidden md:block text-left">
              <p class="text-sm font-medium text-gray-900 user-name">Usuario</p>
              <p class="text-xs text-gray-500 user-role">Rol</p>
            </div>
            <i class="fas fa-chevron-down text-xs text-gray-400"></i>
          </button>
        </div>
        
        <!-- Logout -->
        <button class="logout-btn p-2 text-red-600 hover:text-red-700 transition-colors" title="Cerrar sesión">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pt-16">
  <!-- Sidebar -->
  <div class="fixed inset-y-0 left-0 z-40 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0" id="sidebar">
    <div class="flex items-center justify-center h-16 bg-gradient-to-r from-blue-600 to-purple-600">
      <span class="text-white text-lg font-semibold">Menú Principal</span>
    </div>
    
    <nav class="mt-8">
      <div class="px-4 space-y-2">
        <!-- Dashboard -->
        <a href="/admin" class="sidebar-link active flex items-center px-4 py-3 text-gray-700 rounded-lg">
          <i class="fas fa-tachometer-alt mr-3"></i>
          Dashboard
        </a>
        
        <!-- Empresas (solo admins) -->
        <a href="/admin/empresas" class="sidebar-link admin-only flex items-center px-4 py-3 text-gray-700 rounded-lg">
          <i class="fas fa-building mr-3"></i>
          Empresas
        </a>
        
        <!-- Usuarios -->
        <a href="/admin/users" class="sidebar-link flex items-center px-4 py-3 text-gray-700 rounded-lg">
          <i class="fas fa-users mr-3"></i>
          Usuarios
        </a>
        
        <!-- Estadísticas -->
        <a href="/admin/stats" class="sidebar-link flex items-center px-4 py-3 text-gray-700 rounded-lg">
          <i class="fas fa-chart-bar mr-3"></i>
          Estadísticas
        </a>
      </div>
      
      <!-- Selector de Empresa (solo para admins) -->
      <div class="admin-only px-4 mt-8">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Empresa Actual</h3>
        <select id="sidebarEmpresaSelector" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="">Seleccionar empresa...</option>
        </select>
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="lg:pl-64">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
        <p class="text-gray-600 mt-2">Resumen general del sistema</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Empresas (solo admins) -->
        <div class="admin-only stats-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 mb-1">Total Empresas</p>
              <p class="text-3xl font-bold text-gray-900" id="totalEmpresasCount">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-building text-blue-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 flex items-center text-sm">
            <span class="text-green-600 font-medium" id="activeEmpresasCount">0</span>
            <span class="text-gray-500 ml-1">activas</span>
          </div>
        </div>

        <!-- Total Usuarios -->
        <div class="stats-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 mb-1">Total Usuarios</p>
              <p class="text-3xl font-bold text-gray-900" id="totalUsersCount">0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-users text-green-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 flex items-center text-sm">
            <span class="text-green-600 font-medium" id="activeUsersCount">0</span>
            <span class="text-gray-500 ml-1">activos</span>
          </div>
        </div>

        <!-- Empresa Actual (solo empresas) -->
        <div class="empresa-only stats-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 mb-1">Mi Empresa</p>
              <p class="text-lg font-bold text-gray-900" id="empresaName">-</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-home text-purple-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 flex items-center text-sm">
            <span class="text-purple-600 font-medium" id="empresaUsersCount">0</span>
            <span class="text-gray-500 ml-1">usuarios</span>
          </div>
        </div>

        <!-- Promedio (solo admins) -->
        <div class="admin-only stats-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 mb-1">Promedio</p>
              <p class="text-3xl font-bold text-gray-900" id="avgUsersPerCompany">0</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-orange-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 flex items-center text-sm">
            <span class="text-gray-500">usuarios por empresa</span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- Activity Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Actividad Reciente</h3>
            <div class="flex space-x-2">
              <button class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-download"></i>
              </button>
              <button class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="dashboardChart"></canvas>
          </div>
        </div>

        <!-- Distribution Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Distribución</h3>
            <div class="flex space-x-2">
              <button class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-download"></i>
              </button>
              <button class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Recent Companies (admin only) -->
        <div class="admin-only bg-white rounded-xl shadow-sm border border-gray-200">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-gray-900">Empresas Recientes</h3>
              <a href="/admin/empresas" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Ver todas</a>
            </div>
          </div>
          <div class="p-6">
            <div id="recentEmpresasContainer" class="space-y-4">
              <!-- Empresas recientes se cargarán aquí -->
            </div>
          </div>
        </div>

        <!-- Recent Users -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-gray-900">Usuarios Recientes</h3>
              <a href="/admin/users" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Ver todos</a>
            </div>
          </div>
          <div class="p-6">
            <div id="recentUsersContainer" class="space-y-4">
              <!-- Usuarios recientes se cargarán aquí -->
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="mt-8 bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Acciones Rápidas</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          
          <button class="super-admin-only p-4 border-2 border-dashed border-blue-300 rounded-lg text-center hover:border-blue-400 hover:bg-blue-50 transition-colors" onclick="createEmpresa()">
            <i class="fas fa-plus-circle text-blue-600 text-2xl mb-2"></i>
            <p class="text-sm font-medium text-blue-600">Crear Empresa</p>
          </button>
          
          <button class="p-4 border-2 border-dashed border-green-300 rounded-lg text-center hover:border-green-400 hover:bg-green-50 transition-colors" onclick="createUser()">
            <i class="fas fa-user-plus text-green-600 text-2xl mb-2"></i>
            <p class="text-sm font-medium text-green-600">Crear Usuario</p>
          </button>
          
          <button class="p-4 border-2 border-dashed border-purple-300 rounded-lg text-center hover:border-purple-400 hover:bg-purple-50 transition-colors" onclick="generateReport()">
            <i class="fas fa-file-alt text-purple-600 text-2xl mb-2"></i>
            <p class="text-sm font-medium text-purple-600">Generar Reporte</p>
          </button>
          
          <button class="p-4 border-2 border-dashed border-orange-300 rounded-lg text-center hover:border-orange-400 hover:bg-orange-50 transition-colors" onclick="showSystemInfo()">
            <i class="fas fa-info-circle text-orange-600 text-2xl mb-2"></i>
            <p class="text-sm font-medium text-orange-600">Info Sistema</p>
          </button>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Sidebar Overlay -->
<div class="lg:hidden fixed inset-0 z-30 bg-black bg-opacity-50 hidden" id="sidebarOverlay"></div>

<!-- Mobile Menu Button -->
<button class="lg:hidden fixed bottom-4 right-4 z-50 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-colors" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>window.API_BASE_URL = '{{ api_url }}';</script>
<script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/models.js') }}"></script>         <!-- ✅ -->
<script src="{{ url_for('static', filename='js/api-client.js') }}"></script>    <!-- ✅ -->
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>         <!-- ✅ -->
<script>
// Mobile sidebar toggle
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('-translate-x-full');
  overlay.classList.toggle('hidden');
}

// Close sidebar when clicking overlay
document.getElementById('sidebarOverlay')?.addEventListener('click', toggleSidebar);

// Quick actions
function generateReport() {
  showNotification('Funcionalidad de reportes en desarrollo', 'info');
}

function showSystemInfo() {
  Swal.fire({
    title: 'Información del Sistema',
    html: `
      <div class="text-left">
        <p><strong>Versión:</strong> 1.0.0</p>
        <p><strong>Entorno:</strong> Desarrollo</p>
        <p><strong>Base de datos:</strong> MongoDB</p>
        <p><strong>Última actualización:</strong> ${new Date().toLocaleDateString()}</p>
      </div>
    `,
    icon: 'info',
    confirmButtonText: 'Cerrar'
  });
}

// Update sidebar empresa selector
async function updateSidebarEmpresaSelector() {
  const selector = document.getElementById('sidebarEmpresaSelector');
  if (!selector || !window.apiClient) return;

  try {
    const currentUser = window.apiClient.getCurrentUser();
    if (!currentUser?.isAdmin()) return;

    const empresas = await window.apiClient.getEmpresas();
    const selectedEmpresa = window.apiClient.getSelectedEmpresaId();
    
    selector.innerHTML = `
      <option value="">Todas las empresas</option>
      ${empresas.map(empresa => `
        <option value="${empresa.id}" ${empresa.id === selectedEmpresa ? 'selected' : ''}>
          ${empresa.nombre}
        </option>
      `).join('')}
    `;

    selector.addEventListener('change', (e) => {
      const empresaId = e.target.value;
      if (empresaId) {
        window.apiClient.setSelectedEmpresa(empresaId);
        showNotification('Empresa seleccionada: ' + empresas.find(e => e.id === empresaId)?.nombre, 'success');
      } else {
        window.apiClient.clearSelectedEmpresa();
        showNotification('Viendo todas las empresas', 'info');
      }
    });

  } catch (error) {
    console.error('Error updating sidebar selector:', error);
  }
}

// Initialize sidebar selector when page loads
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(updateSidebarEmpresaSelector, 1000);
});
</script>
{% endblock %}

{% block footer %}{% endblock %}
