{% extends "base.html" %}
{% block title %}Dashboard - Sistema Multi-Tenant{% endblock %}

{% block extra_css %}
<!-- External Libraries -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- Dashboard CSS (in order) -->
<link href="{{ url_for('static', filename='css/dashboard/main-layout.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard/variables.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard/base.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard/navbar.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard/sidebar.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard/animations.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard/cards.css') }}" rel="stylesheet">
{% endblock %}

{% block navbar %}
<nav class="navbar">
  <div class="navbar__container">
    <!-- Left Section -->
    <div class="navbar__left">
      <button class="navbar__menu-toggle" aria-label="Toggle menu">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="navbar__logo">
        <div class="navbar__logo-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="navbar__logo-text">
          <h1 class="navbar__logo-title">Rescue Dashboard</h1>
          <p class="navbar__logo-subtitle">Sistema Multi-Tenant</p>
        </div>
      </div>
    </div>
    
    <!-- Center Section -->
    <div class="navbar__center">
      <div class="navbar__search">
        <input type="text" class="navbar__search-input" placeholder="Buscar...">
        <button class="navbar__search-button" aria-label="Search">
          <i class="fas fa-search"></i>
        </button>
      </div>
      <button class="navbar__search-mobile" aria-label="Search">
        <i class="fas fa-search"></i>
      </button>
    </div>
    
    <!-- Right Section -->
    <div class="navbar__right">
      <button class="navbar__action" aria-label="Notifications">
        <i class="fas fa-bell"></i>
        <span class="navbar__notification-badge"></span>
      </button>
      
      <button class="navbar__action navbar__theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
      
      <button class="navbar__user">
        <div class="navbar__user-avatar">
          <span class="user-initials">AD</span>
        </div>
        <div class="navbar__user-info">
          <p class="navbar__user-name">Admin</p>
          <p class="navbar__user-role">Administrador</p>
        </div>
        <i class="fas fa-chevron-down navbar__user-chevron"></i>
      </button>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<!-- Animated Background -->
<div class="animated-bg"></div>

<div class="min-h-screen pt-16 sm:pt-20">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar__content">
      <!-- User Profile -->
      <div class="sidebar__profile">
        <div class="sidebar__profile-content">
          <div class="sidebar__profile-avatar">
            <span class="user-initials">AD</span>
          </div>
          <div class="sidebar__profile-info">
            <p class="sidebar__profile-name">Admin Principal</p>
            <p class="sidebar__profile-role">Super Admin</p>
          </div>
        </div>
      </div>
      
      <!-- Navigation -->
      <nav class="sidebar__nav">
        <div class="sidebar__nav-section">
          <div class="sidebar__nav-list" id="sidebarNav">
            <!-- Navigation items will be populated by JS -->
          </div>
        </div>
      </nav>
      
      <!-- Company Selector -->
      <div class="sidebar__company-selector admin-only">
        <label class="sidebar__company-label">Empresa Actual</label>
        <select id="sidebarEmpresaSelector" class="sidebar__company-select">
          <option value="">Todas las empresas</option>
        </select>
      </div>
      
      <!-- Logout -->
      <div class="sidebar__logout">
        <button class="sidebar__logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Cerrar Sesi√≥n</span>
        </button>
      </div>
    </div>
  </aside>

  <!-- Sidebar Overlay -->
  <div class="sidebar__overlay" id="sidebarOverlay"></div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <div class="mb-8 gsap-fade-in">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
        <div>
          <h1 class="text-2xl sm:text-4xl font-bold text-gray-900 dark:text-white">
            Bienvenido de vuelta üëã
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">Resumen de tu sistema hoy</p>
        </div>
        <div class="flex flex-col xs:flex-row space-y-2 xs:space-y-0 xs:space-x-3">
          <button class="btn-secondary">
            <i class="fas fa-calendar-alt"></i>
            <span class="hidden xs:inline">√öltimos 30 d√≠as</span>
            <span class="xs:hidden">30 d√≠as</span>
          </button>
          <button class="btn-primary">
            <i class="fas fa-download"></i>
            Exportar
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 mb-8" id="statsGrid">
      <div class="glass-card p-4 text-center">
        <p class="text-sm text-gray-500">Total Empresas</p>
        <p id="totalEmpresasCount" class="text-2xl font-bold">0</p>
        <p class="text-xs text-gray-500">Activas <span id="activeEmpresasCount">0</span></p>
      </div>
      <div class="glass-card p-4 text-center">
        <p class="text-sm text-gray-500">Total Usuarios</p>
        <p id="totalUsersCount" class="text-2xl font-bold">0</p>
        <p class="text-xs text-gray-500">Activos <span id="activeUsersCount">0</span></p>
      </div>
      <div class="glass-card p-4 text-center">
        <p class="text-sm text-gray-500">Empresa</p>
        <p id="empresaInfoCount" class="text-2xl font-bold">-</p>
        <p class="text-xs text-gray-500">Miembros <span id="empresaMembersCount">0</span></p>
      </div>
      <div class="glass-card p-4 text-center">
        <p class="text-sm text-gray-500">Rendimiento</p>
        <p id="performanceCount" class="text-2xl font-bold">0</p>
        <p class="text-xs text-gray-500">Promedio <span id="avgPerformanceCount">0</span></p>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
      <!-- Main Chart -->
      <div class="xl:col-span-2 glass-card chart-card">
        <div class="chart-header">
          <div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Actividad de Empresas</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Rendimiento por empresa</p>
          </div>
          <div class="chart-controls">
            <button class="chart-control-btn" onclick="refreshChart('dashboardChart')" aria-label="Refresh chart">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button class="chart-control-btn" onclick="expandChart('dashboardChart')" aria-label="Expand chart">
              <i class="fas fa-expand"></i>
            </button>
            <button class="chart-control-btn" onclick="downloadChart('dashboardChart')" aria-label="Download chart">
              <i class="fas fa-download"></i>
            </button>
          </div>
        </div>
        <div class="p-6">
          <div class="h-64 sm:h-80">
            <canvas id="dashboardChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Distribution Chart -->
      <div class="glass-card chart-card">
        <div class="chart-header">
          <div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Distribuci√≥n</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Por categor√≠as</p>
          </div>
          <div class="chart-controls">
            <button class="chart-control-btn" onclick="refreshChart('distributionChart')" aria-label="Refresh chart">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        <div class="p-6">
          <div class="h-64 sm:h-80">
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Lists -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
      <!-- Recent Companies -->
      <div class="glass-card admin-only">
        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl font-bold text-gray-900 dark:text-white">Empresas Recientes</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">√öltimas incorporaciones</p>
            </div>
            <a href="/admin/empresas" class="text-purple-600 hover:text-purple-700 font-medium">
              Ver todas <i class="fas fa-arrow-right ml-1"></i>
            </a>
          </div>
        </div>
        <div class="p-6">
          <div id="recentEmpresasContainer">
            <!-- Loading skeleton -->
            <div class="space-y-4">
              <div class="skeleton h-16 rounded-lg"></div>
              <div class="skeleton h-16 rounded-lg"></div>
              <div class="skeleton h-16 rounded-lg"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Users -->
      <div class="glass-card">
        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl font-bold text-gray-900 dark:text-white">Usuarios Recientes</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Nuevos miembros</p>
            </div>
            <a href="/admin/users" class="text-purple-600 hover:text-purple-700 font-medium">
              Ver todos <i class="fas fa-arrow-right ml-1"></i>
            </a>
          </div>
        </div>
        <div class="p-6">
          <div id="recentUsersContainer">
            <!-- Loading skeleton -->
            <div class="space-y-4">
              <div class="skeleton h-16 rounded-lg"></div>
              <div class="skeleton h-16 rounded-lg"></div>
              <div class="skeleton h-16 rounded-lg"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="glass-card p-6">
      <div class="mb-6">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Acciones R√°pidas</h3>
        <p class="text-gray-600 dark:text-gray-400">Funciones m√°s utilizadas</p>
      </div>
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="quickActionsGrid">
        <!-- Quick action buttons will be populated by JS -->
        <div class="skeleton h-32 rounded-xl"></div>
        <div class="skeleton h-32 rounded-xl"></div>
        <div class="skeleton h-32 rounded-xl"></div>
        <div class="skeleton h-32 rounded-xl"></div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- API Configuration -->
<script>
  window.API_BASE_URL = '{{ api_url }}';
  window.ACTIVITY_DATA = {{ activity_data | tojson | safe }};
  // Initialize theme from localStorage
  (function() {
    const savedTheme = localStorage.getItem('theme');
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDark = savedTheme === 'dark' || (!savedTheme && systemDark);
    
    if (isDark) {
      document.documentElement.classList.add('dark');
    }
  })();
</script>

<!-- Core Scripts -->
<script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/models.js') }}"></script>
<script src="{{ url_for('static', filename='js/api-client.js') }}"></script>

<!-- Dashboard Core -->
<script src="{{ url_for('static', filename='js/dashboard/sidebar-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard/basic-managers.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard/dashboard-core.js') }}"></script>

<!-- Main Dashboard Script -->
<script src="{{ url_for('static', filename='js/dashboard/dashboard.js') }}"></script>

<!-- Quick Actions (can be moved to separate file) -->
<script>
// Quick action functions
function createEmpresa() {
  if (window.dashboard?.handleQuickAction) {
    window.dashboard.handleQuickAction('create-empresa');
  }
}

function createUser() {
  if (window.dashboard?.handleQuickAction) {
    window.dashboard.handleQuickAction('create-user');
  }
}

function generateReport() {
  if (window.dashboard?.handleQuickAction) {
    window.dashboard.handleQuickAction('generate-report');
  }
}

function showSystemInfo() {
  if (window.dashboard?.handleQuickAction) {
    window.dashboard.handleQuickAction('system-info');
  }
}

function refreshChart(chartId) {
  if (window.dashboard?.charts) {
    window.dashboard.charts.refresh(chartId);
  }
}

function expandChart(chartId) {
  if (window.dashboard?.charts) {
    window.dashboard.charts.expand(chartId);
  }
}

function downloadChart(chartId) {
  if (window.dashboard?.charts) {
    window.dashboard.charts.download(chartId);
  }
}
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('dashboardChart');
    if (!ctx || typeof Chart === 'undefined') return;
    const data = window.ACTIVITY_DATA || {};
    const labels = (data.labels && data.labels.length) ? data.labels : ['Sin datos'];
    const values = (data.values && data.values.length) ? data.values : [0];
    const label = data.label || 'Actividad';
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, ctx.height || 200);
    gradient.addColorStop(0, 'rgba(147, 51, 234, 0.4)');
    gradient.addColorStop(1, 'rgba(147, 51, 234, 0.01)');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: values,
          borderColor: 'rgb(147, 51, 234)',
          backgroundColor: gradient,
          tension: 0.4,
          fill: true
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  });
</script>
{% endblock %}

{% block footer %}{% endblock %}