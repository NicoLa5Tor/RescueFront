{% extends "admin/dashboard.html" %}

{% block title %}Imágenes - Rescue{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="{{ url_for('static', filename='css/modals.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/hardware/hardware-main.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/imagenes/imagenes-main.css') }}" rel="stylesheet">
<style>
@media (min-width: 1024px) {
  .main-content {
    margin-left: var(--sidebar-width) !important;
    width: calc(100% - var(--sidebar-width)) !important;
  }
}

@media (min-width: 1200px) {
  .main-content {
    margin-left: calc(var(--sidebar-width) + 2rem) !important;
    width: calc(100% - var(--sidebar-width) - 2rem) !important;
  }
}
</style>
{% endblock %}

{% block page_js %}
<script id="dashboardData" type="application/json">{}</script>
<script id="imageFoldersData" type="application/json">{{ images_data.folders | tojson }}</script>
<script>
  window.DASHBOARD_DATA = {};
  window.IMAGE_FOLDERS = {{ images_data.folders | tojson }};
</script>
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/imagenes/imagenes-viewer.js') }}"></script>
{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="ios-header-container mb-8">
    <div class="ios-header-backdrop">
      <div class="ios-header-content">
        <div class="ios-header-text">
          <div class="ios-header-icon">
            <i class="fas fa-images"></i>
          </div>
          <div>
            <h1 class="ios-header-title">Biblioteca de Imágenes</h1>
            <p class="ios-header-subtitle">Lista sincronizada de carpetas desde el servicio multimedia</p>
          </div>
        </div>
        <div class="ios-header-actions">
          <span class="ios-header-pill">
            <i class="fas fa-link"></i>
            <a href="{{ images_data.service_url }}" class="hover:underline" target="_blank" rel="noopener">origen del servicio</a>
          </span>
          <button type="button" id="openCreateFolderModal" class="ios-blur-btn ios-blur-btn-secondary" data-create-url="{{ url_for('admin_create_image_folder') }}">
            <i class="fas fa-folder-plus"></i>
            <span>Crear directorio</span>
          </button>
          <button type="button" id="openUploadModal" class="ios-blur-btn ios-blur-btn-primary">
            <i class="fas fa-plus"></i>
            <span>Agregar archivo</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  {% if images_data.error %}
  <div class="ios-alert ios-alert-warning mb-6">
    <i class="fas fa-triangle-exclamation"></i>
    <span>{{ images_data.error }}</span>
  </div>
  {% endif %}

  <div class="ios-filters-container ios-blur-bg mb-6">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div>
        <p class="text-sm text-white/70 dark:text-gray-300">Carpetas detectadas</p>
        <p class="text-2xl font-semibold text-white"><span data-folder-count>{{ images_data.folders | length }}</span> disponibles</p>
      </div>
      <div class="ios-header-pill">
        <i class="fas fa-rotate"></i>
        <span>Actualiza para reflejar cambios</span>
      </div>
    </div>
  </div>

  <div
    class="ios-hardware-grid ios-folder-grid"
    data-folder-grid
    data-fetch-template="{{ url_for('admin_imagenes_folder_files', folder_name='__FOLDER__') }}"
    data-delete-template="{{ url_for('admin_delete_image_folder', folder_name='__FOLDER__') }}"
  >
    {% if images_data.folders %}
      {% for folder in images_data.folders %}
      <article class="ios-hardware-card ios-folder-card force-visible" data-folder-card="{{ folder.name }}">
        <header class="ios-folder-header">
          <div class="ios-folder-avatar">{{ folder.initials }}</div>
          <div class="ios-folder-badge">
            <i class="fas fa-folder"></i>
            <span>Carpeta</span>
          </div>
        </header>
        <div class="ios-folder-body">
          <h3 class="ios-folder-title">{{ folder.display_name }}</h3>
          <p class="ios-folder-subtitle">{{ folder.name }}</p>
        </div>
        <footer class="ios-folder-footer">
          <div class="ios-folder-actions">
            <button
              type="button"
              class="ios-action-btn ios-action-btn-secondary view-folder-btn"
              data-folder="{{ folder.name }}"
              data-folder-display="{{ folder.display_name }}"
              data-fetch-url="{{ url_for('admin_imagenes_folder_files', folder_name=folder.name) }}"
            >
              <i class="fas fa-eye"></i>
              <span>Ver archivos</span>
            </button>
            <button
              type="button"
              class="ios-icon-btn delete-folder-btn"
              aria-label="Eliminar carpeta {{ folder.display_name }}"
              data-folder="{{ folder.name }}"
              data-folder-display="{{ folder.display_name }}"
              data-delete-url="{{ url_for('admin_delete_image_folder', folder_name=folder.name) }}"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </footer>
      </article>
      {% endfor %}
    {% else %}
      <div class="col-span-full">
        <div class="ios-empty-state">
          <div class="ios-empty-icon"><i class="fas fa-folder-open"></i></div>
          <h3 class="ios-empty-title">Sin carpetas disponibles</h3>
          <p class="ios-empty-subtitle">Confirma que el servicio esté en línea y vuelve a intentarlo.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<div id="viewFolderModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-3xl">
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-sky-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-eye text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white" id="viewFolderModalTitle">Carpeta seleccionada</h3>
            <p class="text-sm text-white/70">Archivos disponibles en la carpeta sincronizada</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" data-modal-close aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    <div class="ios-blur-body space-y-6">
      <div id="folderFilesStatus" class="ios-folder-status hidden" aria-live="polite">
        <i id="folderFilesStatusIcon" class="fas fa-circle-info"></i>
        <span id="folderFilesStatusText"></span>
      </div>
      <p class="text-sm text-white/60 hidden" id="viewFolderModalCounter"></p>
      <div id="folderFilesGrid" class="ios-folder-files-grid"></div>
    </div>
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" data-modal-close>
        <i class="fas fa-times mr-2"></i>
        Cerrar
      </button>
    </div>
  </div>
</div>

<div id="uploadFolderModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-2xl">
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-lime-500 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-upload text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white">Agregar archivo multimedia</h3>
            <p class="text-sm text-white/70">Selecciona la carpeta destino y adjunta el archivo</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" data-modal-close aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    <div class="ios-blur-body space-y-6">
      <form
        id="folderUploadForm"
        class="ios-upload-form"
        data-upload-url="{{ url_for('admin_upload_image_file') }}"
        novalidate
      >
        <div class="ios-upload-field">
          <label for="uploadFolderSelect" class="ios-upload-label">
            <i class="fas fa-folder-closed mr-2"></i>Carpeta destino
          </label>
          <select id="uploadFolderSelect" class="ios-blur-input" required>
            <option value="" disabled selected>Selecciona una carpeta</option>
            {% for folder in images_data.folders %}
            <option value="{{ folder.name }}">{{ folder.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="ios-upload-field">
          <label for="uploadFileName" class="ios-upload-label">
            <i class="fas fa-signature mr-2"></i>Nombre del archivo
          </label>
          <input id="uploadFileName" type="text" class="ios-blur-input" placeholder="Ej. banner_home" required>
          <p class="ios-upload-hint">Escribe manualmente el nombre final del archivo.</p>
        </div>
        <div class="ios-upload-field">
          <label for="uploadFileInput" class="ios-upload-label">
            <i class="fas fa-file-arrow-up mr-2"></i>Selecciona el archivo
          </label>
          <div class="ios-upload-dropzone">
            <input id="uploadFileInput" type="file" class="ios-upload-input" accept="image/*,video/*,audio/*,application/pdf" required>
            <div class="ios-upload-dropzone-content">
              <i class="fas fa-cloud-arrow-up text-white/70 text-xl"></i>
              <p class="ios-upload-hint">Arrastra y suelta o haz clic para buscar (PNG, JPG, MP4, MP3, PDF)</p>
            </div>
          </div>
          <div id="uploadPreview" class="ios-upload-preview hidden"></div>
        </div>
        <p id="uploadFeedback" class="ios-upload-feedback hidden">
          <i class="fas fa-circle-info mr-2"></i>Esta acción estará disponible pronto.
        </p>
      </form>
    </div>
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" data-modal-close>
        <i class="fas fa-times mr-2"></i>
        Cancelar
      </button>
      <button type="submit" form="folderUploadForm" class="ios-blur-btn ios-blur-btn-primary" id="uploadSubmitButton">
        <i class="fas fa-cloud-upload-alt mr-2"></i>
        Guardar archivo
      </button>
    </div>
  </div>
</div>

<div id="createFolderModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-lg">
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-folder-plus text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white">Crear nuevo directorio</h3>
            <p class="text-sm text-white/70">Asigna un nombre y un identificador interno</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" data-modal-close aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    <div class="ios-blur-body space-y-6">
      <form id="folderCreateForm" class="ios-upload-form" data-create-url="{{ url_for('admin_create_image_folder') }}" novalidate>
        <div class="ios-upload-field">
          <label for="createFolderDisplay" class="ios-upload-label">
            <i class="fas fa-font mr-2"></i>Nombre visible
          </label>
          <input id="createFolderDisplay" type="text" class="ios-blur-input" placeholder="Ej. Campañas Otoño" required>
          <p class="ios-upload-hint">Se enviará como "name" al servicio externo.</p>
        </div>
        <p id="createFolderFeedback" class="ios-upload-feedback hidden">
          <i class="fas fa-circle-info mr-2"></i>La creación de carpetas estará disponible pronto.
        </p>
      </form>
    </div>
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" data-modal-close>
        <i class="fas fa-times mr-2"></i>
        Cancelar
      </button>
      <button type="submit" form="folderCreateForm" class="ios-blur-btn ios-blur-btn-primary" id="createFolderSubmitButton">
        <i class="fas fa-check mr-2"></i>
        Crear directorio
      </button>
    </div>
  </div>
</div>

<div id="deleteFolderModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-md">
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-red-500 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-trash text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white" id="deleteFolderTitle">Eliminar directorio</h3>
            <p class="text-sm text-white/70">Esta acción removerá el directorio del servicio externo</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" data-modal-close aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    <div class="ios-blur-body space-y-5">
      <div class="ios-delete-summary">
        <p class="ios-upload-label flex items-center gap-2">
          <i class="fas fa-folder-open text-white/70"></i>
          <span id="deleteFolderName">sin-nombre</span>
        </p>
        <p class="ios-upload-hint">Confirma que deseas eliminar este directorio y su contenido en el servicio multimedia.</p>
      </div>
        <p id="deleteFolderFeedback" class="ios-upload-feedback hidden">
          <i class="fas fa-circle-info mr-2"></i>Confirma la eliminación del directorio seleccionado.
        </p>
    </div>
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" data-modal-close>
        <i class="fas fa-times mr-2"></i>
        Cancelar
      </button>
      <button type="button" class="ios-blur-btn ios-blur-btn-danger" id="confirmDeleteFolderButton" data-delete-url="">
        <i class="fas fa-trash mr-2"></i>
        Eliminar
      </button>
    </div>
  </div>
</div>

</div>
</div>
{% endblock %}
