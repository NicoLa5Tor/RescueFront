{% extends "admin/dashboard.html" %}

{% block title %}Tipos de Empresa - Sistema Multi-Tenant{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="{{ url_for('static', filename='css/modals.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/hardware/hardware-main.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/company-types/company-types-main.css') }}" rel="stylesheet">
<style>
/* Asegurar visibilidad por defecto - OVERRIDE para tipos de empresa */
.ios-header-container,
.ios-stats-grid .ios-stat-card,
.ios-hardware-grid .ios-hardware-card {
  opacity: 1 !important;
  transform: none !important;
  visibility: visible !important;
}

/* Asegurar que las tarjetas sean visibles desde el inicio */
.company-type-item {
  opacity: 1 !important;
  transform: none !important;
  visibility: visible !important;
}

/* Estilos espec√≠ficos para tipos de empresa */
.company-type-item .ios-info-label {
  display: flex;
  align-items: center;
  font-size: 0.75rem;
}

/* Hacer que ciertos elementos ocupen fila completa */
.company-type-item .ios-info-item.full-width {
  grid-column: 1 / -1; /* Ocupa toda la fila en el grid */
  width: 100%;
  margin-bottom: 8px;
}

.company-type-item .ios-card-info {
  display: grid;
  grid-template-columns: 1fr 1fr; /* Dos columnas por defecto */
  gap: 8px;
}

.company-type-item .ios-card-subtitle {
  max-height: 3rem;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* Bot√≥n espec√≠fico para ver empresas */
.ios-card-btn-info {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.ios-card-btn-info:hover {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

/* Tags de caracter√≠sticas mejorados para ambos temas */
.company-type-item span[class*="bg-blue"],
.company-type-item span[class*="bg-gray"] {
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.company-type-item span[class*="bg-blue"]:hover,
.company-type-item span[class*="bg-gray"]:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Tema claro - colores s√≥lidos y fuertes */
@media (prefers-color-scheme: light) {
  .company-type-item span[class*="bg-blue"]:hover {
    background: #1d4ed8 !important; /* Azul m√°s fuerte */
    border-color: #1e3a8a !important;
  }
  
  .company-type-item span[class*="bg-gray"]:hover {
    background: #374151 !important; /* Gris m√°s fuerte */
    border-color: #1f2937 !important;
  }
}

/* Tema oscuro - mantener estilos transparentes */
@media (prefers-color-scheme: dark) {
  .company-type-item span[class*="bg-blue"]:hover {
    background: rgba(59, 130, 246, 0.4) !important;
    border-color: rgba(59, 130, 246, 0.5) !important;
  }
  
  .company-type-item span[class*="bg-gray"]:hover {
    background: rgba(107, 114, 128, 0.4) !important;
    border-color: rgba(107, 114, 128, 0.5) !important;
  }
}
</style>
{% endblock %}

{% block main_content %}
<div class="company-types-container">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Enhanced iOS Header - HARDWARE STYLE -->
    <div class="ios-header-container mb-8">
      <div class="ios-header-backdrop">
        <div class="ios-header-content">
          <div class="ios-header-text">
            <div class="ios-header-icon">
              <i class="fas fa-layer-group"></i>
            </div>
            <div>
            <h1 class="ios-header-title text-3xl md:text-4xl font-bold text-white dark:text-white">Gesti√≥n de Tipos de Empresa</h1>
              <p class="ios-header-subtitle text-base md:text-lg text-white/80 dark:text-gray-300">
                Administra las categor√≠as con tecnolog√≠a de vanguardia
                {% if include_inactive %}
                  <span class="inline-block ml-2 px-2 py-1 bg-orange-500 text-white text-xs font-medium rounded-full">
                    Mostrando todos ({{ company_types_data.company_types|length }} tipos)
                  </span>
                {% else %}
                  <span class="inline-block ml-2 px-2 py-1 bg-green-500 text-white text-xs font-medium rounded-full">
                    Solo activos ({{ company_types_data.company_types|length }} tipos)
                  </span>
                {% endif %}
              </p>
            </div>
          </div>
          <div class="ios-header-actions">
          <button class="ios-action-btn ios-action-btn-secondary" onclick="exportTypes()">
              <i class="fas fa-download"></i>
              <span class="text-sm font-medium">Exportar</span>
            </button>
            <button class="ios-action-btn {% if include_inactive %}ios-action-btn-warning{% else %}ios-action-btn-secondary{% endif %}" onclick="toggleIncludeInactive()">
              <i class="fas fa-{% if include_inactive %}eye-slash{% else %}eye{% endif %}"></i>
              <span class="text-sm font-medium">{% if include_inactive %}Solo Activos{% else %}Ver Todos{% endif %}</span>
            </button>
            <button class="ios-action-btn ios-action-btn-primary" onclick="openCreateModal()">
              <i class="fas fa-plus"></i>
              <span class="text-sm font-medium">Nuevo Tipo</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced iOS Stats Cards - HARDWARE STYLE -->
    <div class="ios-stats-grid">
      <div class="ios-stat-card" data-stat="total">
        <div class="ios-stat-icon ios-stat-icon-blue">
          <i class="fas fa-layer-group"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Total Tipos</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="totalTypesCount">{{ company_types_data.company_types_stats.total_types }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Categor√≠as disponibles</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
      
      <div class="ios-stat-card" data-stat="active">
        <div class="ios-stat-icon ios-stat-icon-green">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Activos</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="activeTypesCount">{{ company_types_data.company_types_stats.active_types }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Funcionando correctamente</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
      
      <div class="ios-stat-card" data-stat="companies">
        <div class="ios-stat-icon ios-stat-icon-purple">
          <i class="fas fa-building"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Total Empresas</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="totalCompaniesCount">{{ company_types_data.company_types_stats.total_companies }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Empresas categorizadas</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
      
      <div class="ios-stat-card" data-stat="average">
        <div class="ios-stat-icon ios-stat-icon-orange">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Promedio por Tipo</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="avgCompaniesCount">{{ company_types_data.company_types_stats.avg_companies_per_type }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Distribuci√≥n equilibrada</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
    </div>


  <!-- Enhanced iOS Company Types Grid - HARDWARE STYLE CON CONTENIDO ESPEC√çFICO -->
    <div class="ios-hardware-grid" id="companyTypesGrid">
      {% for company_type in company_types_data.company_types %}
      <div class="ios-hardware-card company-type-item" data-type-id="{{ company_type.id }}" data-status="{{ company_type.active|lower }}">
        <div class="ios-card-header">
          <div class="ios-card-icon">
            <i class="fas fa-layer-group"></i>
          </div>
          <span class="ios-status-badge {% if company_type.active %}ios-status-available{% else %}ios-status-discontinued{% endif %} text-xs font-semibold">
            {% if company_type.active %}‚úÖ Activo{% else %}‚ö´ Inactivo{% endif %}
          </span>
        </div>
        
        <h3 class="ios-card-title text-xl font-semibold text-gray-900 dark:text-white">{{ company_type.name }}</h3>
        <p class="ios-card-subtitle text-sm text-gray-600 dark:text-gray-400 leading-relaxed">{{ company_type.description }}</p>
        
        <!-- Secci√≥n espec√≠fica para tipos de empresa -->
        <div class="ios-card-info">
          <!-- Empresas asociadas - FILA COMPLETA -->
          <div class="ios-info-item full-width">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-building text-purple-400 mr-1"></i>
              Empresas asociadas
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ company_type.companies_count }}</span>
          </div>
          
          <!-- Caracter√≠sticas y Distribuci√≥n - MISMA FILA -->
          {% if company_type.features and company_type.features|length > 0 %}
          <div class="ios-info-item">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-tags text-blue-400 mr-1"></i>
              Caracter√≠sticas
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ company_type.features|length }}</span>
          </div>
          {% endif %}
          {% if company_type.companies_count > 0 %}
          <div class="ios-info-item">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-chart-bar text-green-400 mr-1"></i>
              Distribuci√≥n
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(company_type.companies_count / company_types_data.company_types_stats.total_types) }}%</span>
          </div>
          {% endif %}
          
          <!-- Fecha de creaci√≥n - FILA COMPLETA -->
          <div class="ios-info-item full-width">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-calendar text-orange-400 mr-1"></i>
              Fecha de creaci√≥n
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ company_type.created_at }}</span>
          </div>
        </div>
        
        <!-- Caracter√≠sticas destacadas (si existen) -->
        {% if company_type.features and company_type.features|length > 0 %}
        <div class="mt-3 mb-3">
          <div class="text-xs font-semibold text-blue-800 dark:text-blue-400 mb-2">
            <i class="fas fa-list mr-1 text-blue-700 dark:text-blue-400"></i>
            Caracter√≠sticas principales:
          </div>
          <div class="flex flex-wrap gap-1">
            {% for feature in company_type.features[:3] %}
            <span class="inline-block px-2 py-1 bg-blue-700 dark:bg-blue-500/20 text-white dark:text-blue-300 text-xs font-semibold rounded-full border border-blue-800 dark:border-blue-500/30">
              {{ feature }}
            </span>
            {% endfor %}
            {% if company_type.features|length > 3 %}
            <span class="inline-block px-2 py-1 bg-gray-700 dark:bg-gray-500/20 text-white dark:text-gray-300 text-xs font-semibold rounded-full border border-gray-800 dark:border-gray-500/30">
              +{{ company_type.features|length - 3 }} m√°s
            </span>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- Botones de acci√≥n espec√≠ficos para tipos de empresa -->
        <div class="ios-card-actions">
          <button class="ios-card-btn" onclick="viewCompanyType('{{ company_type.id }}')" title="Ver detalles completos">
            <i class="fas fa-eye"></i>
          </button>
          {% if company_type.companies_count > 0 %}
          <button class="ios-card-btn ios-card-btn-info" onclick="viewCompaniesOfType('{{ company_type.id }}', '{{ company_type.name }}')" title="Ver empresas de este tipo">
            <i class="fas fa-building"></i>
          </button>
          {% endif %}
          <button class="ios-card-btn ios-card-btn-primary" onclick="editCompanyType('{{ company_type.id }}')" title="Editar tipo">
            <i class="fas fa-edit"></i>
          </button>
          <button class="ios-card-btn {{ company_type.active and 'ios-card-btn-warning' or 'ios-card-btn-success' }}" 
                  onclick="toggleStatus('{{ company_type.id }}', {{ company_type.active|lower }})" 
                  title="{{ company_type.active and 'Desactivar tipo' or 'Activar tipo' }}">
            <i class="fas {{ company_type.active and 'fa-power-off' or 'fa-play' }}"></i>
          </button>
        </div>
        
        <!-- iOS Card Shimmer Effect -->
        <div class="ios-card-shimmer"></div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
</div>

<!-- Create/Edit Company Type Modal - EXACT HARDWARE STYLE -->
<div id="companyTypeModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-2xl">
    <!-- Modal Header -->
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-layer-group text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white dark:text-white" id="modalTitle">Nuevo Tipo de Empresa</h3>
            <p class="text-sm text-white/70 dark:text-gray-300">Complete los campos para registrar el tipo</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" onclick="closeModal()" aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="ios-blur-body">
      <form id="companyTypeForm">
        <div class="form-grid">
          <!-- Nombre -->
          <div class="form-group">
            <label for="typeName" class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-tag text-purple-400 mr-2"></i>Nombre *
            </label>
            <input type="text" id="typeName" class="ios-blur-input" required
                   placeholder="Ej: Tecnolog√≠a">
          </div>
          
          <!-- Estado -->
          <div class="form-group">
            <label for="typeStatus" class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-toggle-on text-blue-400 mr-2"></i>Estado *
            </label>
            <select id="typeStatus" class="ios-blur-input" required>
              <option value="true" class="text-sm">üü¢ Activo</option>
              <option value="false" class="text-sm">üî¥ Inactivo</option>
            </select>
          </div>
          
          <!-- Descripci√≥n -->
          <div class="form-group form-group-full">
            <label for="typeDescription" class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-align-left text-cyan-400 mr-2"></i>Descripci√≥n *
            </label>
            <textarea id="typeDescription" class="ios-blur-input !min-h-[6rem] resize-y" rows="3" required
                      placeholder="Describe el tipo de empresa, sus caracter√≠sticas principales..."></textarea>
          </div>
          
          <!-- Caracter√≠sticas -->
          <div class="form-group form-group-full">
            <label class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-list text-orange-400 mr-2"></i>Caracter√≠sticas
            </label>
            <div id="featuresContainer" class="space-y-3">
              <div class="flex space-x-2">
                <input type="text" id="featureInput" placeholder="Agregar caracter√≠stica..." 
                       class="ios-blur-input flex-1" onkeypress="handleFeatureKeyPress(event)">
                <button type="button" class="ios-blur-btn ios-blur-btn-primary !p-2 !min-w-0" onclick="addFeature()">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div id="featuresList" class="space-y-2">
                <!-- Features will be displayed here -->
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Modal Footer -->
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" onclick="closeModal()">
        <i class="fas fa-times mr-2"></i>
        <span class="text-sm font-medium">Cancelar</span>
      </button>
      <button type="submit" form="companyTypeForm" class="ios-blur-btn ios-blur-btn-primary" id="submitButton">
        <i class="fas fa-save mr-2"></i>
        <span id="submitButtonText" class="text-sm font-medium">Crear Tipo</span>
      </button>
    </div>
  </div>
</div>

<!-- View Details Modal - EXACT HARDWARE STYLE -->
<div id="detailsModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-2xl">
    <!-- Modal Header -->
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-eye text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white dark:text-white" id="detailsTitle">Detalles del Tipo</h3>
            <p class="text-sm text-white/70 dark:text-gray-300">Informaci√≥n completa del tipo seleccionado</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" onclick="closeDetailsModal()" aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="ios-blur-body">
      <div id="detailsContent">
        <!-- Details will be loaded here -->
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" onclick="closeDetailsModal()">
        <i class="fas fa-times mr-2"></i>
        <span class="text-sm font-medium">Cerrar</span>
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Toggle Company Type Status Modal - EXACT COPY FROM HARDWARE -->
<div id="toggleCompanyTypeModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container max-w-md" id="toggleModalContainer">
    <div class="ios-blur-header text-center">
      <div class="toggle-modal-icon mx-auto mb-4" id="toggleModalIcon">
        <i class="fas fa-power-off text-4xl" id="toggleModalIconFa"></i>
      </div>
      <h3 class="text-2xl font-bold text-white dark:text-white mb-2" id="toggleModalTitle">Activar Tipo de Empresa</h3>
    </div>
    <div class="ios-blur-body text-center">
      <p class="text-white/80 dark:text-gray-300 text-lg mb-6" id="toggleModalMessage">
        ¬øEst√°s seguro de que quieres activar este tipo de empresa?
      </p>
      <div class="flex gap-4 justify-center">
        <button class="ios-blur-btn ios-blur-btn-secondary" onclick="closeToggleModal()">
          <i class="fas fa-times mr-2"></i>
          <span class="text-sm font-medium">Cancelar</span>
        </button>
        <button class="ios-blur-btn ios-blur-btn-primary" id="toggleConfirmBtn" onclick="confirmToggleCompanyType()">
          <i class="fas fa-check mr-2" id="toggleConfirmIcon"></i>
          <span id="toggleConfirmText" class="text-sm font-medium">Activar</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Client Update Success Modal - EXACT COPY FROM HARDWARE -->
<div id="clientUpdateModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container max-w-md" id="updateModalContainer">
    <div class="ios-blur-header text-center">
      <div class="client-update-icon mx-auto mb-4" id="updateModalIcon">
        <i class="fas fa-sync-alt text-4xl text-emerald-400" id="updateModalIconFa"></i>
      </div>
      <h3 class="text-2xl font-bold text-white dark:text-white mb-2" id="updateModalTitle">Tipo Actualizado</h3>
    </div>
    <div class="ios-blur-body text-center">
      <p class="text-white/80 dark:text-gray-300 text-lg mb-6" id="updateModalMessage">
        El tipo de empresa se ha actualizado exitosamente.
      </p>
      <button class="ios-blur-btn ios-blur-btn-primary mx-auto" onclick="closeUpdateModal()">
        <i class="fas fa-check mr-2"></i>
        <span class="text-sm font-medium">Aceptar</span>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Hardware GSAP Animations - SAME AS HARDWARE -->
<script src="{{ url_for('static', filename='js/hardware-animations.js') }}"></script>
<!-- Performance optimizer espec√≠fico para tipos de empresa -->
<script>
  // Funci√≥n GLOBAL para aplicar optimizaciones a una tarjeta espec√≠fica (usando GSAP global)
  function applyCardOptimizations(card) {
    // Usar las animaciones GSAP globales ya disponibles
    if (window.HardwareAnimations) {
      // Las animaciones de hover ya est√°n configuradas en hardware-animations.js
      console.log('üîß Optimizaciones GSAP aplicadas a tarjeta individual');
      return;
    }
    
    // Fallback para compatibilidad si GSAP no est√° disponible
    const shimmer = card.querySelector('.ios-card-shimmer');
    if (shimmer && !window.GSAPUtils?.prefersReducedMotion()) {
      shimmer.style.opacity = '0';
      shimmer.style.transform = 'rotate(45deg) translateX(-100%)';
      console.log('üîß Fallback aplicado a tarjeta individual');
    }
  }
  
  // Funci√≥n para aplicar optimizaciones a tarjetas ya existentes
  function applyOptimizationsToExistingCards() {
    const existingCards = document.querySelectorAll('.ios-hardware-card');
    existingCards.forEach(card => {
      applyCardOptimizations(card);
    });
    console.log(`üîß Optimizaciones aplicadas a ${existingCards.length} tarjetas existentes`);
  }
  
  // Funci√≥n para forzar visibilidad de elementos si GSAP falla
  function ensureContentVisibility() {
    const elements = [
      '.ios-header-container',
      '.ios-stats-grid .ios-stat-card',
      '.ios-hardware-grid .ios-hardware-card'
    ];
    
    elements.forEach(selector => {
      const elementsList = document.querySelectorAll(selector);
      elementsList.forEach(el => {
        el.style.opacity = '1';
        el.style.transform = 'none';
        el.style.visibility = 'visible';
      });
    });
    
    console.log('üëÅÔ∏è Forzada visibilidad de elementos');
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üõ†Ô∏è Company Types page loaded with GSAP optimizations');
    
    // Asegurar que el contenido sea visible inmediatamente
    ensureContentVisibility();
    
    // Intentar usar animaciones de hardware
    if (window.HardwareAnimations) {
      console.log('‚úÖ Usando HardwareAnimations para tipos de empresa');
      window.HardwareAnimations.init();
    } else {
      console.warn('‚ö†Ô∏è HardwareAnimations no disponible, usando fallback');
      // Fallback - asegurar que todo sea visible
      setTimeout(ensureContentVisibility, 100);
    }
    
    // Observer para tarjetas que se a√±aden din√°micamente
    const companyTypesGrid = document.getElementById('companyTypesGrid');
    if (companyTypesGrid) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.classList.contains('ios-hardware-card')) {
              console.log('üëÄ Nueva tarjeta detectada, aplicando animaci√≥n GSAP...');
              
              // Usar animaci√≥n GSAP para nueva tarjeta
              if (window.HardwareAnimations) {
                window.HardwareAnimations.animateNewCard(node);
              } else {
                applyCardOptimizations(node);
              }
            }
          });
        });
      });
      
      observer.observe(companyTypesGrid, {
        childList: true,
        subtree: true
      });
      
      console.log('üëÄ Observer configurado para detectar nuevas tarjetas');
    }
    
    console.log('‚úÖ Company Types page optimizations applied successfully');
  });
</script>
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/api-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard/basic-managers.js') }}"></script>
<script>
let editingCompanyType = null;
let currentFeatures = [];

// Debug function to check modal elements
function debugToggleModal() {
  console.log('üîç Debugging toggle modal elements:');
  const elements = {
    modal: document.getElementById('toggleCompanyTypeModal'),
    container: document.getElementById('toggleModalContainer'),
    icon: document.getElementById('toggleModalIcon'),
    iconFa: document.getElementById('toggleModalIconFa'),
    title: document.getElementById('toggleModalTitle'),
    message: document.getElementById('toggleModalMessage'),
    confirmBtn: document.getElementById('toggleConfirmBtn'),
    confirmText: document.getElementById('toggleConfirmText'),
    confirmIcon: document.getElementById('toggleConfirmIcon')
  };
  
  Object.entries(elements).forEach(([name, element]) => {
    console.log(`  ${name}:`, element ? '‚úÖ Found' : '‚ùå NOT FOUND');
  });
  
  return elements;
}

// SIMPLIFIED: Initialize page with direct filtering by 'activo' field
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Initializing company types with simple filtering');
  
  // Debug modal elements
  setTimeout(() => {
    debugToggleModal();
  }, 500);
  
  // Forzar visibilidad inmediata para evitar problemas
  const forceVisibility = () => {
    const allElements = document.querySelectorAll('.ios-header-container, .ios-stat-card, .ios-hardware-card, .company-type-item');
    allElements.forEach(el => {
      el.style.opacity = '1';
      el.style.transform = 'none';
      el.style.visibility = 'visible';
    });
    console.log(`üëÅÔ∏è Forzada visibilidad de ${allElements.length} elementos`);
  };
  
  // Ejecutar inmediatamente
  forceVisibility();
  
  // Get initial state from URL parameter (usar variable global)
  console.log(`üîß Show inactive: ${currentShowingInactive}`);
  
  // Apply initial filter - by default show only active types
  setTimeout(() => {
    filterTypesByActiveStatus(currentShowingInactive);
    // Sincronizar estado del bot√≥n
    syncButtonState();
    // Forzar visibilidad nuevamente despu√©s del filtro
    forceVisibility();
  }, 100);
});

// Funci√≥n de test para probar el toggle modal
function testToggleModal() {
  console.log('üß™ Testing toggle modal...');
  openToggleCompanyTypeModal('test-id', true, 'Tipo de Prueba');
}

// Exponer para debug
window.testToggleModal = testToggleModal;
window.debugToggleModal = debugToggleModal;

// Modal functionality - EXACT HARDWARE STYLE
function openCreateModal() {
  editingCompanyType = null;
  currentFeatures = []; // Clear features array
  document.getElementById('modalTitle').textContent = 'Nuevo Tipo de Empresa';
  document.getElementById('submitButtonText').textContent = 'Crear Tipo';
  document.getElementById('companyTypeForm').reset();
  updateFeaturesList(); // Clear features display
  
  // Scroll to top first, then show modal - EXACT HARDWARE STYLE
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Delay modal opening to allow scroll to complete
  setTimeout(() => {
    // Prevent body scrolling - EXACT HARDWARE STYLE
    const scrollPosition = window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('ios-modal-open');
    
    // Open modal using modal manager - EXACT HARDWARE STYLE
    if (window.modalManager) {
      window.modalManager.openModal('companyTypeModal');
      window.modalManager.setupModal('companyTypeModal');
    } else {
      // Fallback for compatibility
      const modal = document.getElementById('companyTypeModal');
      modal.classList.remove('hidden');
    }
  }, 300);
}

async function editCompanyType(id) {
  editingCompanyType = id;
  document.getElementById('modalTitle').textContent = 'Editar Tipo de Empresa';
  document.getElementById('submitButtonText').textContent = 'Actualizar Tipo';
  
  try {
    // Load the actual company type data from backend
    const response = await callAPI('GET', `/api/tipos_empresa/${id}`);
    if (response.success && response.data) {
      const data = response.data;
      document.getElementById('typeName').value = data.nombre || '';
      document.getElementById('typeStatus').value = data.activo ? 'true' : 'false';
      document.getElementById('typeDescription').value = data.descripcion || '';
      
      // Load features/characteristics
      currentFeatures = data.caracteristicas || [];
      updateFeaturesList();
    }
  } catch (error) {
    console.error('Error loading company type:', error);
    showEnhancedNotification('Error al cargar los datos del tipo de empresa', 'error');
    return;
  }
  
  // Scroll to top first, then show modal - EXACT HARDWARE STYLE
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Delay modal opening to allow scroll to complete
  setTimeout(() => {
    // Prevent body scrolling - EXACT HARDWARE STYLE
    const scrollPosition = window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('ios-modal-open');
    
    // Open modal using modal manager - EXACT HARDWARE STYLE
    if (window.modalManager) {
      window.modalManager.openModal('companyTypeModal');
      window.modalManager.setupModal('companyTypeModal');
    } else {
      // Fallback for compatibility
      const modal = document.getElementById('companyTypeModal');
      modal.classList.remove('hidden');
    }
  }, 300);
}

function closeModal() {
  // Restore scroll position before closing - EXACT HARDWARE STYLE
  const scrollY = document.body.style.top;
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  document.body.classList.remove('ios-modal-open');
  
  if (scrollY) {
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
  }
  
  // Use global modal system - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.closeModal('companyTypeModal');
  } else {
    // Fallback for compatibility
    const modal = document.getElementById('companyTypeModal');
    modal.classList.add('hidden');
  }
  
  editingCompanyType = null;
}

async function viewCompanyType(id) {
  try {
    const response = await callAPI('GET', `/api/tipos_empresa/${id}`);
    if (response.success && response.data) {
      const data = response.data;
      document.getElementById('detailsTitle').textContent = `Detalles: ${data.nombre}`;
      document.getElementById('detailsContent').innerHTML = `
        <div class="space-y-4">
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-building text-purple-600 text-xl"></i>
            </div>
            <div>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">${data.nombre}</h4>
              <p class="text-sm text-gray-500 dark:text-gray-400">ID: ${id}</p>
            </div>
          </div>
          <div>
            <h5 class="text-base font-semibold text-gray-900 dark:text-white mb-2">Descripci√≥n</h5>
            <p class="text-sm text-gray-600 dark:text-gray-400">${data.descripcion || 'Sin descripci√≥n'}</p>
          </div>
          <div>
            <h5 class="text-base font-semibold text-gray-900 dark:text-white mb-2">Estado</h5>
            <span class="text-sm font-semibold ${data.activo ? 'text-green-600' : 'text-red-600'} ml-2">${data.activo ? 'Activo' : 'Inactivo'}</span>
          </div>
          <div>
            <h5 class="text-base font-semibold text-gray-900 dark:text-white mb-2">Caracter√≠sticas</h5>
            <div class="flex flex-wrap gap-2">
              ${data.caracteristicas && data.caracteristicas.length > 0 ? 
                data.caracteristicas.map(feature => 
                  `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-xs font-medium">${feature}</span>`
                ).join('') : 
                '<span class="text-gray-500 dark:text-gray-400 text-sm">No hay caracter√≠sticas definidas</span>'
              }
            </div>
          </div>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading company type details:', error);
    showEnhancedNotification('Error al cargar los detalles del tipo de empresa', 'error');
    return;
  }
  
  // Scroll to top first, then show modal - EXACT HARDWARE STYLE
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Delay modal opening to allow scroll to complete
  setTimeout(() => {
    // Prevent body scrolling - EXACT HARDWARE STYLE
    const scrollPosition = window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('ios-modal-open');
    
    // Open modal using modal manager - EXACT HARDWARE STYLE
    if (window.modalManager) {
      window.modalManager.openModal('detailsModal');
      window.modalManager.setupModal('detailsModal');
    } else {
      // Fallback for compatibility
      const modal = document.getElementById('detailsModal');
      modal.classList.remove('hidden');
    }
  }, 300);
}

function closeDetailsModal() {
  // Restore scroll position before closing - EXACT HARDWARE STYLE
  const scrollY = document.body.style.top;
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  document.body.classList.remove('ios-modal-open');
  
  if (scrollY) {
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
  }
  
  // Use global modal system - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.closeModal('detailsModal');
  } else {
    // Fallback for compatibility
    const modal = document.getElementById('detailsModal');
    modal.classList.add('hidden');
  }
}


// ===== EXACT COPY FROM HARDWARE - ADAPTED FOR COMPANY TYPES =====

// Variables para el modal de toggle - IGUAL QUE HARDWARE
let toggleModalData = {
  typeId: null,
  newStatus: null
};

// Funci√≥n para abrir modal de toggle - ADAPTADA DE HARDWARE
function openToggleCompanyTypeModal(id, currentStatus, typeName) {
  console.log('üîÑ Opening toggle modal for company type:', id, 'current status:', currentStatus);
  
  const newStatus = !currentStatus;
  const action = newStatus ? 'activar' : 'desactivar';
  
  // Guardar datos para el modal
  toggleModalData.typeId = id;
  toggleModalData.newStatus = newStatus;
  
  // Configurar el modal
  const modal = document.getElementById('toggleCompanyTypeModal');
  const container = document.getElementById('toggleModalContainer');
  const icon = document.getElementById('toggleModalIcon');
  const iconFa = document.getElementById('toggleModalIconFa');
  const title = document.getElementById('toggleModalTitle');
  const message = document.getElementById('toggleModalMessage');
  const confirmText = document.getElementById('toggleConfirmText');
  const confirmIcon = document.getElementById('toggleConfirmIcon');
  
  if (!modal || !container || !title || !message) {
    console.error('‚ùå Toggle modal elements missing!');
    // Fallback to simple confirm
    if (confirm(`¬øEst√°s seguro de que quieres ${action} este tipo de empresa?`)) {
      executeToggleCompanyType(id, newStatus);
    }
    return;
  }
  
  // Configurar contenido del modal
  if (newStatus) {
    icon.className = 'toggle-modal-icon activate mx-auto mb-4';
    if (iconFa) iconFa.className = 'fas fa-play-circle text-4xl';
    title.textContent = 'Activar Tipo de Empresa';
    message.textContent = `¬øEst√°s seguro de que quieres activar el tipo "${typeName}"?`;
    confirmText.textContent = 'Activar';
    if (confirmIcon) confirmIcon.className = 'fas fa-play mr-2';
  } else {
    icon.className = 'toggle-modal-icon deactivate mx-auto mb-4';
    if (iconFa) iconFa.className = 'fas fa-pause-circle text-4xl';
    title.textContent = 'Desactivar Tipo de Empresa';
    message.textContent = `¬øEst√°s seguro de que quieres desactivar el tipo "${typeName}"?`;
    confirmText.textContent = 'Desactivar';
    if (confirmIcon) confirmIcon.className = 'fas fa-pause mr-2';
  }
  
  // Mostrar modal con animaci√≥n - IGUAL QUE HARDWARE
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  console.log('‚úÖ Toggle modal should now be visible');
  
  // Simple animation
  if (typeof gsap !== 'undefined') {
    gsap.set(container, { scale: 0.8, opacity: 0 });
    gsap.to(container, {
      scale: 1,
      opacity: 1,
      duration: 0.3,
      ease: "power2.out"
    });
  } else {
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }
}

// Cerrar modal de toggle - EXACTO DE HARDWARE
function closeToggleModal() {
  console.log('üîÑ Closing toggle modal');
  
  const modal = document.getElementById('toggleCompanyTypeModal');
  const container = document.getElementById('toggleModalContainer');
  const buttons = document.querySelector('.flex.gap-4'); // Cambio el selector
  const confirmBtn = document.getElementById('toggleConfirmBtn');
  
  if (!modal) {
    console.error('‚ùå Modal not found when trying to close');
    return;
  }
  
  // Simple close without complex animation for debugging
  if (typeof gsap !== 'undefined' && container) {
    gsap.to(container, {
      scale: 0.8,
      opacity: 0,
      duration: 0.2,
      ease: "power2.in",
      onComplete: () => {
        resetAndHideModal();
      }
    });
  } else {
    resetAndHideModal();
  }
  
  function resetAndHideModal() {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    // Reset modal state completely
    if (buttons) {
      buttons.style.display = 'flex';
      buttons.style.opacity = '1';
      buttons.style.transform = 'none';
    }
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-check" id="toggleConfirmIcon"></i> <span id="toggleConfirmText">Confirmar</span>';
    }
    
    // Reset icon and text
    const icon = document.getElementById('toggleModalIcon');
    const iconFa = document.getElementById('toggleModalIconFa');
    const title = document.getElementById('toggleModalTitle');
    const message = document.getElementById('toggleModalMessage');
    
    if (icon) {
      icon.style.transform = 'none';
      icon.style.scale = '1';
    }
    if (title) title.textContent = 'Confirmar Acci√≥n';
    if (message) message.textContent = '¬øEst√°s seguro de que quieres continuar?';
    
    // Reset data
    toggleModalData.typeId = null;
    toggleModalData.newStatus = null;
    
    console.log('‚úÖ Toggle modal closed and fully reset');
  }
}

// Confirmar toggle - ADAPTADO DE HARDWARE
function confirmToggleCompanyType() {
  if (toggleModalData.typeId && toggleModalData.newStatus !== null) {
    // Show loading state
    const confirmBtn = document.getElementById('toggleConfirmBtn');
    const originalContent = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    confirmBtn.disabled = true;
    
    // Call the API function
    executeToggleCompanyType(toggleModalData.typeId, toggleModalData.newStatus)
      .then(() => {
        // Show success feedback before closing
        showToggleSuccess(toggleModalData.newStatus);
      })
      .catch((error) => {
        // Restore button on error
        confirmBtn.innerHTML = originalContent;
        confirmBtn.disabled = false;
        console.error('Error in toggle operation:', error);
        showEnhancedNotification(error.message, 'error');
      });
  }
}

// Ejecutar toggle - ADAPTADO PARA COMPANY TYPES
async function executeToggleCompanyType(id, newStatus) {
  try {
    console.log('üìû Executing toggle for type:', id, 'to status:', newStatus);
    
    const response = await callAPI('PATCH', `/api/tipos_empresa/${id}/toggle-status`);
    console.log('‚úÖ Toggle response:', response);
    
    // Animar cambio de estado usando HardwareAnimations
    const card = document.querySelector(`[data-type-id="${id}"]`);
    if (card && window.HardwareAnimations) {
      window.HardwareAnimations.animateStatusChange ? 
        window.HardwareAnimations.animateStatusChange(card) :
        console.log('üé® Status change animation not available');
    }
    
    return response;
  } catch (error) {
    console.error('üí• Error executing toggle:', error);
    throw error;
  }
}

// Show toggle success feedback - EXACTO DE HARDWARE
function showToggleSuccess(activated) {
  console.log('‚úÖ Showing toggle success for:', activated ? 'activate' : 'deactivate');
  
  const container = document.getElementById('toggleModalContainer');
  const icon = document.getElementById('toggleModalIcon');
  const iconFa = document.getElementById('toggleModalIconFa');
  const title = document.getElementById('toggleModalTitle');
  const message = document.getElementById('toggleModalMessage');
  const buttons = document.querySelector('.flex.gap-4');
  
  if (!icon || !title || !message || !buttons) {
    console.error('‚ùå Toggle success elements missing!');
    closeToggleModal();
    return;
  }
  
  // Update content to show success
  if (activated) {
    icon.className = 'toggle-modal-icon activate';
    if (iconFa) iconFa.className = 'fas fa-check-circle';
    title.textContent = '¬°Tipo Activado!';
    message.textContent = 'El tipo de empresa se ha activado exitosamente.';
  } else {
    icon.className = 'toggle-modal-icon deactivate';
    if (iconFa) iconFa.className = 'fas fa-times-circle';
    title.textContent = '¬°Tipo Desactivado!';
    message.textContent = 'El tipo de empresa se ha desactivado exitosamente.';
  }
  
  // Hide buttons temporarily
  if (typeof gsap !== 'undefined') {
    gsap.to(buttons, {
      opacity: 0,
      duration: 0.3,
      onComplete: () => {
        buttons.style.display = 'none';
      }
    });
    
    // Animate success state
    gsap.to(icon, {
      scale: 1.2,
      duration: 0.3,
      ease: "back.out(1.7)"
    });
  } else {
    buttons.style.display = 'none';
  }
  
  // Auto-close after 2 seconds
  setTimeout(() => {
    closeToggleModal();
    setTimeout(() => {
      location.reload();
    }, 500);
  }, 2000);
}

// Funci√≥n para llamar desde toggleStatus - ADAPTADA
async function toggleStatus(id, currentStatus) {
  console.log('üéØ toggleStatus called with:', { id, currentStatus });
  
  // Obtener el nombre del tipo para mostrar en el modal
  const card = document.querySelector(`[data-type-id="${id}"]`);
  console.log('üîç Card found:', card);
  
  const typeName = card ? card.querySelector('.ios-card-title').textContent : 'este tipo de empresa';
  console.log('üìã Type name found:', typeName);
  
  openToggleCompanyTypeModal(id, currentStatus, typeName);
}

// ===== MODAL DE ACTUALIZACI√ìN - EXACTO DE HARDWARE =====

// Client Update Modal Functions - COPIADO EXACTO DE HARDWARE
function showClientUpdateModal(message = 'El tipo de empresa se ha actualizado exitosamente.') {
  console.log('üîÑ Showing client update modal:', message);
  
  const modal = document.getElementById('clientUpdateModal');
  const container = document.getElementById('updateModalContainer');
  const icon = document.getElementById('updateModalIcon');
  const iconFa = document.getElementById('updateModalIconFa');
  const title = document.getElementById('updateModalTitle');
  const messageEl = document.getElementById('updateModalMessage');
  
  if (!modal || !container || !title || !messageEl) {
    console.error('‚ùå Client update modal elements missing!');
    return;
  }
  
  // Set success styling with separate classes
  if (icon) icon.className = 'client-update-icon';
  if (iconFa) iconFa.className = 'fas fa-check-circle';
  
  // Set dynamic title based on message
  if (message.includes('creado')) {
    title.textContent = '¬°Tipo Creado!';
  } else if (message.includes('actualizado')) {
    title.textContent = '¬°Tipo Actualizado!';
  } else {
    title.textContent = '¬°Operaci√≥n Exitosa!';
  }
  
  messageEl.textContent = message;
  
  // Show modal
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  console.log('‚úÖ Client update modal should now be visible');
  
  // Simple animation
  if (typeof gsap !== 'undefined') {
    gsap.set(container, { scale: 0.8, opacity: 0 });
    gsap.to(container, {
      scale: 1,
      opacity: 1,
      duration: 0.4,
      ease: "back.out(1.7)"
    });
    
    if (icon) {
      gsap.to(icon, {
        scale: 1.1,
        duration: 0.6,
        repeat: 1,
        yoyo: true,
        ease: "power2.inOut"
      });
    }
  } else {
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }
  
  // NO auto-close - wait for user interaction
  console.log('‚è∞ Modal will stay open until user clicks Aceptar or clicks outside');
}

// Close update modal - COPIADO EXACTO DE HARDWARE
function closeUpdateModal() {
  console.log('üîÑ Closing client update modal');
  
  const modal = document.getElementById('clientUpdateModal');
  const container = document.getElementById('updateModalContainer');
  
  if (!modal) {
    console.error('‚ùå Client update modal not found when trying to close');
    return;
  }
  
  // Simple close animation
  if (typeof gsap !== 'undefined' && container) {
    gsap.to(container, {
      scale: 0.8,
      opacity: 0,
      duration: 0.3,
      ease: "power2.in",
      onComplete: () => {
        resetAndHideUpdateModal();
      }
    });
  } else {
    resetAndHideUpdateModal();
  }
  
  function resetAndHideUpdateModal() {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    console.log('‚úÖ Update modal closed and reset');
  }
}

// Funci√≥n exportTypes simplificada - USANDO MODAL DE HARDWARE
function exportTypes() {
  // Usar el mismo modal de success de hardware adaptado
  showClientUpdateModal('Los tipos de empresa se est√°n exportando. El archivo CSV se descargar√° autom√°ticamente.');
}

// Variable global para trackear el estado actual
let currentShowingInactive = {{ 'true' if include_inactive else 'false' }};

// Funci√≥n para sincronizar estado del bot√≥n con variable global
function syncButtonState() {
  const button = document.querySelector('button[onclick="toggleIncludeInactive()"]');
  if (!button) return;
  
  const buttonIcon = button.querySelector('i');
  const buttonText = button.querySelector('span');
  
  if (currentShowingInactive) {
    // Mostrando todos - bot√≥n debe decir "Solo Activos"
    button.classList.remove('ios-action-btn-secondary');
    button.classList.add('ios-action-btn-warning');
    if (buttonIcon) buttonIcon.className = 'fas fa-eye-slash';
    if (buttonText) buttonText.textContent = 'Solo Activos';
  } else {
    // Mostrando solo activos - bot√≥n debe decir "Ver Todos"
    button.classList.remove('ios-action-btn-warning');
    button.classList.add('ios-action-btn-secondary');
    if (buttonIcon) buttonIcon.className = 'fas fa-eye';
    if (buttonText) buttonText.textContent = 'Ver Todos';
  }
  
  console.log(`üîÑ Button state synced. Showing inactive: ${currentShowingInactive}`);
}

// SIMPLIFIED: Toggle between showing only active or all types - ARREGLADO
function toggleIncludeInactive() {
  // Usar variable global que se actualiza din√°micamente
  const newShowInactive = !currentShowingInactive;
  
  console.log(`üîÑ Toggle: Currently showing inactive: ${currentShowingInactive}, New: ${newShowInactive}`);
  
  // Actualizar variable global
  currentShowingInactive = newShowInactive;
  
  // Sincronizar apariencia del bot√≥n
  syncButtonState();
  
  // Filter types by active status - SIMPLE!
  filterTypesByActiveStatus(newShowInactive);
  
  // Update URL without page reload
  const currentUrl = new URL(window.location);
  if (newShowInactive) {
    currentUrl.searchParams.set('include_inactive', 'true');
  } else {
    currentUrl.searchParams.delete('include_inactive');
  }
  window.history.replaceState({}, '', currentUrl.toString());
  
  console.log(`‚úÖ Toggle completed. New state: ${currentShowingInactive}`);
}

// SIMPLE: Filter types by checking 'activo' field - no complex logic needed!
function filterTypesByActiveStatus(showInactive) {
  console.log(`üéØ Simple filter: showInactive=${showInactive}`);
  
  const typeCards = document.querySelectorAll('.company-type-item');
  let visibleCount = 0;
  
  typeCards.forEach(card => {
    // Get the active status directly from the data attribute
    const isActive = card.dataset.status === 'true';
    
    // Simple logic: show if active OR if we want to show inactive too
    if (isActive || showInactive) {
      card.style.display = '';
      card.classList.remove('hidden');
      visibleCount++;
    } else {
      card.style.display = 'none';
      card.classList.add('hidden');
    }
  });
  
  // Update header badge to show current filter
  updateHeaderBadge(showInactive, visibleCount);
  
  console.log(`‚ú® Filter applied: ${visibleCount} types visible`);
}

// Simple header badge update - HARDWARE STYLE
function updateHeaderBadge(showInactive, visibleCount) {
  const headerSubtitle = document.querySelector('.ios-header-subtitle');
  if (headerSubtitle) {
    const badgeSpan = headerSubtitle.querySelector('span');
    if (badgeSpan) {
      if (showInactive) {
        badgeSpan.className = 'inline-block ml-2 px-2 py-1 bg-orange-500 text-white text-xs rounded-full';
        badgeSpan.textContent = `Mostrando todos (${visibleCount} tipos)`;
      } else {
        badgeSpan.className = 'inline-block ml-2 px-2 py-1 bg-green-500 text-white text-xs rounded-full';
        badgeSpan.textContent = `Solo activos (${visibleCount} tipos)`;
      }
    }
  }
}

// Function to view companies of a specific type
function viewCompaniesOfType(typeId, typeName) {
  console.log(`üìã Viendo empresas del tipo: ${typeName} (${typeId})`);
  
  // Navigate to empresas page with filter by type
  const empresasUrl = new URL('/admin/empresas', window.location.origin);
  empresasUrl.searchParams.set('tipo_empresa_id', typeId);
  empresasUrl.searchParams.set('tipo_empresa_nombre', typeName);
  
  // Show loading state
  const button = event.target.closest('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Cargando...</span>';
  button.disabled = true;
  
  // Navigate to empresas with filter
  window.location.href = empresasUrl.toString();
}

// Features management
function addFeature() {
  const input = document.getElementById('featureInput');
  const feature = input.value.trim();
  
  if (feature && !currentFeatures.includes(feature)) {
    if (currentFeatures.length >= 20) {
      showEnhancedNotification('No se pueden agregar m√°s de 20 caracter√≠sticas', 'error');
      return;
    }
    if (feature.length > 100) {
      showEnhancedNotification('La caracter√≠stica no puede exceder 100 caracteres', 'error');
      return;
    }
    currentFeatures.push(feature);
    input.value = '';
    updateFeaturesList();
  } else if (currentFeatures.includes(feature)) {
    showEnhancedNotification('Esta caracter√≠stica ya existe', 'error');
  }
}

function removeFeature(index) {
  currentFeatures.splice(index, 1);
  updateFeaturesList();
}

function updateFeaturesList() {
  const container = document.getElementById('featuresList');
  container.innerHTML = currentFeatures.map((feature, index) => `
    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${feature}</span>
      <button type="button" class="text-red-500 hover:text-red-700 ml-2" onclick="removeFeature(${index})">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
  
  // Add appear animation to new features
  const newFeatures = container.querySelectorAll('div');
  newFeatures.forEach((item, index) => {
    if (window.CompanyTypesAnimations) {
      window.CompanyTypesAnimations.animateFeatureTag(item);
    }
  });
}

function handleFeatureKeyPress(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    addFeature();
  }
}

// Color input synchronization - COMMENTED OUT (elements don't exist)
// document.getElementById('typeColor').addEventListener('change', function() {
//   document.getElementById('typeColorHex').value = this.value;
// });

// document.getElementById('typeColorHex').addEventListener('input', function() {
//   if (/^#[0-9A-F]{6}$/i.test(this.value)) {
//     document.getElementById('typeColor').value = this.value;
//   }
// });

// API Helper functions
async function callAPI(method, endpoint, data = null) {
  const options = {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include'  // Incluir cookies de sesi√≥n para autenticaci√≥n
  };
  
  if (data) {
    options.body = JSON.stringify(data);
  }
  
  try {
    console.log(`üîÑ API Call: ${method} ${endpoint}`);
    const response = await fetch(`/proxy${endpoint}`, options);
    const result = await response.json();
    
    console.log(`üì° API Response: ${response.status}`, result);
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('No autorizado. Por favor, inicia sesi√≥n nuevamente.');
      }
      throw new Error(result.errors ? result.errors.join(', ') : result.message || 'Error en la operaci√≥n');
    }
    
    return result;
  } catch (error) {
    console.error('üí• Error en API:', error);
    throw error;
  }
}


// Enhanced notification system like hardware
function showEnhancedNotification(message, type = 'info') {
  // Remove existing notifications
  const existingNotifications = document.querySelectorAll('.enhanced-notification');
  existingNotifications.forEach(notification => notification.remove());
  
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `enhanced-notification fixed top-4 right-4 z-50 max-w-sm w-full`;
  
  let iconClass, bgClass, borderClass;
  if (type === 'error') {
    iconClass = 'fas fa-exclamation-circle';
    bgClass = 'bg-red-500';
    borderClass = 'border-red-600';
  } else {
    iconClass = 'fas fa-check-circle';
    bgClass = 'bg-green-500';
    borderClass = 'border-green-600';
  }
  
  notification.innerHTML = `
    <div class="${bgClass} ${borderClass} border-l-4 text-white p-4 rounded-lg shadow-xl backdrop-blur-sm">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <i class="${iconClass} text-xl"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium">${message}</p>
        </div>
        <div class="ml-auto pl-3">
          <button onclick="closeNotification(this)" class="text-white hover:text-gray-200 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Add to document
  document.body.appendChild(notification);
  
  // GSAP animations if available
  if (typeof gsap !== 'undefined') {
    gsap.set(notification, { x: 400, opacity: 0 });
    
    const tl = gsap.timeline();
    tl.to(notification, {
      x: 0,
      opacity: 1,
      duration: 0.5,
      ease: "back.out(1.7)"
    })
    .to(notification, {
      scale: 1.05,
      duration: 0.1,
      yoyo: true,
      repeat: 1,
      ease: "power2.inOut"
    }, "-=0.2");
  }
  
  // Auto-remove after 4 seconds
  setTimeout(() => {
    closeNotification(notification.querySelector('button'));
  }, 4000);
}

// Close notification with animation
function closeNotification(button) {
  const notification = button.closest('.enhanced-notification');
  if (notification) {
    if (typeof gsap !== 'undefined') {
      gsap.to(notification, {
        x: 400,
        opacity: 0,
        duration: 0.3,
        ease: "back.in(1.7)",
        onComplete: () => notification.remove()
      });
    } else {
      notification.remove();
    }
  }
}

// Legacy function for compatibility
function showNotification(message, type = 'info') {
  showEnhancedNotification(message, type);
}

// Form submission with real API calls - FIXED
document.getElementById('companyTypeForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  console.log('üöÄ Form submission started');
  
  // Validation
  const typeName = document.getElementById('typeName');
  const typeDescription = document.getElementById('typeDescription');
  const typeStatus = document.getElementById('typeStatus');
  const submitBtn = document.querySelector('#submitButtonText');
  
  if (!typeName || !typeDescription || !typeStatus || !submitBtn) {
    console.error('‚ùå Form elements missing:', {
      typeName: !!typeName,
      typeDescription: !!typeDescription,
      typeStatus: !!typeStatus,
      submitBtn: !!submitBtn
    });
    showEnhancedNotification('Error: Elementos del formulario no encontrados', 'error');
    return;
  }
  
  if (!typeName.value.trim() || !typeDescription.value.trim()) {
    showEnhancedNotification('Por favor completa todos los campos obligatorios', 'error');
    return;
  }
  
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Guardando...';
  
  const formData = {
    nombre: typeName.value.trim(),
    descripcion: typeDescription.value.trim(),
    caracteristicas: currentFeatures || [],
    activo: typeStatus.value === 'true'
  };
  
  console.log('üì§ Sending data:', formData);
  
  try {
    let result;
    if (editingCompanyType) {
      // Update existing type
      console.log('üîÑ Updating existing type:', editingCompanyType);
      result = await callAPI('PUT', `/api/tipos_empresa/${editingCompanyType}`, formData);
      showClientUpdateModal('El tipo de empresa se ha actualizado exitosamente.');
    } else {
      // Create new type
      console.log('‚ú® Creating new type');
      result = await callAPI('POST', '/api/tipos_empresa', formData);
      showClientUpdateModal('El nuevo tipo de empresa se ha creado exitosamente.');
    }
    
    console.log('‚úÖ Operation successful:', result);
    closeModal();
    
    // Reload page to show changes
    setTimeout(() => {
      location.reload();
    }, 1500);
    
  } catch (error) {
    console.error('üí• Form submission error:', error);
    showEnhancedNotification(error.message, 'error');
    submitBtn.textContent = originalText;
  }
});

// Close modals when clicking outside
document.getElementById('companyTypeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

document.getElementById('detailsModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDetailsModal();
  }
});

// Event listeners para modales iOS - ADAPTADOS DE HARDWARE
document.getElementById('toggleCompanyTypeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeToggleModal();
  }
});

document.getElementById('clientUpdateModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeUpdateModal();
  }
});

// Close modal with Escape key - ADAPTADO DE HARDWARE
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Check which modal is open and close it
    const companyTypeModal = document.getElementById('companyTypeModal');
    const detailsModal = document.getElementById('detailsModal');
    const toggleCompanyTypeModal = document.getElementById('toggleCompanyTypeModal');
    const clientUpdateModal = document.getElementById('clientUpdateModal');
    
    if (!companyTypeModal.classList.contains('hidden')) {
      closeModal();
    } else if (!detailsModal.classList.contains('hidden')) {
      closeDetailsModal();
    } else if (!toggleCompanyTypeModal.classList.contains('hidden')) {
      closeToggleModal();
    } else if (!clientUpdateModal.classList.contains('hidden')) {
      closeUpdateModal();
    }
  }
});

</script>
{% endblock %}
