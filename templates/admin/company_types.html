{% extends "admin/dashboard.html" %}

{% block title %}Tipos de Empresa - Sistema Multi-Tenant{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="{{ url_for('static', filename='css/modals.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/hardware/hardware-main.css') }}" rel="stylesheet">
<style>
/* Asegurar visibilidad por defecto - OVERRIDE para tipos de empresa */
.ios-header-container,
.ios-stats-grid .ios-stat-card,
.ios-hardware-grid .ios-hardware-card {
  opacity: 1 !important;
  transform: none !important;
  visibility: visible !important;
}

/* Asegurar que las tarjetas sean visibles desde el inicio */
.company-type-item {
  opacity: 1 !important;
  transform: none !important;
  visibility: visible !important;
}

/* Estilos específicos para tipos de empresa */
.company-type-item .ios-info-label {
  display: flex;
  align-items: center;
  font-size: 0.75rem;
}

/* Hacer que ciertos elementos ocupen fila completa */
.company-type-item .ios-info-item.full-width {
  grid-column: 1 / -1; /* Ocupa toda la fila en el grid */
  width: 100%;
  margin-bottom: 8px;
}

.company-type-item .ios-card-info {
  display: grid;
  grid-template-columns: 1fr 1fr; /* Dos columnas por defecto */
  gap: 8px;
}

.company-type-item .ios-card-subtitle {
  max-height: 3rem;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* Botón específico para ver empresas */
.ios-card-btn-info {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.ios-card-btn-info:hover {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

/* Tags de características mejorados para ambos temas */
.company-type-item span[class*="bg-blue"],
.company-type-item span[class*="bg-gray"] {
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.company-type-item span[class*="bg-blue"]:hover,
.company-type-item span[class*="bg-gray"]:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Tema claro - colores sólidos y fuertes */
@media (prefers-color-scheme: light) {
  .company-type-item span[class*="bg-blue"]:hover {
    background: #1d4ed8 !important; /* Azul más fuerte */
    border-color: #1e3a8a !important;
  }
  
  .company-type-item span[class*="bg-gray"]:hover {
    background: #374151 !important; /* Gris más fuerte */
    border-color: #1f2937 !important;
  }
}

/* Tema oscuro - mantener estilos transparentes */
@media (prefers-color-scheme: dark) {
  .company-type-item span[class*="bg-blue"]:hover {
    background: rgba(59, 130, 246, 0.4) !important;
    border-color: rgba(59, 130, 246, 0.5) !important;
  }
  
  .company-type-item span[class*="bg-gray"]:hover {
    background: rgba(107, 114, 128, 0.4) !important;
    border-color: rgba(107, 114, 128, 0.5) !important;
  }
}
</style>
{% endblock %}

{% block main_content %}
<div class="company-types-container">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Enhanced iOS Header - HARDWARE STYLE -->
    <div class="ios-header-container mb-8">
      <div class="ios-header-backdrop">
        <div class="ios-header-content">
          <div class="ios-header-text">
            <div class="ios-header-icon">
              <i class="fas fa-layer-group"></i>
            </div>
            <div>
            <h1 class="ios-header-title text-3xl md:text-4xl font-bold text-white dark:text-white">Gestión de Tipos de Empresa</h1>
              <p class="ios-header-subtitle text-base md:text-lg text-white/80 dark:text-gray-300">
                Administra las categorías con tecnología de vanguardia
                {% if include_inactive %}
                  <span class="inline-block ml-2 px-2 py-1 bg-orange-500 text-white text-xs font-medium rounded-full">
                    Mostrando todos ({{ company_types_data.company_types|length }} tipos)
                  </span>
                {% else %}
                  <span class="inline-block ml-2 px-2 py-1 bg-green-500 text-white text-xs font-medium rounded-full">
                    Solo activos ({{ company_types_data.company_types|length }} tipos)
                  </span>
                {% endif %}
              </p>
            </div>
          </div>
          <div class="ios-header-actions">
          <button class="ios-action-btn ios-action-btn-secondary" onclick="exportTypes()">
              <i class="fas fa-download"></i>
              <span class="text-sm font-medium">Exportar</span>
            </button>
            <button class="ios-action-btn {% if include_inactive %}ios-action-btn-warning{% else %}ios-action-btn-secondary{% endif %}" onclick="toggleIncludeInactive()">
              <i class="fas fa-{% if include_inactive %}eye-slash{% else %}eye{% endif %}"></i>
              <span class="text-sm font-medium">{% if include_inactive %}Solo Activos{% else %}Ver Todos{% endif %}</span>
            </button>
            <button class="ios-action-btn ios-action-btn-primary" onclick="openCreateModal()">
              <i class="fas fa-plus"></i>
              <span class="text-sm font-medium">Nuevo Tipo</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced iOS Stats Cards - HARDWARE STYLE -->
    <div class="ios-stats-grid">
      <div class="ios-stat-card" data-stat="total">
        <div class="ios-stat-icon ios-stat-icon-blue">
          <i class="fas fa-layer-group"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Total Tipos</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="totalTypesCount">{{ company_types_data.company_types_stats.total_types }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Categorías disponibles</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
      
      <div class="ios-stat-card" data-stat="active">
        <div class="ios-stat-icon ios-stat-icon-green">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Activos</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="activeTypesCount">{{ company_types_data.company_types_stats.active_types }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Funcionando correctamente</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
      
      <div class="ios-stat-card" data-stat="companies">
        <div class="ios-stat-icon ios-stat-icon-purple">
          <i class="fas fa-building"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Total Empresas</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="totalCompaniesCount">{{ company_types_data.company_types_stats.total_companies }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Empresas categorizadas</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
      
      <div class="ios-stat-card" data-stat="average">
        <div class="ios-stat-icon ios-stat-icon-orange">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="ios-stat-content">
          <div class="ios-stat-label text-sm font-medium text-gray-600 dark:text-gray-400">Promedio por Tipo</div>
          <div class="ios-stat-value text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="avgCompaniesCount">{{ company_types_data.company_types_stats.avg_companies_per_type }}</div>
          <div class="ios-stat-trend text-xs text-gray-500 dark:text-gray-500">Distribución equilibrada</div>
        </div>
        <div class="ios-stat-shimmer"></div>
      </div>
    </div>


  <!-- Enhanced iOS Company Types Grid - HARDWARE STYLE CON CONTENIDO ESPECÍFICO -->
    <div class="ios-hardware-grid" id="companyTypesGrid">
      {% for company_type in company_types_data.company_types %}
      {# Filtrar por estado activo según el parámetro include_inactive #}
      {% if include_inactive or company_type.active %}
      <div class="ios-hardware-card company-type-item" data-type-id="{{ company_type.id }}" data-status="{{ company_type.active|lower }}">
        <div class="ios-card-header">
          <div class="ios-card-icon">
            <i class="fas fa-layer-group"></i>
          </div>
          <span class="ios-status-badge {% if company_type.active %}ios-status-available{% else %}ios-status-discontinued{% endif %} text-xs font-semibold">
            {% if company_type.active %}✅ Activo{% else %}⚫ Inactivo{% endif %}
          </span>
        </div>
        
        <h3 class="ios-card-title text-xl font-semibold text-gray-900 dark:text-white">{{ company_type.name }}</h3>
        <p class="ios-card-subtitle text-sm text-gray-600 dark:text-gray-400 leading-relaxed">{{ company_type.description }}</p>
        
        <!-- Sección específica para tipos de empresa -->
        <div class="ios-card-info">
          <!-- Empresas asociadas - FILA COMPLETA -->
          <div class="ios-info-item full-width">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-building text-purple-400 mr-1"></i>
              Empresas asociadas
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ company_type.companies_count }}</span>
          </div>
          
          <!-- Características y Distribución - MISMA FILA -->
          {% if company_type.features and company_type.features|length > 0 %}
          <div class="ios-info-item">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-tags text-blue-400 mr-1"></i>
              Características
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ company_type.features|length }}</span>
          </div>
          {% endif %}
          {% if company_type.companies_count > 0 %}
          <div class="ios-info-item">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-chart-bar text-green-400 mr-1"></i>
              Distribución
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(company_type.companies_count / company_types_data.company_types_stats.total_types) }}%</span>
          </div>
          {% endif %}
          
          <!-- Fecha de creación - FILA COMPLETA -->
          <div class="ios-info-item full-width">
            <span class="ios-info-label text-xs font-medium text-gray-600 dark:text-gray-400">
              <i class="fas fa-calendar text-orange-400 mr-1"></i>
              Fecha de creación
            </span>
            <span class="ios-info-value text-sm font-bold text-gray-900 dark:text-white">{{ company_type.created_at }}</span>
          </div>
        </div>
        
        <!-- Características destacadas mejoradas (si existen) -->
        {% if company_type.features and company_type.features|length > 0 %}
        <div class="mt-4 mb-3">
          <div class="flex items-center justify-between mb-3">
            <div class="text-xs font-bold text-blue-800 dark:text-blue-400 flex items-center">
              <i class="fas fa-tags mr-2 text-blue-700 dark:text-blue-400"></i>
              <span>Características principales</span>
            </div>
            <div class="text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700/50 px-2 py-1 rounded-full">
              {{ company_type.features|length }} total
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            {% for feature in company_type.features[:4] %}
            {% set color_index = loop.index0 % 6 %}
            {% set colors = [
              'bg-gradient-to-r from-purple-500 to-pink-500 border-purple-300 shadow-purple-200',
              'bg-gradient-to-r from-blue-500 to-indigo-500 border-blue-300 shadow-blue-200',
              'bg-gradient-to-r from-green-500 to-emerald-500 border-green-300 shadow-green-200',
              'bg-gradient-to-r from-yellow-500 to-orange-500 border-yellow-300 shadow-yellow-200',
              'bg-gradient-to-r from-red-500 to-rose-500 border-red-300 shadow-red-200',
              'bg-gradient-to-r from-indigo-500 to-purple-500 border-indigo-300 shadow-indigo-200'
            ] %}
            <div class="feature-tag group {{ colors[color_index] }} text-white text-xs font-semibold rounded-lg border border-opacity-30 px-3 py-2 shadow-sm hover:shadow-md transform hover:scale-105 transition-all duration-200">
              <div class="flex items-center justify-between">
                <span class="truncate flex-1 drop-shadow-sm">{{ feature }}</span>
                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 ml-2">
                  <i class="fas fa-sparkles text-xs"></i>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if company_type.features|length > 4 %}
            <div class="feature-tag-more group bg-gradient-to-r from-slate-600 to-gray-700 text-white text-xs font-semibold rounded-lg border border-slate-400 border-opacity-30 px-3 py-2 shadow-sm hover:shadow-md transform hover:scale-105 transition-all duration-200 col-span-1 sm:col-span-2">
              <div class="flex items-center justify-center">
                <i class="fas fa-plus-circle mr-2 opacity-70 group-hover:opacity-100 transition-opacity"></i>
                <span class="drop-shadow-sm">{{ company_type.features|length - 4 }} características adicionales</span>
                <i class="fas fa-arrow-right ml-2 opacity-0 group-hover:opacity-100 transition-all duration-200 transform group-hover:translate-x-1"></i>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- Botones de acción específicos para tipos de empresa -->
        <div class="ios-card-actions">
          <button class="ios-card-btn" onclick="viewCompanyType('{{ company_type.id }}')" title="Ver detalles completos">
            <i class="fas fa-eye"></i>
          </button>
          {% if company_type.companies_count > 0 %}
          <button class="ios-card-btn ios-card-btn-info" onclick="viewCompaniesOfType('{{ company_type.id }}', '{{ company_type.name }}')" title="Ver empresas de este tipo">
            <i class="fas fa-building"></i>
          </button>
          {% endif %}
          <button class="ios-card-btn ios-card-btn-primary" onclick="editCompanyType('{{ company_type.id }}')" title="Editar tipo">
            <i class="fas fa-edit"></i>
          </button>
          <button class="ios-card-btn {{ company_type.active and 'ios-card-btn-warning' or 'ios-card-btn-success' }}" 
                  onclick="toggleStatus('{{ company_type.id }}', {{ company_type.active|lower }})" 
                  title="{{ company_type.active and 'Desactivar tipo' or 'Activar tipo' }}">
            <i class="fas {{ company_type.active and 'fa-power-off' or 'fa-play' }}"></i>
          </button>
        </div>
        
        <!-- iOS Card Shimmer Effect -->
        <div class="ios-card-shimmer"></div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
</div>
</div>

<!-- Create/Edit Company Type Modal - EXACT HARDWARE STYLE -->
<div id="companyTypeModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-4xl">
    <!-- Modal Header -->
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-layer-group text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white dark:text-white" id="modalTitle">Nuevo Tipo de Empresa</h3>
            <p class="text-sm text-white/70 dark:text-gray-300">Complete los campos para registrar el tipo</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" onclick="closeModal()" aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="ios-blur-body">
      <form id="companyTypeForm">
        <div class="form-grid">
          <!-- Nombre -->
          <div class="form-group">
            <label for="typeName" class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-tag text-purple-400 mr-2"></i>Nombre *
            </label>
            <input type="text" id="typeName" class="ios-blur-input" required
                   placeholder="Ej: Tecnología">
          </div>
          
          <!-- Estado -->
          <div class="form-group">
            <label for="typeStatus" class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-toggle-on text-blue-400 mr-2"></i>Estado *
            </label>
            <select id="typeStatus" class="ios-blur-input" required>
              <option value="true" class="text-sm">🟢 Activo</option>
              <option value="false" class="text-sm">🔴 Inactivo</option>
            </select>
          </div>
          
          <!-- Descripción -->
          <div class="form-group form-group-full">
            <label for="typeDescription" class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-align-left text-cyan-400 mr-2"></i>Descripción *
            </label>
            <textarea id="typeDescription" class="ios-blur-input !min-h-[6rem] resize-y" rows="3" required
                      placeholder="Describe el tipo de empresa, sus características principales..."></textarea>
          </div>
          
          <!-- Características -->
          <div class="form-group form-group-full">
            <label class="block text-sm font-semibold text-white/90 dark:text-gray-200 mb-2">
              <i class="fas fa-list text-orange-400 mr-2"></i>Características
            </label>
            <div id="featuresContainer" class="space-y-3">
              <div class="flex space-x-2">
                <input type="text" id="featureInput" placeholder="Agregar característica..." 
                       class="ios-blur-input flex-1" onkeypress="handleFeatureKeyPress(event)">
                <button type="button" class="ios-blur-btn ios-blur-btn-primary !p-2 !min-w-0" onclick="addFeature()">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div id="featuresList" class="space-y-2">
                <!-- Features will be displayed here -->
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Modal Footer -->
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" onclick="closeModal()">
        <i class="fas fa-times mr-2"></i>
        <span class="text-sm font-medium">Cancelar</span>
      </button>
      <button type="submit" form="companyTypeForm" class="ios-blur-btn ios-blur-btn-primary" id="submitButton">
        <i class="fas fa-save mr-2"></i>
        <span id="submitButtonText" class="text-sm font-medium">Crear Tipo</span>
      </button>
    </div>
  </div>
</div>

<!-- View Details Modal - EXACT HARDWARE STYLE -->
<div id="detailsModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container w-full max-w-4xl">
    <!-- Modal Header -->
    <div class="ios-blur-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-eye text-white text-xl"></i>
          </div>
          <div>
            <h3 class="text-2xl font-bold text-white" id="detailsTitle">Detalles del Tipo</h3>
            <p class="text-sm text-white/70">Información completa del tipo seleccionado</p>
          </div>
        </div>
        <button type="button" class="ios-blur-btn ios-blur-btn-secondary !p-2 !min-w-0" onclick="closeDetailsModal()" aria-label="Cerrar modal">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="ios-blur-body">
      <div id="detailsContent" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Details will be loaded here using Hardware-style cards -->
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div class="ios-blur-footer">
      <button type="button" class="ios-blur-btn ios-blur-btn-secondary" onclick="closeDetailsModal()">
        <i class="fas fa-times mr-2"></i>
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Toggle Company Type Status Modal - EXACT COPY FROM HARDWARE -->
<div id="toggleCompanyTypeModal" class="ios-modal-backdrop toggle-modal hidden">
  <div class="ios-blur-modal-container max-w-md" id="toggleModalContainer">
    <div class="ios-blur-header text-center">
      <div class="toggle-modal-icon mx-auto mb-4" id="toggleModalIcon">
        <i class="fas fa-power-off text-4xl" id="toggleModalIconFa"></i>
      </div>
      <h3 class="text-2xl font-bold text-white dark:text-white mb-2" id="toggleModalTitle">Activar Tipo de Empresa</h3>
    </div>
    <div class="ios-blur-body text-center">
      <p class="text-white/80 dark:text-gray-300 text-lg mb-6" id="toggleModalMessage">
        ¿Estás seguro de que quieres activar este tipo de empresa?
      </p>
      <div class="flex gap-4 justify-center">
        <button class="ios-blur-btn ios-blur-btn-secondary" onclick="closeToggleModal()">
          <i class="fas fa-times mr-2"></i>
          <span class="text-sm font-medium">Cancelar</span>
        </button>
        <button class="ios-blur-btn ios-blur-btn-primary" id="toggleConfirmBtn" onclick="confirmToggleCompanyType()">
          <i class="fas fa-check mr-2" id="toggleConfirmIcon"></i>
          <span id="toggleConfirmText" class="text-sm font-medium">Activar</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Client Update Success Modal - EXACT COPY FROM HARDWARE -->
<div id="clientUpdateModal" class="ios-modal-backdrop hidden">
  <div class="ios-blur-modal-container max-w-md" id="updateModalContainer">
    <div class="ios-blur-header text-center">
      <div class="client-update-icon mx-auto mb-4" id="updateModalIcon">
        <i class="fas fa-sync-alt text-4xl text-emerald-400" id="updateModalIconFa"></i>
      </div>
      <h3 class="text-2xl font-bold text-white dark:text-white mb-2" id="updateModalTitle">Tipo Actualizado</h3>
    </div>
    <div class="ios-blur-body text-center">
      <p class="text-white/80 dark:text-gray-300 text-lg mb-6" id="updateModalMessage">
        El tipo de empresa se ha actualizado exitosamente.
      </p>
      <button class="ios-blur-btn ios-blur-btn-primary mx-auto" onclick="closeUpdateModal()">
        <i class="fas fa-check mr-2"></i>
        <span class="text-sm font-medium">Aceptar</span>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Modal Manager for consistent modal behavior -->
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
<!-- Hardware GSAP Animations - SAME AS HARDWARE -->
<script src="{{ url_for('static', filename='js/hardware-animations.js') }}"></script>
<!-- Performance optimizer específico para tipos de empresa -->
<script>
  // Función GLOBAL para aplicar optimizaciones a una tarjeta específica (usando GSAP global)
  function applyCardOptimizations(card) {
    // Usar las animaciones GSAP globales ya disponibles
    if (window.HardwareAnimations) {
      // Las animaciones de hover ya están configuradas en hardware-animations.js
      console.log('🔧 Optimizaciones GSAP aplicadas a tarjeta individual');
      return;
    }
    
    // Fallback para compatibilidad si GSAP no está disponible
    const shimmer = card.querySelector('.ios-card-shimmer');
    if (shimmer && !window.GSAPUtils?.prefersReducedMotion()) {
      shimmer.style.opacity = '0';
      shimmer.style.transform = 'rotate(45deg) translateX(-100%)';
      console.log('🔧 Fallback aplicado a tarjeta individual');
    }
  }
  
  // Función para aplicar optimizaciones a tarjetas ya existentes
  function applyOptimizationsToExistingCards() {
    const existingCards = document.querySelectorAll('.ios-hardware-card');
    existingCards.forEach(card => {
      applyCardOptimizations(card);
    });
    console.log(`🔧 Optimizaciones aplicadas a ${existingCards.length} tarjetas existentes`);
  }
  
  // Función para forzar visibilidad de elementos si GSAP falla
  function ensureContentVisibility() {
    const elements = [
      '.ios-header-container',
      '.ios-stats-grid .ios-stat-card',
      '.ios-hardware-grid .ios-hardware-card'
    ];
    
    elements.forEach(selector => {
      const elementsList = document.querySelectorAll(selector);
      elementsList.forEach(el => {
        el.style.opacity = '1';
        el.style.transform = 'none';
        el.style.visibility = 'visible';
      });
    });
    
    console.log('👁️ Forzada visibilidad de elementos');
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🛠️ Company Types page loaded with GSAP optimizations');
    
    // Asegurar que el contenido sea visible inmediatamente
    ensureContentVisibility();
    
    // Intentar usar animaciones de hardware
    if (window.HardwareAnimations) {
      console.log('✅ Usando HardwareAnimations para tipos de empresa');
      window.HardwareAnimations.init();
    } else {
      console.warn('⚠️ HardwareAnimations no disponible, usando fallback');
      // Fallback - asegurar que todo sea visible
      setTimeout(ensureContentVisibility, 100);
    }
    
    // Observer para tarjetas que se añaden dinámicamente
    const companyTypesGrid = document.getElementById('companyTypesGrid');
    if (companyTypesGrid) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.classList.contains('ios-hardware-card')) {
              console.log('👀 Nueva tarjeta detectada, aplicando animación GSAP...');
              
              // Usar animación GSAP para nueva tarjeta
              if (window.HardwareAnimations) {
                window.HardwareAnimations.animateNewCard(node);
              } else {
                applyCardOptimizations(node);
              }
            }
          });
        });
      });
      
      observer.observe(companyTypesGrid, {
        childList: true,
        subtree: true
      });
      
      console.log('👀 Observer configurado para detectar nuevas tarjetas');
    }
    
    console.log('✅ Company Types page optimizations applied successfully');
  });
</script>
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/api-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard/basic-managers.js') }}"></script>
<!-- Company Types Main JavaScript -->
<script src="{{ url_for('static', filename='js/company-types/company-types-main.js') }}"></script>
<script>
let editingCompanyType = null;
let currentFeatures = [];

// Debug function to check modal elements
function debugToggleModal() {
  console.log('🔍 Debugging toggle modal elements:');
  const elements = {
    modal: document.getElementById('toggleCompanyTypeModal'),
    container: document.getElementById('toggleModalContainer'),
    icon: document.getElementById('toggleModalIcon'),
    iconFa: document.getElementById('toggleModalIconFa'),
    title: document.getElementById('toggleModalTitle'),
    message: document.getElementById('toggleModalMessage'),
    confirmBtn: document.getElementById('toggleConfirmBtn'),
    confirmText: document.getElementById('toggleConfirmText'),
    confirmIcon: document.getElementById('toggleConfirmIcon')
  };
  
  Object.entries(elements).forEach(([name, element]) => {
    console.log(`  ${name}:`, element ? '✅ Found' : '❌ NOT FOUND');
  });
  
  return elements;
}

// SIMPLIFIED: Initialize page with direct filtering by 'activo' field
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Initializing company types with simple filtering');
  
  // Debug modal elements
  setTimeout(() => {
    debugToggleModal();
  }, 500);
  
  // Forzar visibilidad inmediata para evitar problemas
  const forceVisibility = () => {
    const allElements = document.querySelectorAll('.ios-header-container, .ios-stat-card, .ios-hardware-card, .company-type-item');
    allElements.forEach(el => {
      el.style.opacity = '1';
      el.style.transform = 'none';
      el.style.visibility = 'visible';
    });
    console.log(`👁️ Forzada visibilidad de ${allElements.length} elementos`);
  };
  
  // Ejecutar inmediatamente
  forceVisibility();
  
  // Inicializar filtro - por defecto solo mostrar tipos activos
  console.log(`🔧 Initializing with active-only filter: ${currentShowingInactive}`);
  
  // Leer parámetro URL para override si es necesario (pero default es false)
  const urlParams = new URLSearchParams(window.location.search);
  const includeInactiveParam = urlParams.get('include_inactive');
  if (includeInactiveParam === 'true') {
    currentShowingInactive = true;
    console.log('📋 URL override: showing all types including inactive');
  }
  
  // Apply initial filter - by default show only active types - INMEDIATAMENTE
  console.log('🎯 Applying initial filter immediately...');
  filterTypesByActiveStatus(currentShowingInactive);
  // Sincronizar estado del botón
  syncButtonState();
  // Forzar visibilidad nuevamente después del filtro
  forceVisibility();
  
  // También aplicar después de un pequeño delay por si hay elementos que cargan tarde
  setTimeout(() => {
    console.log('🔄 Re-applying filter after delay...');
    filterTypesByActiveStatus(currentShowingInactive);
    syncButtonState();
  }, 50);
});

// Función de test para probar el toggle modal
function testToggleModal() {
  console.log('🧪 Testing toggle modal...');
  openToggleCompanyTypeModal('test-id', true, 'Tipo de Prueba');
}

// Exponer para debug
window.testToggleModal = testToggleModal;
window.debugToggleModal = debugToggleModal;

// Modal functionality - EXACT HARDWARE STYLE
function openCreateModal() {
  editingCompanyType = null;
  currentFeatures = []; // Clear features array
  document.getElementById('modalTitle').textContent = 'Nuevo Tipo de Empresa';
  document.getElementById('submitButtonText').textContent = 'Crear Tipo';
  document.getElementById('companyTypeForm').reset();
  updateFeaturesList(); // Clear features display
  
  // Open modal using modal manager (handles scroll prevention) - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.openModal('companyTypeModal');
    window.modalManager.setupModal('companyTypeModal');
  } else {
    // Fallback for compatibility - EXACT HARDWARE STYLE
    const modal = document.getElementById('companyTypeModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.body.classList.add('modal-open');
  }
}

async function editCompanyType(id) {
  editingCompanyType = id;
  document.getElementById('modalTitle').textContent = 'Editar Tipo de Empresa';
  document.getElementById('submitButtonText').textContent = 'Actualizar Tipo';
  
  try {
    // Load the actual company type data from backend
    const response = await callAPI('GET', `/api/tipos_empresa/${id}`);
    if (response.success && response.data) {
      const data = response.data;
      document.getElementById('typeName').value = data.nombre || '';
      document.getElementById('typeStatus').value = data.activo ? 'true' : 'false';
      document.getElementById('typeDescription').value = data.descripcion || '';
      
      // Load features/characteristics
      currentFeatures = data.caracteristicas || [];
      updateFeaturesList();
    }
  } catch (error) {
    console.error('Error loading company type:', error);
    showEnhancedNotification('Error al cargar los datos del tipo de empresa', 'error');
    return;
  }
  
  // Open modal using modal manager (handles scroll prevention) - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.openModal('companyTypeModal');
    window.modalManager.setupModal('companyTypeModal');
  } else {
    // Fallback for compatibility - EXACT HARDWARE STYLE
    const modal = document.getElementById('companyTypeModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.body.classList.add('modal-open');
  }
}

function closeModal() {
  // Use modalManager (handles scroll restoration) - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.closeModal('companyTypeModal');
  } else {
    // Fallback for compatibility - EXACT HARDWARE STYLE
    const modal = document.getElementById('companyTypeModal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    document.body.classList.remove('modal-open');
  }
  
  editingCompanyType = null;
}

async function viewCompanyType(id) {
  try {
    const response = await callAPI('GET', `/api/tipos_empresa/${id}`);
    if (response.success && response.data) {
      const data = response.data;
      document.getElementById('detailsTitle').textContent = `Detalles: ${data.nombre}`;
      
      // Hardware-style colorful cards layout
      document.getElementById('detailsContent').innerHTML = `
        <div class="bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-tag mr-2 text-yellow-200"></i>Nombre del Tipo
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md">${data.nombre}</div>
        </div>
        
        <div class="bg-gradient-to-br from-${data.activo ? 'green' : 'red'}-500 via-${data.activo ? 'emerald' : 'pink'}-500 to-${data.activo ? 'teal' : 'rose'}-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-toggle-on mr-2 text-yellow-200"></i>Estado
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md">${data.activo ? '✅ Activo' : '❌ Inactivo'}</div>
        </div>
        
        <div class="bg-gradient-to-br from-orange-500 via-yellow-500 to-amber-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-building mr-2 text-yellow-200"></i>Empresas Asociadas
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md">${data.companies_count || data.empresas_count || 0} empresas</div>
        </div>
        
        <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-list mr-2 text-yellow-200"></i>Características
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md">${data.caracteristicas ? data.caracteristicas.length : 0} definidas</div>
        </div>
        
        <div class="bg-gradient-to-br from-slate-700 via-slate-800 to-slate-900 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-calendar-alt mr-2 text-yellow-200"></i>Fecha de Creación
          </label>
          <div class="text-xl font-bold text-white drop-shadow-md">${data.created_at || data.fecha_creacion || 'No disponible'}</div>
        </div>
        
        <div class="col-span-1 md:col-span-2 bg-gradient-to-br from-violet-600 via-purple-700 to-indigo-800 rounded-xl p-5 shadow-lg transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-3 drop-shadow-lg">
            <i class="fas fa-align-left mr-2 text-yellow-200"></i>Descripción
          </label>
          <div class="text-lg font-medium text-white drop-shadow-md leading-relaxed">
            ${data.descripcion || '<em class="text-gray-200">Sin descripción disponible</em>'}
          </div>
        </div>
        
        ${data.caracteristicas && data.caracteristicas.length > 0 ? `
        <div class="col-span-1 md:col-span-2 bg-gradient-to-br from-emerald-600 via-teal-700 to-cyan-800 rounded-xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300">
          <label class="block text-sm font-bold text-white mb-4 drop-shadow-lg">
            <i class="fas fa-tags mr-2 text-yellow-200"></i>Lista de Características
            <span class="ml-2 text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">${data.caracteristicas.length} total</span>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-4">
            ${data.caracteristicas.map((feature, index) => {
              const colors = [
                'from-purple-500 to-pink-500 border-purple-300',
                'from-blue-500 to-indigo-500 border-blue-300',
                'from-green-500 to-emerald-500 border-green-300',
                'from-yellow-500 to-orange-500 border-yellow-300',
                'from-red-500 to-pink-500 border-red-300',
                'from-indigo-500 to-purple-500 border-indigo-300',
                'from-teal-500 to-cyan-500 border-teal-300',
                'from-orange-500 to-red-500 border-orange-300'
              ];
              const colorClass = colors[index % colors.length];
              return `
                <div class="group bg-gradient-to-br ${colorClass} rounded-lg p-3 shadow-md transform hover:scale-105 hover:shadow-lg transition-all duration-300 border border-opacity-30">
                  <div class="flex items-center justify-between">
                    <span class="text-white font-semibold text-sm drop-shadow-sm group-hover:drop-shadow-md transition-all">${feature}</span>
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                      <i class="fas fa-sparkles text-white text-xs"></i>
                    </div>
                  </div>
                  <div class="mt-2 h-1 bg-white bg-opacity-20 rounded-full overflow-hidden">
                    <div class="h-full bg-white bg-opacity-40 rounded-full animate-pulse"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="mt-4 pt-3 border-t border-white border-opacity-20">
            <div class="flex items-center justify-between text-xs text-white text-opacity-80">
              <span><i class="fas fa-info-circle mr-1"></i>Características definidas para este tipo</span>
              <span><i class="fas fa-clock mr-1"></i>Última actualización</span>
            </div>
          </div>
        </div>
        ` : ''}
      `;
    }
  } catch (error) {
    console.error('Error loading company type details:', error);
    showEnhancedNotification('Error al cargar los detalles del tipo de empresa', 'error');
    return;
  }
  
  // Open modal using modal manager - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.openModal('detailsModal');
    window.modalManager.setupModal('detailsModal');
  } else {
    // Fallback for compatibility - EXACT HARDWARE STYLE
    const modal = document.getElementById('detailsModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.body.classList.add('modal-open');
  }
}

function closeDetailsModal() {
  // Use modalManager for consistent closing - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.closeModal('detailsModal');
  } else {
    // Fallback for compatibility - EXACT HARDWARE STYLE
    const modal = document.getElementById('detailsModal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    document.body.classList.remove('modal-open');
  }
}


// ===== EXACT COPY FROM HARDWARE - ADAPTED FOR COMPANY TYPES =====

// Variables para el modal de toggle - IGUAL QUE HARDWARE
let toggleModalData = {
  typeId: null,
  newStatus: null
};

// Función para abrir modal de toggle - ADAPTADA DE HARDWARE
function openToggleCompanyTypeModal(id, currentStatus, typeName) {
  console.log('🔄 Opening toggle modal for company type:', id, 'current status:', currentStatus);
  
  const newStatus = !currentStatus;
  const action = newStatus ? 'activar' : 'desactivar';
  
  // Guardar datos para el modal
  toggleModalData.typeId = id;
  toggleModalData.newStatus = newStatus;
  
  // Configurar el modal
  const modal = document.getElementById('toggleCompanyTypeModal');
  const container = document.getElementById('toggleModalContainer');
  const icon = document.getElementById('toggleModalIcon');
  const iconFa = document.getElementById('toggleModalIconFa');
  const title = document.getElementById('toggleModalTitle');
  const message = document.getElementById('toggleModalMessage');
  const confirmText = document.getElementById('toggleConfirmText');
  const confirmIcon = document.getElementById('toggleConfirmIcon');
  
  if (!modal || !container || !title || !message) {
    console.error('❌ Toggle modal elements missing!');
    // Fallback to simple confirm
    if (confirm(`¿Estás seguro de que quieres ${action} este tipo de empresa?`)) {
      executeToggleCompanyType(id, newStatus);
    }
    return;
  }
  
  // Configurar contenido del modal
  if (newStatus) {
    icon.className = 'toggle-modal-icon activate mx-auto mb-4';
    if (iconFa) iconFa.className = 'fas fa-play-circle text-4xl';
    title.textContent = 'Activar Tipo de Empresa';
    message.textContent = `¿Estás seguro de que quieres activar el tipo "${typeName}"?`;
    confirmText.textContent = 'Activar';
    if (confirmIcon) confirmIcon.className = 'fas fa-play mr-2';
  } else {
    icon.className = 'toggle-modal-icon deactivate mx-auto mb-4';
    if (iconFa) iconFa.className = 'fas fa-pause-circle text-4xl';
    title.textContent = 'Desactivar Tipo de Empresa';
    message.textContent = `¿Estás seguro de que quieres desactivar el tipo "${typeName}"?`;
    confirmText.textContent = 'Desactivar';
    if (confirmIcon) confirmIcon.className = 'fas fa-pause mr-2';
  }
  
  // Show modal using modalManager (consistent with other modals) - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.openModal('toggleCompanyTypeModal');
  } else {
    // Fallback - EXACT HARDWARE STYLE
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.body.classList.add('modal-open');
  }
  
  console.log('✅ Toggle modal should now be visible');
  
  // Simple animation
  if (typeof gsap !== 'undefined') {
    gsap.set(container, { scale: 0.8, opacity: 0 });
    gsap.to(container, {
      scale: 1,
      opacity: 1,
      duration: 0.3,
      ease: "power2.out"
    });
  } else {
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }
}

// Cerrar modal de toggle - EXACTO DE HARDWARE
function closeToggleModal() {
  console.log('🔄 Closing toggle modal');
  
  const modal = document.getElementById('toggleCompanyTypeModal');
  const container = document.getElementById('toggleModalContainer');
  const buttons = document.querySelector('.flex.gap-4'); // Cambio el selector
  const confirmBtn = document.getElementById('toggleConfirmBtn');
  
  if (!modal) {
    console.error('❌ Modal not found when trying to close');
    return;
  }
  
  // Simple close without complex animation for debugging
  if (typeof gsap !== 'undefined' && container) {
    gsap.to(container, {
      scale: 0.8,
      opacity: 0,
      duration: 0.2,
      ease: "power2.in",
      onComplete: () => {
        resetAndHideModal();
      }
    });
  } else {
    resetAndHideModal();
  }
  
  function resetAndHideModal() {
    // Use modalManager for consistent closing - EXACT HARDWARE STYLE
    if (window.modalManager) {
      window.modalManager.closeModal('toggleCompanyTypeModal');
    } else {
      // Fallback - EXACT HARDWARE STYLE
      modal.classList.add('hidden');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      document.body.classList.remove('modal-open');
    }
    
    // Reset modal state completely
    if (buttons) {
      buttons.style.display = 'flex';
      buttons.style.opacity = '1';
      buttons.style.transform = 'none';
    }
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-check" id="toggleConfirmIcon"></i> <span id="toggleConfirmText">Confirmar</span>';
    }
    
    // Reset icon and text
    const icon = document.getElementById('toggleModalIcon');
    const iconFa = document.getElementById('toggleModalIconFa');
    const title = document.getElementById('toggleModalTitle');
    const message = document.getElementById('toggleModalMessage');
    
    if (icon) {
      icon.style.transform = 'none';
      icon.style.scale = '1';
    }
    if (title) title.textContent = 'Confirmar Acción';
    if (message) message.textContent = '¿Estás seguro de que quieres continuar?';
    
    // Reset data
    toggleModalData.typeId = null;
    toggleModalData.newStatus = null;
    
    console.log('✅ Toggle modal closed and fully reset');
  }
}

// Confirmar toggle - ADAPTADO DE HARDWARE
function confirmToggleCompanyType() {
  if (toggleModalData.typeId && toggleModalData.newStatus !== null) {
    // Show loading state
    const confirmBtn = document.getElementById('toggleConfirmBtn');
    const originalContent = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    confirmBtn.disabled = true;
    
    // Call the API function
    executeToggleCompanyType(toggleModalData.typeId, toggleModalData.newStatus)
      .then(() => {
        // Show success feedback before closing
        showToggleSuccess(toggleModalData.newStatus);
      })
      .catch((error) => {
        // Restore button on error
        confirmBtn.innerHTML = originalContent;
        confirmBtn.disabled = false;
        console.error('Error in toggle operation:', error);
        showEnhancedNotification(error.message, 'error');
      });
  }
}

// Ejecutar toggle - ADAPTADO PARA COMPANY TYPES
async function executeToggleCompanyType(id, newStatus) {
  try {
    console.log('📞 Executing toggle for type:', id, 'to status:', newStatus);
    
    const response = await callAPI('PATCH', `/api/tipos_empresa/${id}/toggle-status`);
    console.log('✅ Toggle response:', response);
    
    // Animar cambio de estado usando HardwareAnimations
    const card = document.querySelector(`[data-type-id="${id}"]`);
    if (card && window.HardwareAnimations) {
      window.HardwareAnimations.animateStatusChange ? 
        window.HardwareAnimations.animateStatusChange(card) :
        console.log('🎨 Status change animation not available');
    }
    
    return response;
  } catch (error) {
    console.error('💥 Error executing toggle:', error);
    throw error;
  }
}

// Show toggle success feedback - EXACTO DE HARDWARE
function showToggleSuccess(activated) {
  console.log('✅ Showing toggle success for:', activated ? 'activate' : 'deactivate');
  
  const container = document.getElementById('toggleModalContainer');
  const icon = document.getElementById('toggleModalIcon');
  const iconFa = document.getElementById('toggleModalIconFa');
  const title = document.getElementById('toggleModalTitle');
  const message = document.getElementById('toggleModalMessage');
  const buttons = document.querySelector('.flex.gap-4');
  
  if (!icon || !title || !message || !buttons) {
    console.error('❌ Toggle success elements missing!');
    closeToggleModal();
    return;
  }
  
  // Update content to show success
  if (activated) {
    icon.className = 'toggle-modal-icon activate';
    if (iconFa) iconFa.className = 'fas fa-check-circle';
    title.textContent = '¡Tipo Activado!';
    message.textContent = 'El tipo de empresa se ha activado exitosamente.';
  } else {
    icon.className = 'toggle-modal-icon deactivate';
    if (iconFa) iconFa.className = 'fas fa-times-circle';
    title.textContent = '¡Tipo Desactivado!';
    message.textContent = 'El tipo de empresa se ha desactivado exitosamente.';
  }
  
  // Hide buttons temporarily
  if (typeof gsap !== 'undefined') {
    gsap.to(buttons, {
      opacity: 0,
      duration: 0.3,
      onComplete: () => {
        buttons.style.display = 'none';
      }
    });
    
    // Animate success state
    gsap.to(icon, {
      scale: 1.2,
      duration: 0.3,
      ease: "back.out(1.7)"
    });
  } else {
    buttons.style.display = 'none';
  }
  
  // Auto-close after 2 seconds
  setTimeout(() => {
    closeToggleModal();
    // Instead of reloading, just update the card status visually
    setTimeout(() => {
      updateCardStatusVisually(toggleModalData.typeId, activated);
    }, 500);
  }, 2000);
}

// Update card status visually without page reload
function updateCardStatusVisually(typeId, activated) {
  const card = document.querySelector(`[data-type-id="${typeId}"]`);
  if (!card) {
    console.warn('Card not found for visual update');
    return;
  }
  
  // Update status badge
  const statusBadge = card.querySelector('.ios-status-badge');
  if (statusBadge) {
    if (activated) {
      statusBadge.className = 'ios-status-badge ios-status-available text-xs font-semibold';
      statusBadge.textContent = '✅ Activo';
    } else {
      statusBadge.className = 'ios-status-badge ios-status-discontinued text-xs font-semibold';
      statusBadge.textContent = '⚫ Inactivo';
    }
  }
  
  // Update toggle button
  const toggleButton = card.querySelector('button[onclick*="toggleStatus"]');
  if (toggleButton) {
    if (activated) {
      toggleButton.className = 'ios-card-btn ios-card-btn-warning';
      toggleButton.title = 'Desactivar tipo';
      toggleButton.innerHTML = '<i class="fas fa-power-off"></i>';
    } else {
      toggleButton.className = 'ios-card-btn ios-card-btn-success';
      toggleButton.title = 'Activar tipo';
      toggleButton.innerHTML = '<i class="fas fa-play"></i>';
    }
    
    // Update onclick to reflect new status
    const newStatus = !activated; // Next click will be the opposite
    toggleButton.setAttribute('onclick', `toggleStatus('${typeId}', ${activated})`);
  }
  
  // Update data attribute
  card.setAttribute('data-status', activated ? 'true' : 'false');
  
  console.log(`✅ Card status updated visually: ${activated ? 'active' : 'inactive'}`);
}

// Función para llamar desde toggleStatus - ADAPTADA
async function toggleStatus(id, currentStatus) {
  console.log('🎯 toggleStatus called with:', { id, currentStatus });
  
  // Obtener el nombre del tipo para mostrar en el modal
  const card = document.querySelector(`[data-type-id="${id}"]`);
  console.log('🔍 Card found:', card);
  
  const typeName = card ? card.querySelector('.ios-card-title').textContent : 'este tipo de empresa';
  console.log('📋 Type name found:', typeName);
  
  openToggleCompanyTypeModal(id, currentStatus, typeName);
}

// ===== MODAL DE ACTUALIZACIÓN - EXACTO DE HARDWARE =====

// Client Update Modal Functions - COPIADO EXACTO DE HARDWARE
function showClientUpdateModal(message = 'El tipo de empresa se ha actualizado exitosamente.') {
  console.log('🔄 Showing client update modal:', message);
  
  const modal = document.getElementById('clientUpdateModal');
  const container = document.getElementById('updateModalContainer');
  const icon = document.getElementById('updateModalIcon');
  const iconFa = document.getElementById('updateModalIconFa');
  const title = document.getElementById('updateModalTitle');
  const messageEl = document.getElementById('updateModalMessage');
  
  if (!modal || !container || !title || !messageEl) {
    console.error('❌ Client update modal elements missing!');
    return;
  }
  
  // Set success styling with separate classes
  if (icon) icon.className = 'client-update-icon';
  if (iconFa) iconFa.className = 'fas fa-check-circle';
  
  // Set dynamic title based on message
  if (message.includes('creado')) {
    title.textContent = '¡Tipo Creado!';
  } else if (message.includes('actualizado')) {
    title.textContent = '¡Tipo Actualizado!';
  } else {
    title.textContent = '¡Operación Exitosa!';
  }
  
  messageEl.textContent = message;
  
  // Show modal using modalManager (consistent with other modals) - EXACT HARDWARE STYLE
  if (window.modalManager) {
    window.modalManager.openModal('clientUpdateModal');
  } else {
    // Fallback - EXACT HARDWARE STYLE
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.body.classList.add('modal-open');
  }
  
  console.log('✅ Client update modal should now be visible');
  
  // Simple animation
  if (typeof gsap !== 'undefined') {
    gsap.set(container, { scale: 0.8, opacity: 0 });
    gsap.to(container, {
      scale: 1,
      opacity: 1,
      duration: 0.4,
      ease: "back.out(1.7)"
    });
    
    if (icon) {
      gsap.to(icon, {
        scale: 1.1,
        duration: 0.6,
        repeat: 1,
        yoyo: true,
        ease: "power2.inOut"
      });
    }
  } else {
    container.style.transform = 'scale(1)';
    container.style.opacity = '1';
  }
  
  // NO auto-close - wait for user interaction
  console.log('⏰ Modal will stay open until user clicks Aceptar or clicks outside');
}

// Close update modal - COPIADO EXACTO DE HARDWARE
function closeUpdateModal() {
  console.log('🔄 Closing client update modal');
  
  const modal = document.getElementById('clientUpdateModal');
  const container = document.getElementById('updateModalContainer');
  
  if (!modal) {
    console.error('❌ Client update modal not found when trying to close');
    return;
  }
  
  // Simple close animation
  if (typeof gsap !== 'undefined' && container) {
    gsap.to(container, {
      scale: 0.8,
      opacity: 0,
      duration: 0.3,
      ease: "power2.in",
      onComplete: () => {
        resetAndHideUpdateModal();
      }
    });
  } else {
    resetAndHideUpdateModal();
  }
  
  function resetAndHideUpdateModal() {
    // Use modalManager for consistent closing - EXACT HARDWARE STYLE
    if (window.modalManager) {
      window.modalManager.closeModal('clientUpdateModal');
    } else {
      // Fallback - EXACT HARDWARE STYLE
      modal.classList.add('hidden');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      document.body.classList.remove('modal-open');
    }
    
    console.log('✅ Update modal closed and reset');
  }
}

// Función exportTypes simplificada - USANDO MODAL DE HARDWARE
function exportTypes() {
  // Usar el mismo modal de success de hardware adaptado
  showClientUpdateModal('Los tipos de empresa se están exportando. El archivo CSV se descargará automáticamente.');
}

// Variable global para trackear el estado actual - POR DEFECTO SOLO ACTIVOS
let currentShowingInactive = false; // Siempre empezar mostrando solo activos

// Función para sincronizar estado del botón con variable global
function syncButtonState() {
  const button = document.querySelector('button[onclick="toggleIncludeInactive()"]');
  if (!button) return;
  
  const buttonIcon = button.querySelector('i');
  const buttonText = button.querySelector('span');
  
  if (currentShowingInactive) {
    // Mostrando todos - botón debe decir "Solo Activos"
    button.classList.remove('ios-action-btn-secondary');
    button.classList.add('ios-action-btn-warning');
    if (buttonIcon) buttonIcon.className = 'fas fa-eye-slash';
    if (buttonText) buttonText.textContent = 'Solo Activos';
  } else {
    // Mostrando solo activos - botón debe decir "Ver Todos"
    button.classList.remove('ios-action-btn-warning');
    button.classList.add('ios-action-btn-secondary');
    if (buttonIcon) buttonIcon.className = 'fas fa-eye';
    if (buttonText) buttonText.textContent = 'Ver Todos';
  }
  
  console.log(`🔄 Button state synced. Showing inactive: ${currentShowingInactive}`);
}

// FIXED: Toggle by reloading page with correct parameter
function toggleIncludeInactive() {
  // Determinar el nuevo estado
  const newShowInactive = !currentShowingInactive;
  
  console.log(`🔄 Toggle: Currently showing inactive: ${currentShowingInactive}, New: ${newShowInactive}`);
  
  // Mostrar estado de carga en el botón
  const button = document.querySelector('button[onclick="toggleIncludeInactive()"]');
  if (button) {
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="text-sm font-medium">Cargando...</span>';
    button.disabled = true;
  }
  
  // Construir URL con el parámetro correcto
  const currentUrl = new URL(window.location);
  if (newShowInactive) {
    currentUrl.searchParams.set('include_inactive', 'true');
    console.log('🔄 Reloading to show ALL types (active + inactive)');
  } else {
    currentUrl.searchParams.delete('include_inactive');
    console.log('🔄 Reloading to show ONLY active types');
  }
  
  // Recargar la página para que Jinja2 renderice correctamente
  window.location.href = currentUrl.toString();
}

// SIMPLE: Filter types by checking 'activo' field - no complex logic needed!
function filterTypesByActiveStatus(showInactive) {
  console.log(`🎯 Simple filter: showInactive=${showInactive}`);
  
  const typeCards = document.querySelectorAll('.company-type-item');
  let visibleCount = 0;
  
  typeCards.forEach(card => {
    // Get the active status directly from the data attribute
    const isActive = card.dataset.status === 'true';
    
    // Simple logic: show if active OR if we want to show inactive too
    if (isActive || showInactive) {
      card.style.display = '';
      card.classList.remove('hidden');
      visibleCount++;
    } else {
      card.style.display = 'none';
      card.classList.add('hidden');
    }
  });
  
  // Update header badge to show current filter
  updateHeaderBadge(showInactive, visibleCount);
  
  console.log(`✨ Filter applied: ${visibleCount} types visible`);
}

// Simple header badge update - HARDWARE STYLE
function updateHeaderBadge(showInactive, visibleCount) {
  const headerSubtitle = document.querySelector('.ios-header-subtitle');
  if (headerSubtitle) {
    const badgeSpan = headerSubtitle.querySelector('span');
    if (badgeSpan) {
      if (showInactive) {
        badgeSpan.className = 'inline-block ml-2 px-2 py-1 bg-orange-500 text-white text-xs rounded-full';
        badgeSpan.textContent = `Mostrando todos (${visibleCount} tipos)`;
      } else {
        badgeSpan.className = 'inline-block ml-2 px-2 py-1 bg-green-500 text-white text-xs rounded-full';
        badgeSpan.textContent = `Solo activos (${visibleCount} tipos)`;
      }
    }
  }
}

// Function to view companies of a specific type
function viewCompaniesOfType(typeId, typeName) {
  console.log(`📋 Viendo empresas del tipo: ${typeName} (${typeId})`);
  
  // Navigate to empresas page with filter by type
  const empresasUrl = new URL('/admin/empresas', window.location.origin);
  empresasUrl.searchParams.set('tipo_empresa_id', typeId);
  empresasUrl.searchParams.set('tipo_empresa_nombre', typeName);
  
  // Show loading state
  const button = event.target.closest('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Cargando...</span>';
  button.disabled = true;
  
  // Navigate to empresas with filter
  window.location.href = empresasUrl.toString();
}

// Features management
function addFeature() {
  const input = document.getElementById('featureInput');
  const feature = input.value.trim();
  
  if (feature && !currentFeatures.includes(feature)) {
    if (currentFeatures.length >= 20) {
      showEnhancedNotification('No se pueden agregar más de 20 características', 'error');
      return;
    }
    if (feature.length > 100) {
      showEnhancedNotification('La característica no puede exceder 100 caracteres', 'error');
      return;
    }
    currentFeatures.push(feature);
    input.value = '';
    updateFeaturesList();
  } else if (currentFeatures.includes(feature)) {
    showEnhancedNotification('Esta característica ya existe', 'error');
  }
}

function removeFeature(index) {
  currentFeatures.splice(index, 1);
  updateFeaturesList();
}

function updateFeaturesList() {
  const container = document.getElementById('featuresList');
  container.innerHTML = currentFeatures.map((feature, index) => `
    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${feature}</span>
      <button type="button" class="text-red-500 hover:text-red-700 ml-2" onclick="removeFeature(${index})">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
  
  // Add appear animation to new features
  const newFeatures = container.querySelectorAll('div');
  newFeatures.forEach((item, index) => {
    if (window.CompanyTypesAnimations) {
      window.CompanyTypesAnimations.animateFeatureTag(item);
    }
  });
}

function handleFeatureKeyPress(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    addFeature();
  }
}

// Color input synchronization - COMMENTED OUT (elements don't exist)
// document.getElementById('typeColor').addEventListener('change', function() {
//   document.getElementById('typeColorHex').value = this.value;
// });

// document.getElementById('typeColorHex').addEventListener('input', function() {
//   if (/^#[0-9A-F]{6}$/i.test(this.value)) {
//     document.getElementById('typeColor').value = this.value;
//   }
// });

// API Helper functions
async function callAPI(method, endpoint, data = null) {
  const options = {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include'  // Incluir cookies de sesión para autenticación
  };
  
  if (data) {
    options.body = JSON.stringify(data);
  }
  
  try {
    console.log(`🔄 API Call: ${method} ${endpoint}`);
    const response = await fetch(`/proxy${endpoint}`, options);
    const result = await response.json();
    
    console.log(`📡 API Response: ${response.status}`, result);
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('No autorizado. Por favor, inicia sesión nuevamente.');
      }
      throw new Error(result.errors ? result.errors.join(', ') : result.message || 'Error en la operación');
    }
    
    return result;
  } catch (error) {
    console.error('💥 Error en API:', error);
    throw error;
  }
}


// Enhanced notification system like hardware
function showEnhancedNotification(message, type = 'info') {
  // Remove existing notifications
  const existingNotifications = document.querySelectorAll('.enhanced-notification');
  existingNotifications.forEach(notification => notification.remove());
  
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `enhanced-notification fixed top-4 right-4 max-w-sm w-full`;
  notification.style.zIndex = '999999'; // Muy alto para estar siempre adelante
  
  let iconClass, bgClass, borderClass;
  if (type === 'error') {
    iconClass = 'fas fa-exclamation-circle';
    bgClass = 'bg-red-500';
    borderClass = 'border-red-600';
  } else {
    iconClass = 'fas fa-check-circle';
    bgClass = 'bg-green-500';
    borderClass = 'border-green-600';
  }
  
  notification.innerHTML = `
    <div class="${bgClass} ${borderClass} border-l-4 text-white p-4 rounded-lg shadow-xl backdrop-blur-sm">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <i class="${iconClass} text-xl"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium">${message}</p>
        </div>
        <div class="ml-auto pl-3">
          <button onclick="closeNotification(this)" class="text-white hover:text-gray-200 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Add to document
  document.body.appendChild(notification);
  
  // GSAP animations if available
  if (typeof gsap !== 'undefined') {
    gsap.set(notification, { x: 400, opacity: 0 });
    
    const tl = gsap.timeline();
    tl.to(notification, {
      x: 0,
      opacity: 1,
      duration: 0.5,
      ease: "back.out(1.7)"
    })
    .to(notification, {
      scale: 1.05,
      duration: 0.1,
      yoyo: true,
      repeat: 1,
      ease: "power2.inOut"
    }, "-=0.2");
  }
  
  // Auto-remove after 4 seconds
  setTimeout(() => {
    closeNotification(notification.querySelector('button'));
  }, 4000);
}

// Close notification with animation
function closeNotification(button) {
  const notification = button.closest('.enhanced-notification');
  if (notification) {
    if (typeof gsap !== 'undefined') {
      gsap.to(notification, {
        x: 400,
        opacity: 0,
        duration: 0.3,
        ease: "back.in(1.7)",
        onComplete: () => notification.remove()
      });
    } else {
      notification.remove();
    }
  }
}

// Legacy function for compatibility
function showNotification(message, type = 'info') {
  showEnhancedNotification(message, type);
}

// Form submission with real API calls - FIXED
document.getElementById('companyTypeForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  console.log('🚀 Form submission started');
  
  // Validation
  const typeName = document.getElementById('typeName');
  const typeDescription = document.getElementById('typeDescription');
  const typeStatus = document.getElementById('typeStatus');
  const submitBtn = document.querySelector('#submitButtonText');
  
  if (!typeName || !typeDescription || !typeStatus || !submitBtn) {
    console.error('❌ Form elements missing:', {
      typeName: !!typeName,
      typeDescription: !!typeDescription,
      typeStatus: !!typeStatus,
      submitBtn: !!submitBtn
    });
    showEnhancedNotification('Error: Elementos del formulario no encontrados', 'error');
    return;
  }
  
  if (!typeName.value.trim() || !typeDescription.value.trim()) {
    showEnhancedNotification('Por favor completa todos los campos obligatorios', 'error');
    return;
  }
  
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Guardando...';
  
  const formData = {
    nombre: typeName.value.trim(),
    descripcion: typeDescription.value.trim(),
    caracteristicas: currentFeatures || [],
    activo: typeStatus.value === 'true'
  };
  
  console.log('📤 Sending data:', formData);
  
  try {
    let result;
    if (editingCompanyType) {
      // Update existing type
      console.log('🔄 Updating existing type:', editingCompanyType);
      result = await callAPI('PUT', `/api/tipos_empresa/${editingCompanyType}`, formData);
      showClientUpdateModal('El tipo de empresa se ha actualizado exitosamente.');
    } else {
      // Create new type
      console.log('✨ Creating new type');
      result = await callAPI('POST', '/api/tipos_empresa', formData);
      showClientUpdateModal('El nuevo tipo de empresa se ha creado exitosamente.');
    }
    
    console.log('✅ Operation successful:', result);
    closeModal();
    
    // Reload page to show changes
    setTimeout(() => {
      location.reload();
    }, 1500);
    
  } catch (error) {
    console.error('💥 Form submission error:', error);
    showEnhancedNotification(error.message, 'error');
    submitBtn.textContent = originalText;
  }
});

// Close modals when clicking outside
document.getElementById('companyTypeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

document.getElementById('detailsModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDetailsModal();
  }
});

// Event listeners para modales iOS - ADAPTADOS DE HARDWARE
document.getElementById('toggleCompanyTypeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeToggleModal();
  }
});

document.getElementById('clientUpdateModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeUpdateModal();
  }
});

// Close modal with Escape key - ADAPTADO DE HARDWARE
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Check which modal is open and close it
    const companyTypeModal = document.getElementById('companyTypeModal');
    const detailsModal = document.getElementById('detailsModal');
    const toggleCompanyTypeModal = document.getElementById('toggleCompanyTypeModal');
    const clientUpdateModal = document.getElementById('clientUpdateModal');
    
    if (!companyTypeModal.classList.contains('hidden')) {
      closeModal();
    } else if (!detailsModal.classList.contains('hidden')) {
      closeDetailsModal();
    } else if (!toggleCompanyTypeModal.classList.contains('hidden')) {
      closeToggleModal();
    } else if (!clientUpdateModal.classList.contains('hidden')) {
      closeUpdateModal();
    }
  }
});

</script>
{% endblock %}
